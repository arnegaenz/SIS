<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Strivve • Merchant Site Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/sis-shared.css" />
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #12161c;
      --ink: #e7edf6;
      --muted: #9aa8b6;
      --grid-border: #1b2430;
      --chip: #1b2230;
      --chip-on: #25314a;
      --chip-ring: #3a4b70;
      --accent: #7aa2ff;
      --accent-2: #b48bff;
      --warn: #ffb86c;
      --bad: #ff6b6b;
      --good: #3bd671;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 16px 16px 60px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
      --sis-panel-bg: var(--panel);
    }
    h1 { font-size: 18px; font-weight: 700; margin: 0 0 14px; letter-spacing: .2px; }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: flex-end;
    }
    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 170px;
    }
    .filter-field label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 0;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .filter-field input[type="date"] {
      background: #0f1319;
      border: 1px solid rgba(148,163,184,0.35);
      color: var(--ink);
      padding: 9px 12px;
      border-radius: 10px;
      font-size: 14px;
    }
    .filter-field input[type="date"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(122,162,255,0.25);
    }
    .filter-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      border: none;
      border-radius: 999px;
      color: #020617;
      padding: 10px 22px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .filter-btn:hover { filter: brightness(1.08); }
    .filter-toggle label.toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--ink);
      text-transform: none;
    }
    .filter-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    label { font-size: 13px; color: var(--muted); }
    input[type="date"] {
      background: #0f1319;
      border: 1px solid var(--grid-border);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
    }
    button, .chip {
      appearance: none;
      border: 1px solid var(--grid-border);
      background: var(--chip);
      color: var(--ink);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
    }
    button:hover, .chip:hover { filter: brightness(1.1); }
    .chip.on {
      background: var(--chip-on);
      outline: 2px solid var(--chip-ring);
    }

    .legend { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
    .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid var(--grid-border); }

    .grid {
      display: grid;
      grid-template-columns: 260px 1fr;
      margin-top: 14px;
      min-height: 300px;
      max-height: 70vh;
      overflow: auto;
    }
    .grid-head {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 10px; /* day width */
      border-bottom: 1px solid var(--grid-border);
      position: sticky;
      top: 0;
      background: var(--panel);
      z-index: 1;
    }
    .grid-head .tick {
      width: 10px;
      height: 16px;
      border-right: 1px solid rgba(255,255,255,0.04);
    }
    .grid-left {
      border-right: 1px solid var(--grid-border);
      padding-top: 16px; /* align with header height */
      background: var(--panel);
      position: sticky;
      left: 0;
      z-index: 2;
    }
    .site-row {
      display: flex;
      align-items: center;
      height: 12px; /* matches square size */
      padding: 0 10px;
      gap: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
      line-height: 12px;
      color: var(--muted);
    }
    .grid-right { position: relative; }
    .day-row {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 12px; /* square size */
    }
    .px0 { padding-left: 0; padding-right: 0; }
    .square {
      width: 12px;
      height: 12px;
      border-right: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .square:hover { outline: 1px solid rgba(255,255,255,0.25); outline-offset: -1px; }

    .toolbar { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .right { display: flex; gap: 8px; align-items: center; }

    .tip {
      position: fixed;
      pointer-events: none;
      z-index: 20;
      background: #0f1319;
      color: var(--ink);
      border: 1px solid var(--grid-border);
      border-radius: 8px;
      font-size: 12px;
      padding: 10px 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.45);
      display: block;
      max-width: 320px;
      line-height: 1.25;
    }
    .tip[hidden] { display: none; }
    .heatmap-tooltip .tt-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .heatmap-tooltip .tt-mode {
      font-size: 12px;
      margin-bottom: 2px;
    }
    .heatmap-tooltip .tt-anomaly {
      font-size: 12px;
      opacity: 0.8;
    }
    .muted { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .tiny { font-size: 11px; }
  </style>
</head>
<body>
  <header class="sis-header">
    <div class="sis-header__inner">
      <div class="sis-brand">Strivve Insights Service (SIS)</div>
      <nav class="sis-nav">
        <a class="sis-nav__item" href="/">Overview</a>
        <a class="sis-nav__item" href="/funnel.html">FI Funnel</a>
        <a class="sis-nav__item sis-nav__item--active" href="/heatmap.html">Merchant Heatmap</a>
        <a class="sis-nav__item" href="/maintenance.html">Maintenance</a>
      </nav>
    </div>
  </header>
  <main class="sis-main">
    <section class="sis-panel heatmap-panel">
      <h1 class="sis-panel-title">Merchant Site Heatmap</h1>

      <div class="toolbar">
        <div class="filter-row">
          <div class="filter-field">
            <label for="start">Start date</label>
            <input id="start" type="date">
          </div>
          <div class="filter-field">
            <label for="end">End date</label>
            <input id="end" type="date">
          </div>
          <div class="filter-field">
            <label>&nbsp;</label>
            <div class="filter-actions">
              <button id="apply" class="filter-btn" type="button">Apply filters</button>
              <span class="muted tiny mono" id="count"></span>
            </div>
          </div>
          <div class="filter-field filter-toggle">
            <label>Traffic sources</label>
            <label class="toggle">
              <input type="checkbox" id="includeProdMerchants" checked />
              Include production traffic
            </label>
            <label class="toggle">
              <input type="checkbox" id="includeTestMerchants" />
              Include traffic from test (customer-dev) FIs
            </label>
          </div>
        </div>
        <div class="right">
          <span class="muted tiny">Mode:</span>
          <button class="chip on" data-mode="traffic" id="m-traffic">Traffic</button>
          <button class="chip" data-mode="health" id="m-health">Health</button>
          <button class="chip" data-mode="conversion" id="m-conv">Conversion</button>
          <button class="chip" data-mode="anomaly" id="m-anom">Anomaly</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="legend" id="legend"></div>
      </div>

      <div class="grid" id="grid" aria-busy="true">
        <div class="grid-left" id="leftCol"></div>
        <div class="grid-right">
          <div class="grid-head" id="headTicks"></div>
          <div id="rows"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="tip heatmap-tooltip" id="tip" hidden></div>

  <script>
    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const fmtPct = (num) => (Number.isFinite(num) ? (num * 100).toFixed(1) + "%" : "—");
    const formatPercentValue = (value) => {
      if (!Number.isFinite(value)) return null;
      const str = value.toFixed(1).replace(/\.0$/, "");
      return `${str}%`;
    };
    function escapeHtml(value) {
      return (value ?? "")
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    const urlParams = new URLSearchParams(location.search);
    function isoToday() { return new Date().toISOString().slice(0,10); }
    function isoDaysAgo(n) {
      const d = new Date(); d.setUTCDate(d.getUTCDate() - n);
      return d.toISOString().slice(0,10);
    }
    function enumerate(start, end) {
      const out = [];
      let c = new Date(start + "T00:00:00Z").getTime();
      const e = new Date(end + "T00:00:00Z").getTime();
      const day = 86400000;
      while (c <= e) { out.push(new Date(c).toISOString().slice(0,10)); c += day; }
      return out;
    }

    // Color scales
    function lerp(a,b,t){ return a + (b-a)*t; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    // Green scale for positive intensity (traffic/conversion)
    function greenScale(t){
      t = clamp01(t);
      const r = Math.round(lerp(18, 59, t));
      const g = Math.round(lerp(65, 214, t));
      const b = Math.round(lerp(40, 113, t));
      return `rgb(${r},${g},${b})`;
    }
    // Red scale for failure rate (health)
    function redScale(t){
      t = clamp01(t);
      const r = Math.round(lerp(60, 255, t));
      const g = Math.round(lerp(30, 107, t));
      const b = Math.round(lerp(30, 107, t));
      return `rgb(${r},${g},${b})`;
    }
    // Purple scale for anomaly intensity
    function purpleScale(t){
      t = clamp01(t);
      const r = Math.round(lerp(60, 180, t));
      const g = Math.round(lerp(50, 110, t));
      const b = Math.round(lerp(90, 255, t));
      return `rgb(${r},${g},${b})`;
    }
    const veryLight = "rgba(255,255,255,0.04)";

    function normalizeMerchantStats(stats, daysOrder) {
      const safe = stats && typeof stats === "object" ? stats : {};
      const total = Number(safe.total || 0);
      const billable = Number(safe.billable || 0);
      const siteFailures = Number(
        safe.siteFailures ?? safe.siteFail ?? 0
      );
      const userFlowIssues = Number(safe.userFlowIssues || 0);
      const overall =
        typeof safe.overallHealthPct === "number"
          ? safe.overallHealthPct
          : null;
      const baseDays = Array.isArray(safe.days)
        ? safe.days
        : (daysOrder || []).map((day) => ({ day }));
      const days = baseDays.map((cell) => {
        const day = cell.day;
        const bill = Number(cell.billable || 0);
        const sf = Number((cell.siteFail ?? cell.siteFailures) || 0);
        const ux = Number(cell.userFlowIssues || 0);
        const tot = Number(cell.total || 0);
        const denom = bill + sf;
        const pct =
          denom > 0 ? Number(((bill / denom) * 100).toFixed(1)) : null;
        return {
          day,
          billable: bill,
          siteFail: sf,
          siteFailures: sf,
          userFlowIssues: ux,
          total: tot,
          pct,
        };
      });
      return {
        total,
        billable,
        siteFailures,
        userFlowIssues,
        overallHealthPct: overall,
        days,
      };
    }

    function mergeDayStats(daysOrder, primaryDays, secondaryDays) {
      const map = new Map();
      const add = (cell) => {
        if (!cell || !cell.day) return;
        const key = cell.day;
        if (!map.has(key)) {
          map.set(key, {
            day: key,
            billable: 0,
            siteFail: 0,
            siteFailures: 0,
            userFlowIssues: 0,
            total: 0,
          });
        }
        const bucket = map.get(key);
        bucket.billable += Number(cell.billable || 0);
        const sf = Number((cell.siteFail ?? cell.siteFailures) || 0);
        bucket.siteFail += sf;
        bucket.siteFailures = bucket.siteFail;
        bucket.userFlowIssues += Number(cell.userFlowIssues || 0);
        bucket.total += Number(cell.total || 0);
      };
      (primaryDays || []).forEach(add);
      (secondaryDays || []).forEach(add);
      return (daysOrder || []).map((day) => {
        const base =
          map.get(day) || {
            day,
            billable: 0,
            siteFail: 0,
            siteFailures: 0,
            userFlowIssues: 0,
            total: 0,
          };
        const denom = base.billable + base.siteFail;
        const pct =
          denom > 0 ? Number(((base.billable / denom) * 100).toFixed(1)) : null;
        return { ...base, siteFailures: base.siteFail, pct };
      });
    }

    function mergeMerchantStats(prodStats, testStats, daysOrder) {
      const billable = prodStats.billable + testStats.billable;
      const siteFailures = prodStats.siteFailures + testStats.siteFailures;
      const total = prodStats.total + testStats.total;
      const userFlowIssues =
        prodStats.userFlowIssues + testStats.userFlowIssues;
      const denom = billable + siteFailures;
      const overall =
        denom > 0 ? Number(((billable / denom) * 100).toFixed(1)) : null;
      const days = mergeDayStats(daysOrder, prodStats.days, testStats.days);
      return {
        total,
        billable,
        siteFailures,
        userFlowIssues,
        overallHealthPct: overall,
        days,
      };
    }

function transformMerchantRow(row, options, daysOrder) {
  const includeProd = options?.includeProd ?? true;
  const includeTests = options?.includeTest ?? false;
  const prodFallback = {
    total: row.prod_traffic ?? row.total ?? 0,
    billable: row.billable ?? 0,
        siteFailures: row.siteFailures ?? row.siteFail ?? 0,
        userFlowIssues: row.userFlowIssues ?? 0,
        days: row.days || [],
        overallHealthPct: row.overallHealthPct ?? null,
      };
      const prodStats = normalizeMerchantStats(
        row.prod_stats || prodFallback,
        daysOrder
      );
      const testStats = normalizeMerchantStats(
        row.test_stats || {
          total: row.test_traffic ?? 0,
          billable: 0,
          siteFailures: 0,
          userFlowIssues: 0,
          days: row.test_days || [],
        },
        daysOrder
      );
  let mergedStats;
  if (includeProd && includeTests) {
    mergedStats = mergeMerchantStats(prodStats, testStats, daysOrder);
  } else if (includeTests && !includeProd) {
    mergedStats = testStats;
  } else {
    mergedStats = prodStats;
  }
  return {
    ...row,
    total: mergedStats.total,
        billable: mergedStats.billable,
        siteFailures: mergedStats.siteFailures,
        userFlowIssues: mergedStats.userFlowIssues,
        overallHealthPct: mergedStats.overallHealthPct,
        days: mergedStats.days,
        prod_traffic: prodStats.total,
        test_traffic: testStats.total,
        has_test_fi:
          row.has_test_fi ?? testStats.total > 0,
        has_prod_fi: prodStats.total > 0,
        prod_stats: prodStats,
        test_stats: testStats,
      };
    }

    // ===== State =====
    let MODE = "traffic"; // traffic | health | conversion | anomaly
    const startEl = $("#start");
    const endEl = $("#end");
    const applyBtn = $("#apply");
    const headTicks = $("#headTicks");
    const leftCol = $("#leftCol");
    const rowsWrap = $("#rows");
    const legendEl = $("#legend");
    const tip = $("#tip");
    const countEl = $("#count");
    const includeProdToggle = document.getElementById("includeProdMerchants");
    const includeTestToggle = document.getElementById("includeTestMerchants");
    let latestMerchantPayload = null;
    function rerenderIfLoaded() {
      if (latestMerchantPayload) {
        render(latestMerchantPayload);
      }
    }
    includeTestToggle?.addEventListener("change", rerenderIfLoaded);
    includeProdToggle?.addEventListener("change", rerenderIfLoaded);

    // initial dates: from query or default last 90 days
    const initStart = urlParams.get("start") || isoDaysAgo(89);
    const initEnd   = urlParams.get("end")   || isoToday();
    startEl.value = initStart;
    endEl.value = initEnd;

    // mode chips
    for (const el of document.querySelectorAll(".chip[data-mode]")) {
      el.addEventListener("click", () => {
        for (const b of document.querySelectorAll(".chip[data-mode]")) b.classList.remove("on");
        el.classList.add("on");
        MODE = el.dataset.mode;
        render(currentData);
      });
    }

    applyBtn.addEventListener("click", () => {
      const s = startEl.value;
      const e = endEl.value;
      const u = new URL(location.href);
      u.searchParams.set("start", s);
      u.searchParams.set("end", e);
      history.replaceState(null, "", u);
      loadAndRender(s, e);
    });

    // ===== Data shape expected from server =====
    // GET /data/merchant-heatmap?start=YYYY-MM-DD&end=YYYY-MM-DD
    // {
    //   start: "YYYY-MM-DD", end: "YYYY-MM-DD", days: ["..."],
    //   merchants: [
    //     {
    //       name: "amazon.com",
    //       total: 123, billable: 77, siteFailures: 21, userFlowIssues: 25,
    //       daily: { "2025-10-01": { total, billable, siteFailures, userFlowIssues }, ... }
    //     }, ...
    //   ]
    // }

    let currentData = null;

    async function loadAndRender(start, end) {
      $("#grid").setAttribute("aria-busy", "true");
      leftCol.innerHTML = "";
      rowsWrap.innerHTML = "";
      headTicks.innerHTML = "";
      legendEl.innerHTML = "";

      const res = await fetch(`/merchant-heatmap?start=${start}&end=${end}`);
      if (!res.ok) {
        rowsWrap.innerHTML = `<div style="padding:16px" class="muted">Failed to load data (${res.status}).</div>`;
        $("#grid").removeAttribute("aria-busy");
        return;
      }
      const json = await res.json();
      currentData = json;
      latestMerchantPayload = json;
      render(json);
      $("#grid").removeAttribute("aria-busy");
    }

    function render(json) {
      if (!json || !Array.isArray(json.days) || !Array.isArray(json.merchants)) {
        rowsWrap.innerHTML = `<div style="padding:16px" class="muted">No data.</div>`;
        return;
      }
      hideTooltip();
      const days = json.days;
      const includeProd = includeProdToggle?.checked !== false;
      const includeTests = includeTestToggle?.checked;
      const transformed = (json.merchants || []).map((m) =>
        transformMerchantRow(
          m,
          { includeProd, includeTest: includeTests },
          days
        )
      );
      const merchants = transformed.filter((row) => {
        const hasProd = includeProd && row.prod_traffic > 0;
        const hasTest = includeTests && row.test_traffic > 0;
        return hasProd || hasTest;
      });
      countEl.textContent = `${merchants.length} merchants • ${days.length} days`;

      // header ticks (visual rhythm)
      headTicks.innerHTML = "";
      for (let i = 0; i < days.length; i++) {
        const t = document.createElement("div");
        t.className = "tick";
        headTicks.appendChild(t);
      }

      // sort merchants by total traffic across window (desc)
      const sorted = [...merchants].sort((a,b) => (b.total||0) - (a.total||0));

      // build left labels
      leftCol.innerHTML = "";
      for (const m of sorted) {
        const name = m.merchant || m.name || "unknown";
        const successes = Number(m.billable || m.successes || 0);
        const attempts = Number(m.total || 0);
        const label =
          attempts > 0
            ? `${name} (${successes}/${attempts})`
            : name;
        const row = document.createElement("div");
        row.className = "site-row";
        row.title = label;
        row.textContent = label;
        leftCol.appendChild(row);
      }

      // Precompute per-merchant normalization for traffic (so the green scale pops fairly)
      const perMerchantMax = new Map();
      for (const m of sorted) {
        const name = m.merchant || m.name || "unknown";
        const dayMap = new Map((m.days || []).map((cell) => [cell.day, cell]));
        let maxT = 0;
        for (const d of days) {
          const cell = dayMap.get(d);
          if (cell && cell.total) maxT = Math.max(maxT, cell.total);
        }
        perMerchantMax.set(name, Math.max(1, maxT));
      }

      // Render rows
      rowsWrap.innerHTML = "";
      sorted.forEach((m, idx) => {
        const name = m.merchant || m.name || "unknown";
        const dayMap = new Map((m.days || []).map((cell) => [cell.day, cell]));
        const row = document.createElement("div");
        row.className = "day-row";
        row.setAttribute("role", "row");
        days.forEach((d, dayIdx) => {
          const cell = dayMap.get(d) || {};
          const tot = Number(cell.total) || 0;
          const bill = Number(cell.billable) || 0;
          const sf = Number((cell.siteFail ?? cell.siteFailures) || 0);
          const ux = Number(cell.userFlowIssues) || 0;
          const denom = bill + sf;
          const failRate = denom > 0 ? sf / denom : null;
          const convRate = tot > 0 ? bill / tot : null;
          const anomalyInfo = computeAnomalyInfo(dayMap, days, dayIdx, {
            total: tot,
            billable: bill,
            siteFailures: sf,
            userFlowIssues: ux,
          });

          let color = veryLight;
          if (MODE === "traffic") {
            const maxT = perMerchantMax.get(name) || 1;
            const ratio = maxT ? tot / maxT : 0;
            color = tot > 0 ? greenScale(ratio) : veryLight;
          } else if (MODE === "health") {
            color = denom > 0 ? redScale(failRate ?? 0) : veryLight;
          } else if (MODE === "conversion") {
            color = convRate !== null ? greenScale(convRate) : veryLight;
          } else if (MODE === "anomaly") {
            const intensity = anomalyInfo.intensity || 0;
            color = intensity > 0 ? purpleScale(intensity) : veryLight;
          }

          const statsForTooltip = {
            ...cell,
            total: tot,
            billable: bill,
            siteFailures: sf,
            siteFail: sf,
            userFlowIssues: ux,
            anomalyInfo,
          };

          const sq = document.createElement("div");
          sq.className = "square";
          sq.style.background = color;
          sq.setAttribute("aria-label", `${name} • ${d}`);

          sq.addEventListener("mouseenter", (ev) => {
            showTooltip(ev, { merchant: name, date: d, stats: statsForTooltip, mode: MODE });
          });
          sq.addEventListener("mousemove", positionTooltip);
          sq.addEventListener("mouseleave", hideTooltip);

          row.appendChild(sq);
        });
        rowsWrap.appendChild(row);
      });

      // legend
      renderLegend(MODE);
    }

    function renderLegend(mode) {
      const L = legendEl;
      L.innerHTML = "";
      const make = (txt, color) => {
        const c = document.createElement("div"); c.className="legend";
        const s = document.createElement("div"); s.className="swatch"; s.style.background=color;
        const t = document.createElement("div"); t.textContent = txt;
        c.appendChild(s); c.appendChild(t); return c;
      };
      if (mode === "traffic") {
        L.appendChild(make("Higher traffic", greenScale(1)));
        L.appendChild(make("Lower traffic", greenScale(0.2)));
        L.appendChild(make("No data", veryLight));
      } else if (mode === "health") {
        L.appendChild(make("Worse site failure rate", redScale(1)));
        L.appendChild(make("Better (few failures)", redScale(0.15)));
        L.appendChild(make("No signal", veryLight));
      } else if (mode === "conversion") {
        L.appendChild(make("Higher conversion", greenScale(1)));
        L.appendChild(make("Lower conversion", greenScale(0.2)));
        L.appendChild(make("No signal", veryLight));
      } else {
        L.appendChild(make("Stronger anomaly", purpleScale(1)));
        L.appendChild(make("Mild anomaly", purpleScale(0.25)));
        L.appendChild(make("No anomaly", veryLight));
      }
    }

    function computeAnomalyInfo(dayMap, days, dayIdx, stats = {}) {
      const total = Number(stats.total) || 0;
      const billable = Number(stats.billable) || 0;
      const siteFailures = Number(stats.siteFailures) || 0;
      const userFlowIssues = Number(stats.userFlowIssues) || 0;

      const denom = billable + siteFailures;
      const failRate = denom > 0 ? siteFailures / denom : null;
      const uxRate = total > 0 ? userFlowIssues / total : null;

      const baseSamples = [];
      for (let i = dayIdx - 1; i >= 0 && baseSamples.length < 6; i--) {
        const prev = dayMap.get(days[i]);
        if (!prev) continue;
        const prevBill = Number(prev.billable) || 0;
        const prevSf = Number((prev.siteFail ?? prev.siteFailures) || 0);
        const prevDenom = prevBill + prevSf;
        if (prevDenom > 0) {
          baseSamples.push(prevSf / prevDenom);
        }
      }
      const base = baseSamples.length
        ? baseSamples.reduce((sum, val) => sum + val, 0) / baseSamples.length
        : null;

      let intensity = 0;
      const reasons = [];
      if (uxRate !== null && uxRate >= 0.5) {
        intensity = Math.max(intensity, Math.min(1, (uxRate - 0.5) / 0.5 + 0.3));
        reasons.push(`UX friction ${fmtPct(uxRate)} (≥ 50%)`);
      }

      let deltaHealth = null;
      if (failRate !== null && base !== null) {
        const jump = failRate - base;
        if (jump >= 0.20) {
          intensity = Math.max(intensity, Math.min(1, (jump - 0.20) / 0.30 + 0.4));
          reasons.push(`Site failures +${(jump * 100).toFixed(1)}pp vs baseline`);
        }
        deltaHealth = (base - failRate) * 100; // positive = improvement
      }

      let level = "none";
      if (intensity >= 0.65) {
        level = "strong";
      } else if (intensity >= 0.3) {
        level = "mild";
      }

      return { intensity, reasons, level, deltaHealth };
    }

    function formatAnomalyLabel(anomaly) {
      if (!anomaly) return "No anomaly detected";
      const rawLevel = (anomaly.level || anomaly.severity || "").toString().toLowerCase();
      let baseLabel = "No anomaly detected";
      if (rawLevel === "strong") {
        baseLabel = "Strong";
      } else if (rawLevel === "mild") {
        baseLabel = "Mild";
      } else if (rawLevel && rawLevel !== "none") {
        baseLabel = rawLevel.charAt(0).toUpperCase() + rawLevel.slice(1);
      } else if ((anomaly.intensity || 0) > 0) {
        baseLabel = "Mild";
      }

      let detail = "";
      if (Number.isFinite(anomaly.deltaHealth) && Math.abs(anomaly.deltaHealth) >= 1) {
        const dir = anomaly.deltaHealth < 0 ? "dropped" : "increased";
        const pp = Math.abs(anomaly.deltaHealth).toFixed(1).replace(/\.0$/, "");
        detail = `site health ${dir} ${pp}pp vs recent avg`;
      } else if (Array.isArray(anomaly.reasons) && anomaly.reasons.length) {
        detail = anomaly.reasons.join("; ");
      }

      if (baseLabel === "No anomaly detected") {
        return detail ? `${baseLabel} (${detail})` : baseLabel;
      }
      return detail ? `${baseLabel} (${detail})` : baseLabel;
    }

    function buildTooltipHtml({ merchant, date, stats, mode }) {
      const total = Number(stats?.total) || 0;
      const billable = Number(stats?.billable) || 0;
      const siteFailures = Number(stats?.siteFailures ?? stats?.siteFail ?? 0);
      const userFlowIssues = Number(stats?.userFlowIssues) || 0;
      const siteDenom = billable + siteFailures;
      const healthPct = siteDenom > 0 ? (billable / siteDenom) * 100 : null;
      const conversionPct = total > 0 ? (billable / total) * 100 : null;
      const anomalyLabel = formatAnomalyLabel(stats?.anomalyInfo || stats?.anomaly || null);

      const modeLower = (mode || "").toLowerCase();
      let modeLine = "";
      if (modeLower === "traffic") {
        modeLine = total > 0
          ? `Traffic — ${total} attempt${total === 1 ? "" : "s"}`
          : "Traffic — No attempts";
      } else if (modeLower === "health") {
        if (healthPct === null) {
          modeLine = "Health — No signal yet";
        } else {
          const pctStr = formatPercentValue(healthPct) || "";
          modeLine = `Health — ${pctStr} ok (${billable} billable / ${siteFailures} site-related)`;
        }
      } else if (modeLower === "conversion") {
        if (conversionPct === null) {
          modeLine = "Conversion — No attempts";
        } else {
          const pctStr = formatPercentValue(conversionPct) || "";
          modeLine = `Conversion — ${pctStr} billable (${billable}/${total})`;
        }
      } else if (modeLower === "anomaly") {
        modeLine = `Anomaly — ${anomalyLabel}`;
      } else {
        modeLine = total > 0
          ? `Summary — ${billable}/${total} billable attempts`
          : "Summary — No attempts";
      }

      const merchantLabel = escapeHtml(merchant || "");
      const dateLabel = escapeHtml(date || "");
      const safeModeLine = escapeHtml(modeLine);
      const safeAnomalyLabel = escapeHtml(anomalyLabel);
      const anomalySection =
        modeLower === "anomaly"
          ? ""
          : `<div class="tt-anomaly">Anomaly — ${safeAnomalyLabel}</div>`;

      return `
        <div class="tt-inner">
          <div class="tt-title">${merchantLabel} • ${dateLabel}</div>
          <div class="tt-mode">${safeModeLine}</div>
          ${anomalySection}
        </div>
      `;
    }

    function showTooltip(ev, payload) {
      if (!tip || !payload) return;
      tip.innerHTML = buildTooltipHtml(payload);
      tip.hidden = false;
      positionTooltip(ev);
    }

    function positionTooltip(ev) {
      if (!tip || tip.hidden || !ev) return;
      const pad = 14;
      tip.style.left = `${ev.pageX + pad}px`;
      tip.style.top = `${ev.pageY + pad}px`;
    }

    function hideTooltip() {
      if (!tip) return;
      tip.hidden = true;
    }

    // Boot
    loadAndRender(initStart, initEnd);
  </script>
</body>
</html>
