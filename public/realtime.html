<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Real-Time Troubleshooting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./sis-shared.css?v=navfix" />
  <link rel="stylesheet" href="./assets/css/sis.css">
  <link rel="stylesheet" href="./assets/css/mobile.css">
  <script src="./assets/js/passcode-gate.js"></script>
  <script defer src="./assets/js/sis.js"></script>
  <script src="./assets/js/config.js"></script>
  <script defer src="./assets/js/nav.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      if (window.renderHeaderNav && !window.__sisHeaderNav_realtime) {
        window.__sisHeaderNav_realtime = true;
        window.renderHeaderNav({
          currentId: "realtime",
          title: "Real-Time Troubleshooting",
          subtitle: "Live session and placement data directly from instance APIs."
        });
      }
    });
  </script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      --sis-panel-bg: var(--panel);
    }
    .realtime-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 18px;
    }
    .realtime-header h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    .realtime-header p {
      margin: 0;
      color: var(--muted);
      max-width: 860px;
    }
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      align-items: end;
      margin-bottom: 12px;
    }
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-field label {
      font-size: 0.85rem;
      color: var(--muted);
      letter-spacing: 0.03em;
      text-transform: uppercase;
      padding-left: 2px;
    }
    .form-select {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 10px;
      color: var(--text);
      padding: 10px 12px;
      font-size: 0.92rem;
      height: 42px;
      line-height: 22px;
    }
    .form-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }
    .btn {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      border: none;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 1rem;
      cursor: pointer;
      color: #f8fafc;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status-line {
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .status-line.loading {
      color: var(--accent);
    }
    .status-line.error {
      color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
      border-color: rgba(220, 38, 38, 0.3);
    }
    .session-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .session-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
    }
    /* Sessions within GA4 realtime window get the same accent */
    .session-card.in-ga4-window {
      background: var(--realtime-accent);
      border-color: var(--realtime-accent-border);
    }
    .session-top {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--chip-bg);
      color: var(--chip-text);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .chip.muted {
      background: var(--panel-light);
      color: var(--muted);
    }
    .chip.test {
      background: rgba(220, 38, 38, 0.12);
      color: #dc2626;
    }
    [data-theme="dark"] .chip.test {
      background: rgba(249, 115, 22, 0.18);
      color: #fb923c;
    }
    .chip.realtime-accent {
      background: var(--realtime-accent);
      border: 1px solid var(--realtime-accent-border);
      color: var(--realtime-accent-text);
    }
    .chip.realtime-capped {
      background: rgba(245, 158, 11, 0.12);
      color: var(--badge-warn);
    }
    .session-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      color: var(--muted);
      font-size: 0.88rem;
    }
    .session-meta strong {
      color: var(--text);
    }
    .clickstream {
      margin: 10px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .click-pill {
      background: var(--panel-light);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .jobs {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .job {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: var(--panel-light);
    }
    .job-header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
    }
    .badge.success { background: rgba(22,163,74,0.12); color: var(--badge-success); }
    .badge.fail { background: rgba(220,38,38,0.12); color: var(--badge-fail); }
    .badge.warn { background: rgba(245,158,11,0.15); color: var(--badge-warn); }
    .badge.neutral { background: var(--panel); color: var(--muted); border: 1px solid var(--border); }
    .job-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .raw-details {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel-light);
    }
    .raw-details summary {
      cursor: pointer;
      padding: 10px 12px;
      font-weight: 600;
      color: var(--muted);
      list-style: none;
    }
    .raw-details summary::-webkit-details-marker { display: none; }
    .raw-details summary::before {
      content: "▸";
      display: inline-block;
      margin-right: 6px;
      transform: translateY(-1px);
    }
    .raw-details[open] summary::before { content: "▾"; }
    .raw-block {
      padding: 0 12px 12px;
      overflow: auto;
      max-height: 360px;
      font-family: ui-monospace, SFMono-Regular, SFMono, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      color: var(--muted);
      white-space: pre;
    }
    .auto-refresh-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .auto-refresh-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Realtime accent color - subtle teal for "within GA4 window" */
    :root {
      --realtime-accent: rgba(20, 184, 166, 0.08);
      --realtime-accent-border: rgba(20, 184, 166, 0.25);
      --realtime-accent-text: #14b8a6;
    }
    [data-theme="dark"] {
      --realtime-accent: rgba(45, 212, 191, 0.10);
      --realtime-accent-border: rgba(45, 212, 191, 0.30);
      --realtime-accent-text: #2dd4bf;
    }

    /* GA4 Realtime Section */
    .ga4-section {
      margin-bottom: 20px;
      padding: 16px;
      background: var(--realtime-accent);
      border: 1px solid var(--realtime-accent-border);
      border-radius: 14px;
    }
    .ga4-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .ga4-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    .ga4-unavailable {
      padding: 12px 16px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 10px;
      color: var(--badge-warn);
      font-size: 0.9rem;
    }
    .ga4-unavailable a {
      color: var(--accent);
      text-decoration: underline;
    }
    .ga4-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .ga4-summary-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      text-align: center;
    }
    .ga4-summary-card .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .ga4-summary-card .value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
    }
    .ga4-pages-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
    }
    .ga4-page-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .ga4-page-row:last-child {
      border-bottom: none;
    }
    .ga4-page-name {
      flex: 1;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .ga4-page-stats {
      display: flex;
      gap: 12px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }
    .ga4-page-row.expandable {
      cursor: pointer;
    }
    .ga4-page-row.expandable:hover {
      background: var(--realtime-accent);
    }
    .ga4-page-row .expand-icon {
      margin-right: 6px;
      font-size: 0.7rem;
      color: var(--muted);
      transition: transform 0.15s ease;
    }
    .ga4-page-row.expanded .expand-icon {
      transform: rotate(90deg);
    }
    .ga4-minute-breakdown {
      display: none;
      padding: 8px 12px 8px 24px;
      background: var(--panel-light);
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
    }
    .ga4-minute-breakdown.visible {
      display: block;
    }
    .ga4-minute-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      color: var(--muted);
    }
    .ga4-minute-row .minute-label {
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }

    /* Section divider */
    .section-divider {
      margin: 20px 0;
      border: none;
      border-top: 1px dashed var(--border);
    }
    .cardsavr-section-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--text);
    }
  </style>
  <script defer src="./assets/js/card-tooltips.js"></script>
</head>
<body>
  <div id="sis-header"></div>
  <div class="sis-content">
  <main class="sis-main">
    <section class="sis-panel">
      <div class="realtime-header">
        <h1>Real-Time Troubleshooting</h1>
        <p>Query live data directly from instance APIs. Choose an instance and time range to see the most recent sessions and placements.</p>
      </div>

      <div class="filter-grid">
        <div class="form-field">
          <label for="instance">Instance</label>
          <select id="instance" class="form-select">
            <option value="">Loading instances...</option>
          </select>
        </div>
        <div class="form-field">
          <label for="timeRange">Time Range</label>
          <select id="timeRange" class="form-select">
            <option value="5">Last 5 minutes</option>
            <option value="15">Last 15 minutes</option>
            <option value="30" selected>Last 30 minutes</option>
            <option value="60">Last 1 hour</option>
            <option value="120">Last 2 hours</option>
            <option value="240">Last 4 hours</option>
          </select>
        </div>
        <div class="form-field">
          <label for="fiFilter">FI Filter</label>
          <select id="fiFilter" class="form-select">
            <option value="">All FIs</option>
          </select>
        </div>
        <div class="form-field">
          <label for="merchantFilter">Merchant Site</label>
          <select id="merchantFilter" class="form-select">
            <option value="">All Merchants</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button id="fetchBtn" class="btn" disabled>Fetch Live Data</button>
        <label class="auto-refresh-toggle">
          <input type="checkbox" id="autoRefresh" />
          <span>Auto-refresh every 30s</span>
        </label>
      </div>

      <div id="status" class="status-line">Select an instance and click "Fetch Live Data" to begin.</div>

      <div id="ga4-section"></div>
      <hr class="section-divider" id="section-divider" style="display:none;">
      <h3 class="cardsavr-section-title" id="cardsavr-section-title" style="display:none;">CardSavr Sessions & Jobs</h3>
      <div id="results"></div>
    </section>
  </main>
  </div>

  <script>
    (function() {
      const instanceSelect = document.getElementById('instance');
      const timeRangeSelect = document.getElementById('timeRange');
      const fiFilterSelect = document.getElementById('fiFilter');
      const merchantFilterSelect = document.getElementById('merchantFilter');
      const fetchBtn = document.getElementById('fetchBtn');
      const autoRefreshCheckbox = document.getElementById('autoRefresh');
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      const ga4SectionEl = document.getElementById('ga4-section');
      const sectionDividerEl = document.getElementById('section-divider');
      const cardsavrTitleEl = document.getElementById('cardsavr-section-title');

      let autoRefreshInterval = null;
      let instances = [];
      let currentData = null;
      let ga4Data = null;

      // Load instances
      async function loadInstances() {
        try {
          const res = await fetch('/instances');
          const data = await res.json();
          instances = data.instances || [];

          instanceSelect.innerHTML = '<option value="">Select an instance...</option>' +
            instances.map(inst => {
              const name = inst.name || inst.CARDSAVR_INSTANCE || 'unknown';
              return `<option value="${name}">${name}</option>`;
            }).join('');

          fetchBtn.disabled = false;
        } catch (err) {
          console.error('Failed to load instances:', err);
          statusEl.textContent = 'Error loading instances. Please refresh the page.';
          statusEl.className = 'status-line error';
        }
      }

      // Test instance names that should use GA test credentials
      const TEST_INSTANCES = ['customer-dev'];

      function isTestInstance(instanceName) {
        if (!instanceName) return false;
        const normalized = instanceName.toLowerCase().replace(/[^a-z0-9]/g, '');
        return TEST_INSTANCES.some(t => t.toLowerCase().replace(/[^a-z0-9]/g, '') === normalized);
      }

      // Fetch GA4 Realtime data
      async function fetchGa4Data() {
        const minutes = parseInt(timeRangeSelect.value);
        const instance = instanceSelect.value;
        const credential = isTestInstance(instance) ? 'test' : 'prod';

        try {
          const res = await fetch(`/api/realtime-ga?minutes=${minutes}&credential=${credential}`);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const data = await res.json();
          data.credentialUsed = credential; // Track which credential was used
          ga4Data = data;
          displayGa4Section(data);
        } catch (err) {
          console.error('[ga4] Error:', err);
          ga4Data = { available: false, reason: err.message };
          displayGa4Section(ga4Data);
        }
      }

      // Display GA4 section
      // Note: GA4 Realtime API doesn't provide hostname, so FI filtering is not available
      // GA4 Realtime API max is 30 minutes for standard properties
      const GA4_MAX_MINUTES = 30;

      function displayGa4Section(data) {
        const requestedMinutes = parseInt(timeRangeSelect.value);

        if (!data.available) {
          ga4SectionEl.innerHTML = `
            <div class="ga4-section">
              <div class="ga4-section-header">
                <h3 class="ga4-section-title">Page Activity (GA4 Realtime)</h3>
              </div>
              <div class="ga4-unavailable">
                <strong>GA4 Realtime data unavailable:</strong> ${escapeHtml(data.reason || 'Unknown error')}<br>
                <small>Configure GA4 credentials in the <a href="./maintenance.html">Maintenance</a> page.</small>
              </div>
            </div>
          `;
          sectionDividerEl.style.display = 'block';
          cardsavrTitleEl.style.display = 'block';
          return;
        }

        const rows = data.rows || [];
        const isCapped = requestedMinutes > GA4_MAX_MINUTES;

        // Get the actual time range from the data
        let minMinutesAgo = 0;
        let maxMinutesAgo = 0;
        rows.forEach(r => {
          const m = parseInt(r.minutes_ago) || 0;
          if (m > maxMinutesAgo) maxMinutesAgo = m;
        });

        // Use summary from server or compute locally
        const summary = data.summary || {
          total_views: rows.reduce((sum, r) => sum + r.views, 0),
          total_active_users: rows.reduce((sum, r) => sum + r.active_users, 0),
          unique_screens: new Set(rows.map(r => r.screen_name)).size,
        };

        // Aggregate by screen name, keeping per-minute breakdown
        const byScreen = new Map();
        rows.forEach(r => {
          const existing = byScreen.get(r.screen_name) || { views: 0, users: 0, byMinute: new Map() };
          existing.views += r.views;
          existing.users += r.active_users;
          // Store per-minute data
          const minute = parseInt(r.minutes_ago) || 0;
          const minuteData = existing.byMinute.get(minute) || { views: 0, users: 0 };
          minuteData.views += r.views;
          minuteData.users += r.active_users;
          existing.byMinute.set(minute, minuteData);
          byScreen.set(r.screen_name, existing);
        });

        // Sort by views descending
        const sortedScreens = Array.from(byScreen.entries())
          .sort((a, b) => b[1].views - a[1].views)
          .slice(0, 20);

        const pagesHtml = sortedScreens.length === 0
          ? '<div class="ga4-page-row" style="justify-content:center;color:var(--muted);">No page activity in this time range</div>'
          : sortedScreens.map(([screen, stats], idx) => {
              // Build minute breakdown HTML
              const minuteEntries = Array.from(stats.byMinute.entries())
                .sort((a, b) => a[0] - b[0]); // Sort by minute ascending
              const minuteHtml = minuteEntries.map(([minute, mStats]) => `
                <div class="ga4-minute-row">
                  <span class="minute-label">${minute} min ago</span>
                  <span>${mStats.views} views, ${mStats.users} users</span>
                </div>
              `).join('');

              return `
                <div class="ga4-page-row expandable" data-idx="${idx}">
                  <span class="expand-icon">▶</span>
                  <span class="ga4-page-name" title="${escapeHtml(screen)}">${escapeHtml(screen)}</span>
                  <span class="ga4-page-stats">
                    <span title="Page Views">${stats.views} views</span>
                    <span title="Active Users">${stats.users} users</span>
                  </span>
                </div>
                <div class="ga4-minute-breakdown" data-idx="${idx}">
                  ${minuteHtml}
                </div>
              `;
            }).join('');

        // Show the actual time range from the data
        const chipClass = isCapped ? 'realtime-capped' : 'realtime-accent';
        const rangeText = rows.length > 0
          ? `${minMinutesAgo}-${maxMinutesAgo} min ago`
          : 'No data';
        const chipText = isCapped
          ? `${rangeText} (of ${requestedMinutes})`
          : rangeText;

        const credLabel = data.credentialUsed === 'test' ? 'Test Property' : 'Prod Property';

        ga4SectionEl.innerHTML = `
          <div class="ga4-section">
            <div class="ga4-section-header">
              <h3 class="ga4-section-title">Page Activity (GA4 Realtime) <span class="chip muted" style="font-size:0.7rem;margin-left:6px;">${credLabel}</span></h3>
              <span class="chip ${chipClass}">${chipText}</span>
            </div>
            <div class="ga4-summary-grid">
              <div class="ga4-summary-card">
                <div class="label">Page Views</div>
                <div class="value">${summary.total_views.toLocaleString()}</div>
              </div>
              <div class="ga4-summary-card">
                <div class="label">Active Users</div>
                <div class="value">${summary.total_active_users.toLocaleString()}</div>
              </div>
              <div class="ga4-summary-card">
                <div class="label">Unique Pages</div>
                <div class="value">${summary.unique_screens.toLocaleString()}</div>
              </div>
            </div>
            <div class="ga4-pages-list">
              ${pagesHtml}
            </div>
          </div>
        `;

        // Add click handlers for expandable rows
        ga4SectionEl.querySelectorAll('.ga4-page-row.expandable').forEach(row => {
          row.addEventListener('click', () => {
            const idx = row.dataset.idx;
            const breakdown = ga4SectionEl.querySelector(`.ga4-minute-breakdown[data-idx="${idx}"]`);
            row.classList.toggle('expanded');
            breakdown.classList.toggle('visible');
          });
        });

        sectionDividerEl.style.display = 'block';
        cardsavrTitleEl.style.display = 'block';
      }

      // Fetch live data
      async function fetchLiveData() {
        const instance = instanceSelect.value;
        const minutes = parseInt(timeRangeSelect.value);

        if (!instance) {
          statusEl.textContent = 'Please select an instance.';
          statusEl.className = 'status-line error';
          return;
        }

        statusEl.textContent = `Fetching live data from ${instance} (last ${minutes} min)...`;
        statusEl.className = 'status-line loading';
        fetchBtn.disabled = true;

        // Fetch both GA4 and CardSavr data in parallel
        const ga4Promise = fetchGa4Data();

        try {
          const res = await fetch(`/api/realtime?instance=${encodeURIComponent(instance)}&minutes=${minutes}`);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          const data = await res.json();

          console.log('[realtime] Received data:', data);
          console.log('[realtime] First session:', data.sessions?.[0]);
          console.log('[realtime] First session jobs:', data.sessions?.[0]?.jobs);

          currentData = data;
          displayResults(data);
        } catch (err) {
          console.error('Failed to fetch live data:', err);
          statusEl.textContent = `Error: ${err.message}`;
          statusEl.className = 'status-line error';
        } finally {
          fetchBtn.disabled = false;
          // Wait for GA4 to complete too
          await ga4Promise;
        }
      }

      // Populate filter dropdowns based on currently displayed sessions
      function populateFilters(sessions, jobs) {
        // Extract unique FIs from displayed sessions
        const fiSet = new Set();
        sessions.forEach(s => {
          const fi = getSessionFiKey(s);
          if (fi) fiSet.add(fi);
        });
        const fiOptions = Array.from(fiSet).sort();

        // Preserve current selection if it's still valid
        const currentFi = fiFilterSelect.value;
        fiFilterSelect.innerHTML = '<option value="">All FIs</option>' +
          fiOptions.map(fi => `<option value="${fi}" ${fi === currentFi ? 'selected' : ''}>${fi}</option>`).join('');

        // Extract unique merchants from displayed jobs
        const merchantSet = new Set();
        jobs.forEach(job => {
          const merchant = job.merchant || job.merchant_site || '';
          if (merchant) merchantSet.add(merchant);
        });
        const merchantOptions = Array.from(merchantSet).sort();

        // Preserve current selection if it's still valid
        const currentMerchant = merchantFilterSelect.value;
        merchantFilterSelect.innerHTML = '<option value="">All Merchants</option>' +
          merchantOptions.map(m => `<option value="${m}" ${m === currentMerchant ? 'selected' : ''}>${m}</option>`).join('');
      }

      // Apply filters and re-render (filters apply to CardSavr data only)
      // Note: GA4 Realtime API doesn't support FI filtering (no hostname dimension)
      function applyFilters() {
        if (!currentData) return;
        displayResults(currentData);
      }

      // Display results
      function displayResults(data) {
        const sessions = data.sessions || [];
        const placements = data.placements || [];

        if (sessions.length === 0) {
          resultsEl.innerHTML = '<div class="status-line">No sessions found in this time range.</div>';
          populateFilters([], []);
          statusEl.textContent = `Last updated: ${new Date().toLocaleTimeString()} — 0 sessions, 0 placements`;
          statusEl.className = 'status-line';
          return;
        }

        // Get filter values
        const fiFilter = fiFilterSelect.value;
        const merchantFilter = merchantFilterSelect.value;

        // Filter sessions
        let filteredSessions = sessions;

        // Apply FI filter
        if (fiFilter) {
          filteredSessions = filteredSessions.filter(s => {
            const fi = getSessionFiKey(s);
            return fi === fiFilter;
          });
        }

        // Apply merchant filter (session must have at least one job with this merchant)
        if (merchantFilter) {
          filteredSessions = filteredSessions.filter(s => {
            const jobs = s.jobs || [];
            return jobs.some(job => (job.merchant || job.merchant_site || '') === merchantFilter);
          });
        }

        // Collect all jobs from filtered sessions for filter population
        const filteredJobs = [];
        filteredSessions.forEach(s => {
          const jobs = s.jobs || [];
          filteredJobs.push(...jobs);
        });

        // Update filters based on what's displayed
        populateFilters(filteredSessions, filteredJobs);

        // Count filtered placements
        const filteredPlacementCount = filteredSessions.reduce((sum, s) => sum + (s.placements_raw?.length || 0), 0);

        // Update status line with filtered counts
        statusEl.textContent = `Last updated: ${new Date().toLocaleTimeString()} — ${filteredSessions.length} sessions, ${filteredPlacementCount} placements`;
        statusEl.className = 'status-line';

        if (filteredSessions.length === 0) {
          resultsEl.innerHTML = '<div class="status-line">No sessions match the selected filters.</div>';
          return;
        }

        // Render sessions - sessions now have jobs array already embedded
        let html = '';
        filteredSessions.forEach(session => {
          const jobs = session.jobs || [];

          // If merchant filter is active, only show matching jobs
          let displayJobs = jobs;
          if (merchantFilter) {
            displayJobs = jobs.filter(job => (job.merchant || job.merchant_site || '') === merchantFilter);
          }

          html += renderSessionCard(session, displayJobs);
        });

        resultsEl.innerHTML = html;
      }

      // Helper functions from troubleshoot.html
      function escapeHtml(str) {
        return (str || "").toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDateTime(value) {
        if (!value) return "";
        const d = new Date(value);
        if (Number.isNaN(d)) return value;
        return d.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          timeZoneName: "short"
        });
      }

      function formatDuration(ms) {
        if (!Number.isFinite(ms) || ms < 0) return "";
        if (ms < 1000) return ms + " ms";
        const seconds = Math.round(ms / 1000);
        if (seconds < 90) return seconds + "s";
        const minutes = Math.floor(seconds / 60);
        const rem = seconds % 60;
        return rem ? `${minutes}m ${rem}s` : `${minutes}m`;
      }

      const getSessionFiKey = (session) =>
        session?.fi_lookup_key ||
        session?.financial_institution_lookup_key ||
        session?.fi_key ||
        session?.fi ||
        "";

      const getSessionFiLabel = (session) =>
        session?.fi_name || session?.fi_label || getSessionFiKey(session) || "Unknown FI";

      const getSessionInstance = (session) =>
        session?.instance || session?._instance || "";

      function sessionJobStats(session, placements) {
        const jobs = placements || [];
        const jobCount = jobs.length;
        const jobSuccess = jobs.filter((job) => job.is_success).length;
        const jobFailure = Math.max(0, jobCount - jobSuccess);
        return { jobs, jobCount, jobSuccess, jobFailure };
      }

      function jobBadgeClass(job) {
        if (job.is_success) return "success";
        if (job.severity === "ux") return "warn";
        if (job.severity === "site-failure") return "fail";
        return "neutral";
      }

      function renderJobs(jobs = []) {
        if (!jobs.length) {
          return '<div class="job"><div class="job-meta">No placements/jobs recorded in this session.</div></div>';
        }
        return jobs
          .map((job) => {
            const badgeClass = jobBadgeClass(job);
            return `
              <div class="job">
                <div class="job-header">
                  <div class="badge ${badgeClass}">${escapeHtml(job.termination_label || job.termination_type || job.termination || 'unknown')}</div>
                  <div class="chip muted">${escapeHtml(job.merchant_site || job.merchant || "merchant")}</div>
                  ${job.status ? `<div class="chip muted">${escapeHtml(job.status)}</div>` : ""}
                </div>
                <div class="job-meta">
                  ${job.created_on ? `<span>Created ${escapeHtml(formatDateTime(job.created_on))}</span>` : ""}
                  ${job.completed_on ? `<span>Completed ${escapeHtml(formatDateTime(job.completed_on))}</span>` : ""}
                  ${job.duration_ms ? `<span>Duration ${escapeHtml(formatDuration(job.duration_ms))}</span>` : ""}
                  ${getSessionInstance(job) ? `<span>Instance ${escapeHtml(getSessionInstance(job))}</span>` : ""}
                </div>
                ${job.status_message ? `<div class="job-meta">${escapeHtml(job.status_message)}</div>` : ""}
              </div>
            `;
          })
          .join("");
      }

      function renderClickstream(steps) {
        if (!steps || !Array.isArray(steps) || !steps.length) return "";
        const items = steps
          .map((step) => `<span class="click-pill">${escapeHtml(step.url || step.page_title || "step")}</span>`)
          .join("");
        return `<div class="clickstream">${items}</div>`;
      }

      // Check if a session is within the GA4 realtime window (last 30 min)
      function isSessionInGa4Window(session) {
        const createdOn = session.created_on || session.last_updated_on;
        if (!createdOn) return false;
        const sessionTime = new Date(createdOn).getTime();
        const cutoff = Date.now() - (GA4_MAX_MINUTES * 60 * 1000);
        return sessionTime >= cutoff;
      }

      // Render session card with full details
      function renderSessionCard(session, placements) {
        const stats = sessionJobStats(session, placements);
        const jobCount = stats.jobCount;
        const jobSuccess = stats.jobSuccess;
        const jobFailure = stats.jobFailure;
        const integrationLabel =
          session.integration ||
          session.integration_type ||
          session.integration_display ||
          "Unknown integration";
        const partnerLabel =
          session.partner ||
          session.partner_name ||
          session.partner_id ||
          "Unknown";

        // Add accent class if session is within GA4's 30-minute window
        const inGa4Window = isSessionInGa4Window(session);
        const cardClasses = ['session-card'];
        if (inGa4Window) cardClasses.push('in-ga4-window');

        return `
          <div class="${cardClasses.join(' ')}"
            data-fi="${escapeHtml(getSessionFiKey(session))}"
            data-partner="${escapeHtml(partnerLabel)}"
            data-integration="${escapeHtml(integrationLabel)}"
            data-instance="${escapeHtml(getSessionInstance(session))}"
          >
            <div class="session-top">
              <div class="chip">${escapeHtml(getSessionFiLabel(session))}</div>
              <div class="chip muted">${escapeHtml(getSessionInstance(session))}</div>
              <div class="chip muted">${escapeHtml(integrationLabel)}</div>
              <div class="chip muted">${escapeHtml(partnerLabel)}</div>
              ${session.is_test ? '<div class="chip test">Test instance</div>' : ""}
            </div>
            <div class="session-meta">
              ${session.created_on ? `<span><strong>Opened</strong> ${escapeHtml(formatDateTime(session.created_on))}</span>` : ""}
              ${session.closed_on ? `<span><strong>Closed</strong> ${escapeHtml(formatDateTime(session.closed_on))}</span>` : ""}
              <span><strong>Jobs</strong> ${jobCount} (success ${jobSuccess} / fail ${jobFailure})</span>
              ${session.source?.integration ? `<span><strong>Source</strong> ${escapeHtml(session.source.integration)}</span>` : ""}
              ${getSessionFiKey(session) ? `<span><strong>FI lookup key</strong> ${escapeHtml(getSessionFiKey(session))}</span>` : ""}
              ${session.cuid ? `<span><strong>CUID</strong> ${escapeHtml(session.cuid)}</span>` : ""}
            </div>
            ${renderClickstream(session.clickstream)}
            <div class="jobs">
              ${renderJobs(stats.jobs)}
            </div>
            <details class="raw-details">
              <summary>Raw session payload</summary>
              <pre class="raw-block">${escapeHtml(JSON.stringify(session, null, 2))}</pre>
            </details>
            ${
              placements?.length
                ? `<details class="raw-details">
                    <summary>Raw placement payloads (${placements.length})</summary>
                    <pre class="raw-block">${escapeHtml(JSON.stringify(placements, null, 2))}</pre>
                  </details>`
                : ""
            }
          </div>
        `;
      }

      // Auto-refresh handling
      autoRefreshCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          autoRefreshInterval = setInterval(fetchLiveData, 30000);
          statusEl.textContent += ' (Auto-refresh enabled)';
        } else {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
          }
        }
      });

      // Event listeners
      fetchBtn.addEventListener('click', fetchLiveData);
      fiFilterSelect.addEventListener('change', applyFilters);
      merchantFilterSelect.addEventListener('change', applyFilters);

      // Initialize
      loadInstances();
    })();
  </script>
</body>
</html>
