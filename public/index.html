<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Strivve Insights Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/sis-shared.css" />
  <style>
    :root {
      --bg: #070a0f;
      --panel: #101723;
      --accent: #5e8bff;
      --accent-2: #a679ff;
      --text: #eef2ff;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, rgba(94,139,255,.15), transparent 60%) var(--bg);
      color: var(--text);
      font-family: "Inter", "Segoe UI", ui-sans-serif, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;
      padding: 16px 16px 80px;
      --sis-panel-bg: var(--panel);
    }
    h1 {
      font-size: clamp(28px, 4vw, 40px);
      margin: 0 0 12px;
      letter-spacing: .4px;
    }
    p.lead {
      margin: 0 0 32px;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.6;
      max-width: 640px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      align-items: start;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px;
      background: rgba(255,255,255,0.01);
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-height: 280px;
    }
    .card h2 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .card p { margin: 0; color: var(--muted); line-height: 1.5; font-size: 14px; }
    .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 140px;
    }
    .card-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      color: var(--text);
      border-radius: 999px;
      padding: 10px 28px;
      min-width: 170px;
      font-weight: 600;
      letter-spacing: .2px;
      border: none;
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      transition: transform .15s ease, filter .15s ease;
      cursor: pointer;
      appearance: none;
    }
    .btn.secondary {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    footer {
      margin-top: 32px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .2em;
    }
    .refresh-card .refresh-status {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .refresh-card #update-job-status {
      min-height: 18px;
      font-size: 13px;
      color: var(--muted);
    }
    .refresh-card #update-job-log {
      background: #030712;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      min-height: 80px;
      max-height: 160px;
      padding: 10px;
      font-size: 12px;
      color: #e2e8f0;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      margin: 0;
    }
    @media (max-width: 640px) {
      .sis-panel { padding: 28px 24px; }
    }
  </style>
</head>
<body>
  <header class="sis-header">
    <div class="sis-header__inner">
      <div class="sis-brand">Strivve Insights Service (SIS)</div>
      <nav class="sis-nav">
        <a class="sis-nav__item sis-nav__item--active" href="/">Overview</a>
        <a class="sis-nav__item" href="/funnel.html">FI Funnel</a>
        <a class="sis-nav__item" href="/heatmap.html">Merchant Heatmap</a>
      </nav>
    </div>
  </header>
  <main class="sis-main">
    <section class="sis-panel">
      <h1 class="sis-panel-title">Strivve Insights Service</h1>
      <p class="lead sis-panel-subtitle">
        Operational intelligence for Strivve partners. Jump into the live funnel diagnostics
        or explore the global merchant-site health heatmap built from recent SIS traffic.
      </p>

    <div class="grid">
      <article class="card">
        <div class="card-body">
          <h2>FI Funnel &amp; GA Alignment</h2>
          <p>
            Inspect daily rollups, compare SIS sessions to GA CardUpdatr funnel events,
            and slice performance by SSO, CardSavr, or Non-SSO integrations.
          </p>
        </div>
        <div class="card-footer">
          <div class="actions">
            <a class="btn" href="/funnel.html">Open Funnel</a>
          </div>
        </div>
      </article>

      <article class="card">
        <div class="card-body">
          <h2>Merchant Site Heatmap</h2>
          <p>
            Visualize merchant reliability trends in a touching-square heatmap.
            Toggle between traffic, site health, conversion, or anomaly highlighting.
          </p>
        </div>
        <div class="card-footer">
          <div class="actions">
            <a class="btn" href="/heatmap.html">Open Heatmap</a>
          </div>
        </div>
      </article>

      <article class="card refresh-card">
        <div class="card-body">
          <h2>Data Refresh (GA + SIS)</h2>
          <p>
            Kick off the raw-data fetch plus daily rollup rebuild for the most recent 30 days.
            Monitor progress without leaving the overview.
          </p>
        </div>
        <div class="card-footer">
          <div class="actions">
            <button class="btn" id="update-job-btn" type="button">Refresh Data</button>
          </div>
          <div class="refresh-status">
            <div id="update-job-status"></div>
            <pre id="update-job-log" aria-live="polite"></pre>
          </div>
        </div>
      </article>
    </div>
      <footer>Built for Strivve teams · Local data only</footer>
    </section>
  </main>
  <script>
    (function () {
      const btn = document.getElementById("update-job-btn");
      const statusEl = document.getElementById("update-job-status");
      const logEl = document.getElementById("update-job-log");
      let source = null;

      if (!btn || !statusEl || !logEl) {
        return;
      }

      function appendLogLine(text) {
        if (!text) return;
        const ts = new Date().toLocaleTimeString();
        logEl.textContent += `[${ts}] ${text}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setStatus(text) {
        statusEl.textContent = text || "";
      }

      btn.addEventListener("click", () => {
        if (source) {
          source.close();
          source = null;
        }

        logEl.textContent = "";
        setStatus("Starting update…");

        source = new EventSource("/run-update/stream");

        source.addEventListener("open", () => {
          appendLogLine("Connected to update stream.");
        });

        source.addEventListener("snapshot", (ev) => {
          try {
            const data = JSON.parse(ev.data || "{}");
            if (data.running) {
              setStatus(`Update already running for ${data.startDate} → ${data.endDate}…`);
              appendLogLine(data.lastMessage || "Resumed existing job.");
            } else if (data.finishedAt) {
              setStatus("Last update complete (snapshot).");
              if (data.lastMessage) appendLogLine(data.lastMessage);
            } else {
              setStatus("Ready to start update…");
            }
          } catch (err) {
            console.error("snapshot parse error", err);
          }
        });

        source.addEventListener("init", (ev) => {
          try {
            const data = JSON.parse(ev.data || "{}");
            setStatus(`Running: ${data.startDate} → ${data.endDate}`);
            appendLogLine(data.message || "Update started.");
          } catch (err) {
            console.error("init parse error", err);
          }
        });

        source.addEventListener("progress", (ev) => {
          try {
            const data = JSON.parse(ev.data || "{}");
            if (data.message) {
              appendLogLine(data.message);
            }
          } catch (err) {
            console.error("progress parse error", err);
          }
        });

        source.addEventListener("done", (ev) => {
          try {
            const data = JSON.parse(ev.data || "{}");
            setStatus("Update complete.");
            appendLogLine(data.message || "Done.");
          } catch (err) {
            console.error("done parse error", err);
          }
          if (source) {
            source.close();
            source = null;
          }
        });

        source.addEventListener("error", () => {
          setStatus("Update failed or connection lost.");
          appendLogLine("Stream error or disconnect.");
          if (source) {
            source.close();
            source = null;
          }
        });
      });
    })();
  </script>
</body>
</html>
