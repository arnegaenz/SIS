<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <title>Cardholder Engagement Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./sis-shared.css?v=navfix" />
  <link rel="stylesheet" href="./assets/css/sis.css">
  <link rel="stylesheet" href="./assets/css/funnel.css">
  <link rel="stylesheet" href="./assets/css/mobile.css">
  <link rel="stylesheet" href="./assets/css/filters.css">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/passcode-gate.js"></script>
  <script defer src="./assets/js/sis.js"></script>
  <script defer src="./assets/js/nav.js"></script>
  <script type="module" defer src="./assets/js/data-cache.js?v=3"></script>
  <script defer src="./assets/js/filters.js?v=shared"></script>
  <script src="./assets/js/action-library.js?v=1"></script>
  <script src="./assets/js/engagement-insights.js?v=2"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      if (window.renderHeaderNav && !window.__sisHeaderNav_funnel_customer) {
        window.__sisHeaderNav_funnel_customer = true;
        window.renderHeaderNav({
          currentId: "funnel-customer",
          title: "Cardholder Engagement Dashboard",
          subtitle: "Track cardholder adoption and card-on-file success metrics."
        });
      }
    });
  </script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    .funnel-header { margin-bottom: 12px; }
    .form-grid {
      display: flex; flex-wrap: wrap; gap: 6px; align-items: flex-end;
    }
    .form-grid--dates { margin-top: 8px; }
    .form-field {
      display: flex; flex-direction: column; gap: 6px;
      min-width: 160px; min-height: 54px;
    }
    .form-field label {
      font-size: 0.85rem; color: var(--muted, #64748b);
      letter-spacing: 0.03em; text-transform: uppercase; padding-left: 2px;
    }
    .form-select, .form-input {
      background: var(--input-bg, #fff); border: 1px solid var(--input-border, #cbd5e1);
      border-radius: 10px; color: var(--text, #0f172a);
      padding: 10px 12px; font-size: 0.92rem;
      min-width: 160px; height: 42px; line-height: 22px;
    }
    .form-select:focus, .form-input:focus {
      outline: none; border-color: var(--accent, #2563eb);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
    }
    .form-field-actions { min-width: 200px; }
    .form-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    @media (max-width: 767px) {
      .funnel-header .form-grid,
      .funnel-header .form-grid--dates {
        display: flex; flex-direction: column; width: 100%;
      }
      .funnel-header .form-field { min-width: 0; width: 100%; }
    }
    .form-button {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      border: none; border-radius: 999px;
      padding: 10px 28px; min-width: 170px;
      font-size: 0.9rem; cursor: pointer;
      color: #f8fafc; font-weight: 600; letter-spacing: 0.2px;
      white-space: nowrap;
    }
    .form-button.secondary {
      background: transparent;
      border: 1px solid var(--border, #cbd5e1);
      color: var(--muted, #64748b);
      min-width: auto;
    }
    .date-warning {
      margin-top: 6px; padding: 6px 10px; background: #fef3c7; border: 1px solid #fcd34d;
      border-radius: 6px; font-size: 12px; color: #92400e; display: none;
    }

    /* Performance Overview */
    .perf-section-title {
      font-size: 13px; font-weight: 700; color: #0f172a;
      margin: 20px 0 10px; padding-bottom: 4px;
      border-bottom: 2px solid #e2e8f0;
    }
    .perf-section-title:first-child { margin-top: 0; }

    .perf-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px; margin-bottom: 16px;
    }
    @media (max-width: 1024px) { .perf-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .perf-grid { grid-template-columns: 1fr; } }
    .perf-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
      padding: 14px 16px; text-align: left;
      display: flex; flex-direction: column; align-items: flex-start;
      position: relative; overflow: hidden;
      box-shadow: 0 14px 34px rgba(0,0,0,0.08);
      transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .perf-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 42px rgba(0,0,0,0.12);
    }
    .perf-card .card-label {
      font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.05em; color: #64748b;
      line-height: 1.2; margin-bottom: 8px;
      max-width: 100%;
    }
    .perf-card .card-value {
      font-size: 1.8rem; font-weight: 700; color: #0f172a; line-height: 1.1;
      margin-bottom: 4px;
    }
    .perf-card .card-sub {
      font-size: 0.85rem; color: #94a3b8; font-weight: 600;
      white-space: nowrap; text-overflow: ellipsis; max-width: 100%;
      overflow: hidden;
    }
    .perf-card.highlight {
      background: linear-gradient(135deg, rgba(37,99,235,0.10) 0%, rgba(37,99,235,0.03) 55%, transparent 100%), #fff;
      border-color: rgba(37,99,235,0.45);
    }
    .perf-card.highlight::before {
      content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
      background: linear-gradient(180deg, rgba(37,99,235,0.9), rgba(37,99,235,0.15));
    }
    .perf-card.highlight .card-value { color: #2563eb; }
    .perf-card.success {
      background: linear-gradient(135deg, rgba(22,163,74,0.10) 0%, rgba(22,163,74,0.03) 55%, transparent 100%), #fff;
      border-color: rgba(22,163,74,0.45);
    }
    .perf-card.success::before {
      content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
      background: linear-gradient(180deg, rgba(22,163,74,0.9), rgba(22,163,74,0.15));
    }
    .perf-card.success .card-value { color: #16a34a; }

    /* Merchant detail popover (floats out of success card) */
    .perf-card.success { overflow: visible; }
    .card-merchant-detail {
      display: none; position: absolute; left: 0; top: 100%; margin-top: 6px;
      width: max(100%, 260px); z-index: 50;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 10px;
      padding: 10px 12px; font-size: 0.8rem; color: #334155;
      line-height: 1.6; box-shadow: 0 16px 40px rgba(0,0,0,0.12);
    }
    .card-merchant-detail.open { display: block; }
    .card-merchant-detail .merchant-pop-title {
      font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: #64748b; margin-bottom: 6px;
    }
    .card-merchant-row {
      display: flex; justify-content: space-between; gap: 8px;
      padding: 3px 6px; border-radius: 4px;
    }
    .card-merchant-row:nth-child(even) {
      background: rgba(0,0,0,0.03);
    }
    .card-merchant-count {
      white-space: nowrap; font-variant-numeric: tabular-nums; font-weight: 600;
    }

    /* Metrics color key */
    .metrics-key {
      display: flex; align-items: center; gap: 14px; flex-wrap: wrap;
      padding: 8px 14px; margin-bottom: 12px;
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
      font-size: 11px; color: #64748b;
    }
    .key-label { font-weight: 600; color: #334155; margin-right: 2px; }
    .key-item { display: flex; align-items: center; gap: 5px; }
    .key-swatch {
      width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0;
    }
    .key-swatch.ga { background: #ede9fe; border: 1px solid #c4b5fd; }
    .key-swatch.cs { background: #fef3c7; border: 1px solid #fcd34d; }
    .key-swatch.stats { background: #e0f2f1; border: 1px solid rgba(74,158,186,0.45); }
    .key-swatch.highlight { background: #dbeafe; border: 1px solid #93c5fd; }
    .key-swatch.success { background: #dcfce7; border: 1px solid #86efac; }

    /* GA toggle styling */
    .key-toggle {
      cursor: pointer;
      background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 5px;
      padding: 2px 8px 2px 4px; margin: -2px 0;
      transition: opacity 0.15s;
    }
    .key-toggle:hover { border-color: #7c3aed; }
    .key-toggle input[type="checkbox"] {
      width: 13px; height: 13px; margin: 0; cursor: pointer;
      accent-color: #7c3aed;
    }
    .hide-ga .key-toggle {
      background: #f8fafc; border-color: #cbd5e1; opacity: 0.6;
    }
    .hide-ga .key-toggle:hover { opacity: 1; }

    /* When GA is hidden ‚Äî cards, table columns, row label */
    .hide-ga .ga-card,
    .hide-ga .ga-col,
    .hide-ga .grid-row-label.ga-row-label { display: none !important; }
    .hide-ga .key-swatch.ga { opacity: 0.3; }
    .hide-ga .ga-toggle-hint { display: inline; }

    /* Grid row labels (section dividers within the card grid) */
    .grid-row-label {
      grid-column: 1 / -1;
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: #475569;
      padding: 6px 0 2px; margin-top: 4px;
      border-bottom: 1px solid #e2e8f0;
    }
    .grid-row-label .muted {
      font-weight: 400; text-transform: none; letter-spacing: 0;
      color: #94a3b8; font-size: 10px;
    }

    /* GA-sourced cards (purple accent) */
    .perf-card.ga-card {
      background: linear-gradient(135deg, rgba(124,58,237,0.10) 0%, rgba(124,58,237,0.03) 55%, transparent 100%), #fff;
      border-color: rgba(124,58,237,0.40);
    }
    .perf-card.ga-card::before {
      content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
      background: linear-gradient(180deg, rgba(124,58,237,0.85), rgba(124,58,237,0.15));
    }
    .perf-card.ga-card .card-label { color: #5b21b6; }

    /* Session clickstream cards (amber accent) */
    .perf-card.cs-card {
      background: linear-gradient(135deg, rgba(217,119,6,0.10) 0%, rgba(217,119,6,0.03) 55%, transparent 100%), #fff;
      border-color: rgba(217,119,6,0.40);
    }
    .perf-card.cs-card::before {
      content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
      background: linear-gradient(180deg, rgba(217,119,6,0.85), rgba(217,119,6,0.15));
    }
    .perf-card.cs-card .card-label { color: #92400e; }
    .perf-card.cs-card.stats-card {
      background: linear-gradient(135deg, rgba(217,119,6,0.10) 0%, rgba(217,119,6,0.03) 55%, transparent 100%), #fff;
      border-color: rgba(217,119,6,0.40);
    }
    .perf-card.cs-card.stats-card::before {
      background: linear-gradient(180deg, rgba(217,119,6,0.85), rgba(217,119,6,0.15));
    }
    .perf-card.cs-card.stats-card .card-label { color: #92400e; }
    .perf-card.cs-card.stats-card { overflow: visible; }

    /* Stats chips card (Merchants Per Session) */
    .perf-card.stats-card {
      background: linear-gradient(135deg, rgba(74,158,186,0.12) 0%, rgba(74,158,186,0.04) 55%, transparent 100%), #fff;
      border-color: rgba(74,158,186,0.45);
    }
    .perf-card.stats-card::before {
      content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
      background: linear-gradient(180deg, rgba(74,158,186,0.9), rgba(74,158,186,0.15));
    }
    .perf-card.stats-card .card-label { color: #2a7f9a; }
    .stats-chips {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px;
      width: 100%;
    }
    .stats-chip {
      display: inline-flex; align-items: center; justify-content: space-between;
      gap: 8px;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 10px;
      padding: 6px 10px; font-size: 0.85em; color: #64748b;
    }
    .stats-chip b { opacity: 0.8; font-size: 0.85em; letter-spacing: 0.03em; }
    .stats-chip .chip-val { font-weight: 700; color: #0f172a; font-variant-numeric: tabular-nums; }
    /* Stats card bottom row (AVG chip + distribution toggle) */
    .perf-card.stats-card { overflow: visible; position: relative; z-index: 1; }
    .perf-card.stats-card:has(.stats-dist-panel.open) { z-index: 70; }
    .stats-bottom-row {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
      width: 100%; margin-top: 8px; align-items: center;
      position: relative;
    }
    .stats-bottom-row .stats-dist-toggle { grid-column: 2 / 4; }
    .stats-dist-toggle {
      font: inherit; padding: 5px 10px; border-radius: 10px;
      border: 1px solid #e2e8f0; background: #fff; color: #0f172a;
      font-weight: 600; font-size: 0.78rem; cursor: pointer;
      display: inline-flex; align-items: center; gap: 4px;
      transition: border-color 0.15s;
    }
    .stats-dist-toggle:hover { border-color: #4a9eba; }
    .stats-dist-toggle[aria-expanded="true"] { border-color: #4a9eba; }
    /* Distribution popover ‚Äî anchored to .stats-bottom-row */
    .stats-dist-panel {
      display: none; position: absolute; right: 0; top: 100%; margin-top: 10px;
      width: min(360px, calc(100vw - 40px)); z-index: 60;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      max-height: 40vh; overflow: visible;
    }
    .stats-dist-panel > table,
    .stats-dist-panel > div {
      max-height: calc(40vh - 20px); overflow: auto;
    }
    .stats-dist-panel::before {
      content: ""; position: absolute; top: -7px; right: 28px;
      width: 12px; height: 12px; background: #fff;
      border-left: 1px solid #e2e8f0; border-top: 1px solid #e2e8f0;
      transform: rotate(45deg); z-index: 1;
    }
    .stats-dist-panel.open { display: block; }
    .stats-dist-table { width: 100%; border-collapse: collapse; }
    .stats-dist-table th, .stats-dist-table td {
      padding: 8px 12px; border-bottom: 1px solid #f1f5f9; text-align: left;
      font-size: 0.82rem;
    }
    .stats-dist-table th { font-weight: 700; color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .stats-dist-table td:last-child { text-align: right; font-variant-numeric: tabular-nums; font-weight: 600; }
    .stats-dist-empty { padding: 12px; font-size: 0.82rem; color: #94a3b8; }

    /* Highlights table */
    .highlights-table {
      width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 8px;
    }
    .highlights-table th {
      text-align: left; padding: 6px 8px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.03em; color: #475569;
      background: #f1f5f9; border-bottom: 2px solid #e2e8f0;
    }
    .highlights-table td {
      padding: 6px 8px; border-bottom: 1px solid #e2e8f0;
    }
    .highlights-table .num { text-align: center; font-variant-numeric: tabular-nums; }
    .highlights-table .hl-label { font-weight: 600; }
    .highlights-table .nowrap { white-space: nowrap; }
    .highlights-table tbody tr:nth-child(even) { background: #f8fafc; }
    .muted { color: #94a3b8; font-size: 11px; }

    /* Partner summary */
    .partner-summary { margin-top: 16px; }
    .partner-summary table {
      width: 100%; border-collapse: collapse; font-size: 12px;
    }
    .partner-summary th {
      text-align: left; padding: 6px 8px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.03em; color: #475569;
      background: #f1f5f9; border-bottom: 2px solid #e2e8f0;
    }
    .partner-summary td { padding: 6px 8px; border-bottom: 1px solid #e2e8f0; }
    .partner-summary .num { text-align: right; font-variant-numeric: tabular-nums; }
    .partner-summary .total-row td { border-top: 2px solid #cbd5e1; font-weight: 700; background: #f1f5f9; }

    /* Totals bar */
    .totals-bar {
      font-size: 12px; color: #475569; margin-bottom: 12px; line-height: 1.5;
    }

    /* Per-FI tables */
    .group-block { margin-bottom: 16px; }
    .group-header {
      font-size: 13px; font-weight: 700; color: #0f172a;
      padding: 6px 0; border-bottom: 2px solid #e2e8f0;
      margin-bottom: 4px;
    }
    .table-scroll { overflow-x: auto; }
    .fi-table {
      width: 100%; border-collapse: collapse; font-size: 12px;
      white-space: nowrap;
    }
    .fi-table th {
      text-align: center; padding: 5px 8px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.03em; color: #475569;
      background: #f1f5f9; border-bottom: 2px solid #e2e8f0;
      cursor: pointer; user-select: none;
    }
    .fi-table th:hover { color: #0f172a; }
    .fi-table td { padding: 5px 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
    .fi-table tbody tr:hover { background: #f8fafc; }
    .fi-table .num { text-align: center; font-variant-numeric: tabular-nums; }
    .fi-table .totals-row td {
      border-top: 2px solid #cbd5e1; font-weight: 700; background: #f8fafc;
    }
    .fi-table .muted { color: #94a3b8; font-size: 10px; }
    .fi-table .reach-good { color: #16a34a; font-weight: 600; }
    .fi-table .reach-low { color: #d97706; }
    .fi-table th:first-child, .fi-table td:first-child { text-align: left; }

    /* Tab bar (single-FI time breakdowns) */
    .tab-bar {
      display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;
    }
    .tab-button {
      background: transparent; border: 1px solid var(--border, #e2e8f0);
      color: var(--muted, #64748b); border-radius: 999px;
      padding: 6px 14px; font-size: 0.78rem; text-transform: uppercase;
      letter-spacing: 0.08em; cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .tab-button:hover { color: var(--text, #0f172a); }
    .tab-button.active {
      background: var(--panel, #f8fafc); color: var(--text, #0f172a);
      border-color: var(--accent, #2563eb);
    }
    .tab-panel { display: none; margin-top: 8px; }
    .tab-panel.active { display: block; }
    .tab-panel h3 {
      margin: 0 0 6px; font-size: 0.9rem; color: var(--muted, #64748b);
      letter-spacing: 0.08em; text-transform: uppercase;
    }

    /* Date window label */
    .date-window { font-weight: 400; color: #64748b; font-size: 12px; }

    /* Loading */
    .loading-banner {
      display: none; align-items: center; gap: 10px; padding: 12px 16px;
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
      margin-bottom: 12px;
    }
    .spinner {
      width: 18px; height: 18px; border: 2px solid #cbd5e1;
      border-top-color: #2563eb; border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 13px; color: #64748b; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ENGAGEMENT INSIGHTS ‚Äî Narrative, Spectrum, Actions, Projections, Admin
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Section shared styles */
    .insights-section {
      margin: 20px 0 16px;
      padding: 0;
    }
    .insights-section-title {
      font-size: 13px; font-weight: 700; color: #0f172a;
      margin: 0 0 12px; padding-bottom: 4px;
      border-bottom: 2px solid #e2e8f0;
      display: flex; align-items: center; gap: 8px;
    }
    .insights-section-title .section-icon {
      font-size: 15px; line-height: 1;
    }
    .insights-section-title .section-badge {
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.06em; padding: 2px 7px; border-radius: 4px;
      background: #dbeafe; color: #1e40af;
    }

    /* ‚îÄ‚îÄ Narrative insight blocks ‚îÄ‚îÄ */
    .insight-block {
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;
      padding: 14px 18px; margin-bottom: 10px;
      font-size: 0.88rem; line-height: 1.65; color: #334155;
    }
    .insight-block strong { color: #0f172a; }
    .insight-block em { font-style: italic; color: #475569; }
    .insight-block .insight-label {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.06em; color: #94a3b8; margin-bottom: 4px;
    }
    .insight-block .benchmark-ref {
      margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;
      font-size: 0.82rem; color: #64748b;
    }
    .insight-block .benchmark-ref strong { color: #475569; }
    .insight-block .filter-hint {
      margin-top: 8px; padding: 6px 10px;
      background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;
      font-size: 0.8rem; color: #1e40af; cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px;
      transition: background 0.15s;
    }
    .insight-block .filter-hint:hover { background: #dbeafe; }
    .insight-block .filter-hint::before { content: "üí°"; font-size: 12px; }
    .insight-block .filter-hint-secondary {
      display: inline-flex; align-items: center; gap: 4px;
      margin-top: 4px; margin-left: 28px;
      font-size: 0.72rem; color: #64748b;
    }
    .insight-block .filter-hint-secondary a {
      color: #64748b; text-decoration: none;
      transition: color 0.15s;
    }
    .insight-block .filter-hint-secondary a:hover { color: #1e40af; text-decoration: underline; }

    /* ‚îÄ‚îÄ Funnel Visualization ‚îÄ‚îÄ */
    .funnel-viz {
      display: flex; align-items: stretch; gap: 0; margin-bottom: 16px;
      min-height: 120px;
    }
    .funnel-stage {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 12px 8px; text-align: center;
      position: relative; min-width: 0;
    }
    .funnel-stage .stage-bar {
      width: 100%; border-radius: 8px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 14px 8px; position: relative;
      transition: transform 0.15s;
    }
    .funnel-stage .stage-bar:hover { transform: translateY(-2px); }
    .funnel-stage .stage-label {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.04em; color: #64748b; margin-bottom: 4px;
    }
    .funnel-stage .stage-value {
      font-size: 1.3rem; font-weight: 700; color: #0f172a; line-height: 1.2;
    }
    .funnel-stage .stage-pct {
      font-size: 0.75rem; font-weight: 600; margin-top: 2px;
    }
    .funnel-arrow {
      display: flex; align-items: center; justify-content: center;
      width: 60px; flex-shrink: 0; color: #cbd5e1; font-size: 18px;
    }
    .funnel-dropoff, .funnel-expansion, .funnel-neutral {
      font-size: 12px; font-weight: 600; text-align: center;
      margin-top: 4px; padding: 3px 8px; border-radius: 5px;
      line-height: 1.3;
    }
    .dropoff-green { color: #16a34a; background: #dcfce7; }
    .dropoff-yellow { color: #d97706; background: #fef3c7; }
    .dropoff-red { color: #dc2626; background: #fee2e2; }
    .funnel-expansion { color: #2563eb; background: #eff6ff; }
    .funnel-neutral { color: #64748b; background: #f1f5f9; font-weight: 500; }
    .funnel-insight-link {
      display: block; font-size: 11px; font-weight: 500;
      color: #3b82f6; margin-top: 4px; cursor: pointer;
      text-decoration: none; white-space: nowrap;
      transition: color 0.15s;
    }
    .funnel-insight-link:hover { color: #1d4ed8; text-decoration: underline; }
    @keyframes insight-highlight {
      0%, 100% { box-shadow: 0 0 0 3px #f59e0b, 0 0 16px rgba(245,158,11,0.25); }
      50% { box-shadow: 0 0 0 3px #f59e0b, 0 0 28px rgba(245,158,11,0.45); }
    }
    .insight-block.highlight, .scroll-highlight {
      animation: insight-highlight 1s ease-in-out 3;
      background-color: rgba(245,158,11,0.08);
      border-radius: 8px;
    }
    .insight-block.highlight-fade, .scroll-highlight-fade {
      transition: background-color 0.6s ease, box-shadow 0.6s ease;
      background-color: transparent;
      box-shadow: none;
    }
    @media (max-width: 768px) {
      .funnel-viz { flex-direction: column; gap: 8px; }
      .funnel-arrow { width: auto; height: 28px; transform: rotate(90deg); }
    }

    /* ‚îÄ‚îÄ QBR Mode ‚îÄ‚îÄ */
    .qbr-section { display: none !important; }
    body.qbr-mode .qbr-section { display: block !important; }
    .qbr-badge {
      display: inline-block; background: #fef3c7; color: #92400e;
      font-size: 10px; font-weight: 700; letter-spacing: 0.05em;
      padding: 2px 8px; border-radius: 999px; margin-left: 8px;
      text-transform: uppercase; vertical-align: middle;
    }
    .qbr-trend-table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 12px 0; }
    .qbr-trend-table th, .qbr-trend-table td {
      padding: 8px 10px; text-align: right; border-bottom: 1px solid #e2e8f0;
    }
    .qbr-trend-table th { font-weight: 700; color: #0f172a; text-transform: uppercase; font-size: 11px; letter-spacing: 0.04em; }
    .qbr-trend-table th:first-child, .qbr-trend-table td:first-child { text-align: left; font-weight: 600; }
    .qbr-trend-table .trend-up { color: #16a34a; }
    .qbr-trend-table .trend-down { color: #dc2626; }
    .qbr-trend-table .trend-flat { color: #94a3b8; }
    .qbr-sparkline-row { display: flex; flex-wrap: wrap; gap: 20px; margin: 12px 0 16px; }
    .qbr-sparkline-item { display: flex; flex-direction: column; align-items: center; }
    .qbr-sparkline-label { font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.04em; }
    .qbr-summary-block p { margin: 0 0 10px; line-height: 1.6; }
    .qbr-summary-block strong { color: #0f172a; }
    .qbr-yoy-callout {
      background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px;
      padding: 14px 16px; margin: 12px 0;
    }
    .qbr-yoy-callout .yoy-title { font-weight: 700; font-size: 12px; color: #0369a1; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px; }
    .qbr-yoy-callout .yoy-row { font-size: 13px; color: #0f172a; margin: 3px 0; }
    .qbr-monthly-table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 12px 0; }
    .qbr-monthly-table th, .qbr-monthly-table td { padding: 8px 10px; text-align: right; border-bottom: 1px solid #e2e8f0; }
    .qbr-monthly-table th { font-weight: 700; color: #0f172a; text-transform: uppercase; font-size: 11px; }
    .qbr-monthly-table th:first-child, .qbr-monthly-table td:first-child { text-align: left; }
    .qbr-monthly-table tr.totals-row { font-weight: 700; border-top: 2px solid #cbd5e1; }
    .qbr-intra-narrative { font-size: 13px; color: #475569; margin-top: 8px; line-height: 1.5; }

    /* ‚îÄ‚îÄ Share Presentation Mode ‚îÄ‚îÄ */
    body.share-presentation-mode #sis-header { display: none !important; }
    body.share-presentation-mode .sis-nav { display: none !important; }
    body.share-presentation-mode .admin-overlay { display: none !important; }
    body.share-presentation-mode .admin-toggle-bar { display: none !important; }
    body.share-presentation-mode #adminToggleBar { display: none !important; }

    .presentation-header {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #fff; padding: 28px 32px 20px;
      border-radius: 0 0 12px 12px; margin-bottom: 16px;
    }
    .pres-brand { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .pres-brand-text {
      font-size: 11px; font-weight: 600; letter-spacing: 0.12em;
      text-transform: uppercase; color: #0ea5e9;
    }
    .pres-title { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
    .pres-fi { font-size: 16px; font-weight: 600; color: #94a3b8; }
    .pres-partner { font-size: 13px; color: #64748b; }
    .pres-dates {
      margin-top: 8px; font-size: 13px; font-weight: 600; color: #38bdf8;
      display: inline-block; background: rgba(14,165,233,0.12);
      border: 1px solid rgba(14,165,233,0.3);
      border-radius: 20px; padding: 4px 14px;
    }
    .pres-prepared { margin-top: 6px; font-size: 11px; color: #64748b; }

    .presentation-footer {
      text-align: center; padding: 16px; margin-top: 24px;
      border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;
    }
    .presentation-footer a { color: #0ea5e9; text-decoration: none; }

    @media print {
      body.share-presentation-mode #sis-header,
      body.share-presentation-mode .sis-nav,
      body.share-presentation-mode .admin-overlay,
      body.share-presentation-mode .admin-toggle-bar { display: none !important; }
      .presentation-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* ‚îÄ‚îÄ Motivation Spectrum Gauge ‚îÄ‚îÄ */
    .spectrum-container { margin-bottom: 16px; }
    .spectrum-gauge {
      position: relative; height: 48px; border-radius: 8px;
      overflow: visible; margin-bottom: 8px;
      display: flex;
    }
    .spectrum-zone {
      height: 100%; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.95);
      text-transform: uppercase; letter-spacing: 0.04em;
      position: relative; overflow: hidden;
    }
    .spectrum-zone:first-child { border-radius: 8px 0 0 8px; }
    .spectrum-zone:last-child { border-radius: 0 8px 8px 0; }
    .spectrum-marker {
      position: absolute; top: -6px; width: 3px; height: 60px;
      background: #0f172a; border-radius: 2px; z-index: 10;
      transition: left 0.4s ease;
    }
    .spectrum-marker::after {
      content: attr(data-label);
      position: absolute; bottom: -18px; left: 50%;
      transform: translateX(-50%); white-space: nowrap;
      font-size: 10px; font-weight: 700; color: #0f172a;
      background: #fff; padding: 1px 6px; border-radius: 4px;
      border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .spectrum-marker.best-marker { background: #2563eb; }
    .spectrum-marker.best-marker::after { color: #2563eb; border-color: #93c5fd; }
    .spectrum-labels {
      display: flex; justify-content: space-between;
      font-size: 10px; color: #94a3b8; margin-top: 20px;
    }
    .spectrum-diagnosis {
      margin-top: 10px; font-size: 0.88rem; line-height: 1.65; color: #334155;
    }

    /* ‚îÄ‚îÄ Prescriptive Actions ‚îÄ‚îÄ */
    .actions-list { list-style: none; padding: 0; margin: 0; }
    .action-item {
      display: flex; gap: 12px; padding: 12px 16px;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 10px;
      margin-bottom: 8px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .action-item:hover {
      border-color: #93c5fd; box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    .action-priority {
      flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; color: #fff;
    }
    .action-priority.high { background: #2563eb; }
    .action-priority.medium { background: #f59e0b; }
    .action-body { flex: 1; min-width: 0; }
    .action-headline {
      font-size: 0.9rem; font-weight: 700; color: #0f172a;
      margin-bottom: 3px;
    }
    .action-detail {
      font-size: 0.82rem; color: #64748b; line-height: 1.5;
    }

    /* ‚îÄ‚îÄ Action Library Drawer ‚îÄ‚îÄ */
    .library-toggle {
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 10px; padding: 6px 12px;
      background: none; border: 1px solid #cbd5e1; border-radius: 6px;
      font-size: 13px; color: #3b82f6; cursor: pointer; transition: all 0.2s;
    }
    .library-toggle:hover { background: #f1f5f9; border-color: #3b82f6; }
    .library-toggle .toggle-arrow { transition: transform 0.2s; display: inline-block; }
    .library-toggle.open .toggle-arrow { transform: rotate(180deg); }

    .action-library-drawer {
      overflow: hidden; max-height: 0; opacity: 0;
      transition: max-height 0.35s ease, opacity 0.25s ease, margin 0.25s ease, padding 0.25s ease;
      margin-top: 0; padding: 0 20px;
      background: #f8fafc; border-left: 3px solid #3b82f6; border-radius: 0 8px 8px 0;
    }
    .action-library-drawer.open {
      max-height: 800px; opacity: 1;
      margin-top: 12px; padding: 16px 20px;
    }

    .library-channel-header {
      font-size: 13px; font-weight: 600; color: #475569;
      margin: 12px 0 8px 0; display: flex; align-items: center; gap: 6px;
    }
    .library-channel-header:first-child { margin-top: 0; }

    .library-example {
      padding: 10px 14px 10px 14px; margin: 6px 0;
      background: white; border: 1px solid #e2e8f0; border-radius: 6px;
      position: relative; padding-right: 70px;
    }
    .library-example-headline {
      font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #0f172a;
    }
    .library-example-body {
      font-size: 14px; color: #334155; line-height: 1.5;
    }

    .library-copy-btn {
      position: absolute; top: 8px; right: 8px;
      background: none; border: 1px solid #cbd5e1; border-radius: 4px;
      padding: 4px 8px; font-size: 12px; cursor: pointer;
      color: #64748b; transition: all 0.2s; white-space: nowrap;
    }
    .library-copy-btn:hover { background: #f1f5f9; border-color: #94a3b8; }
    .library-copy-btn.copy-success { background: #dcfce7; border-color: #86efac; color: #16a34a; }

    .library-section-intro {
      font-size: 12px; line-height: 1.6; color: #475569; margin-bottom: 12px;
      padding: 10px 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;
    }
    .library-section-intro strong {
      color: #0f172a; font-weight: 600;
    }
    .library-shared-note {
      font-size: 12px; color: #94a3b8; font-style: italic; margin-bottom: 8px;
    }

    .library-footer {
      margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;
    }
    .library-playbook-link {
      display: block; font-size: 13px; color: #3b82f6; text-decoration: none;
    }
    .library-playbook-link:hover { text-decoration: underline; }
    .library-version {
      display: block; margin-top: 4px; font-size: 11px; color: #94a3b8;
    }

    .admin-library-status {
      font-size: 11px; color: #94a3b8; margin-top: 4px;
      padding: 3px 8px; background: #fef3c7; border-radius: 4px; display: inline-block;
    }

    /* ‚îÄ‚îÄ Value Projection ‚îÄ‚îÄ */
    .projection-table {
      width: 100%; border-collapse: collapse; font-size: 13px;
      margin-bottom: 8px;
    }
    .projection-table th {
      text-align: left; padding: 8px 12px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.03em; color: #475569;
      background: #f1f5f9; border-bottom: 2px solid #e2e8f0;
    }
    .projection-table td {
      padding: 8px 12px; border-bottom: 1px solid #e2e8f0;
    }
    .projection-table .num { text-align: right; font-variant-numeric: tabular-nums; }
    .projection-table .current-row td {
      font-weight: 600; background: #f8fafc;
    }
    .projection-table .scenario-row td {
      color: #1e40af;
    }
    .projection-table .multiplier {
      font-weight: 700; color: #16a34a; font-size: 0.85em;
    }
    .projection-note {
      font-size: 11px; color: #94a3b8; font-style: italic; margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Admin Overlay ‚îÄ‚îÄ */
    .admin-overlay { display: none; }
    body.show-admin-overlay .admin-overlay { display: block; }

    .admin-toggle-bar {
      display: none; /* hidden by default, shown for admin users */
      position: fixed; bottom: 16px; right: 16px; z-index: 100;
      background: #1e293b; color: #f8fafc; border-radius: 10px;
      padding: 8px 16px; font-size: 12px; font-weight: 600;
      cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none; align-items: center; gap: 8px;
      transition: background 0.15s;
    }
    .admin-toggle-bar:hover { background: #334155; }
    .admin-toggle-bar .toggle-indicator {
      width: 10px; height: 10px; border-radius: 50%;
      background: #94a3b8; transition: background 0.15s;
    }
    body.show-admin-overlay .admin-toggle-bar .toggle-indicator { background: #22c55e; }

    .admin-panel {
      background: #f0f4ff; border: 1px solid #bfdbfe; border-radius: 10px;
      padding: 14px 18px; margin-bottom: 10px;
    }
    .admin-panel-header {
      display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
      cursor: pointer;
    }
    .admin-panel-header .admin-badge {
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.06em; padding: 2px 7px; border-radius: 4px;
      background: #1e293b; color: #f8fafc;
    }
    .admin-panel-header .admin-panel-title {
      font-size: 12px; font-weight: 700; color: #1e40af;
    }
    .admin-panel-header .expand-icon {
      margin-left: auto; font-size: 14px; color: #64748b;
      transition: transform 0.2s;
    }
    .admin-panel.collapsed .admin-panel-body { display: none; }
    .admin-panel.collapsed .expand-icon { transform: rotate(-90deg); }
    .admin-panel-body {
      font-size: 0.82rem; line-height: 1.6; color: #334155;
    }
    .admin-panel-body .talking-point {
      padding: 6px 0; border-bottom: 1px solid #dbeafe;
    }
    .admin-panel-body .talking-point:last-child { border-bottom: none; }
    .admin-panel-body .tp-category {
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: #6366f1; margin-right: 6px;
    }
    .admin-panel-body .copy-btn {
      background: none; border: 1px solid #cbd5e1; border-radius: 4px;
      padding: 2px 6px; font-size: 10px; color: #64748b; cursor: pointer;
      margin-left: 6px;
    }
    .admin-panel-body .copy-btn:hover { border-color: #2563eb; color: #2563eb; }

    .objection-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 10px 14px; margin-bottom: 6px;
    }
    .objection-card .objection-q {
      font-size: 0.82rem; font-weight: 700; color: #dc2626; margin-bottom: 4px;
    }
    .objection-card .objection-a {
      font-size: 0.82rem; color: #334155; line-height: 1.5;
    }

    .admin-benchmark-refs {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 10px 14px; font-size: 11px; color: #475569; line-height: 1.7;
    }
    .admin-benchmark-refs .ref-title {
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: #dc2626; margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div id="sis-header"></div>
  <div class="sis-content">
  <main class="sis-main">
    <section class="sis-panel">
      <div id="pageLoader" class="loading-banner">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loading-text">Loading data‚Ä¶</div>
      </div>
      <div id="filter-bar"></div>
      <div class="funnel-header">
        <div class="form-grid form-grid--dates">
          <div class="form-field">
            <label for="datePreset">Range preset</label>
            <select id="datePreset" class="form-select">
              <option value="last7" selected>Last 7 days</option>
              <option value="last14">Last 14 days</option>
              <option value="last30">Last 30 days</option>
              <option value="last60">Last 60 days</option>
              <option value="last90">Last 90 days</option>
              <option value="ytd">Year to date</option>
              <option value="qbr">QBR (Quarterly Review)</option>
              <option value="">Custom</option>
            </select>
          </div>
          <div class="form-field">
            <label for="startDate">Start date</label>
            <input id="startDate" type="date" class="form-input" />
          </div>
          <div class="form-field">
            <label for="endDate">End date</label>
            <input id="endDate" type="date" class="form-input" />
          </div>
          <div class="form-field form-field-actions">
            <label>Actions</label>
            <div class="form-actions">
              <button id="applyBtn" class="form-button">Apply filters</button>
              <button id="exportCsvBtn" class="form-button secondary">Export CSV</button>
              <button id="exportPdfBtn" class="form-button secondary">Export PDF</button>
              <button id="exportPdfAdminBtn" class="form-button secondary" style="display:none;" title="Export PDF with internal talking points and admin notes">Export with Internal Notes</button>
              <button id="shareLinkBtn" class="form-button secondary" type="button" title="Copy shareable link to clipboard" style="display:none;">Share</button>
            </div>
          </div>
        </div>
        <div id="dateWarning" class="date-warning" aria-live="polite"></div>
      </div>

      <!-- Performance Overview -->
      <div id="perfOverview" style="display:none;">
        <div class="perf-section-title">Performance Overview <span class="muted date-window" id="dateWindowLabel"></span></div>
        <div id="totalsBar" class="totals-bar" style="display:none;"></div>
        <!-- Color key -->
        <div class="metrics-key">
          <span class="key-label">Data source:</span>
          <label class="key-item key-toggle" id="gaToggleLabel">
            <input type="checkbox" id="gaToggle" checked>
            <span class="key-swatch ga"></span> Google Analytics
          </label>
          <span class="key-item"><span class="key-swatch cs"></span> Visit Clickstream</span>
          <span class="key-item"><span class="key-swatch stats"></span> Visit Stats</span>
          <span class="key-item"><span class="key-swatch highlight"></span> Success Metrics</span>
          <span class="key-item"><span class="key-swatch success"></span> Outcomes</span>
        </div>

        <div class="perf-grid" id="metricsGrid">
          <!-- Row 1: Headlines -->
          <div class="perf-card ga-card" id="cardGaSelect">
            <div class="card-label">CardUpdatr Launches</div>
            <div class="card-value" id="valGaSelect">-</div>
            <div class="card-sub" id="subGaSelect"></div>
          </div>
          <div class="perf-card" id="cardSessions">
            <div class="card-label">CardUpdatr Visits</div>
            <div class="card-value" id="valSessions">-</div>
            <div class="card-sub" id="subSessions"></div>
          </div>
          <div class="perf-card highlight" id="cardSuccessRate">
            <div class="card-label">Success Rate</div>
            <div class="card-value" id="valSuccessRate">-</div>
            <div class="card-sub" id="subSuccessRate">Successful cardholders √∑ Total visits</div>
          </div>
          <div class="perf-card success" id="cardSuccessful" style="cursor:pointer;" title="Click to see merchant breakdown">
            <div class="card-label">Successful Placements</div>
            <div class="card-value" id="valSuccessful">-</div>
            <div class="card-sub" id="subSuccessful"></div>
            <div class="card-merchant-detail" id="merchantDetail"></div>
          </div>

          <!-- Row 2: Funnel stages ‚Äî GA paired with Clickstream -->
          <div class="grid-row-label">Funnel Stages <span class="muted">‚Äî GA traffic vs visit clickstream at each step</span></div>
          <div class="perf-card ga-card" id="cardGaUser">
            <div class="card-label">User Data Page Views</div>
            <div class="card-value" id="valGaUser">-</div>
            <div class="card-sub" id="subGaUser"></div>
          </div>
          <div class="perf-card cs-card" id="cardCsSelect">
            <div class="card-label">Merchant Browsing (Visits)</div>
            <div class="card-value" id="valCsSelect">-</div>
            <div class="card-sub" id="subCsSelect"></div>
          </div>
          <div class="perf-card ga-card" id="cardGaCred">
            <div class="card-label">Credential Entry Views</div>
            <div class="card-value" id="valGaCred">-</div>
            <div class="card-sub" id="subGaCred"></div>
          </div>
          <div class="perf-card cs-card" id="cardCsUser">
            <div class="card-label">User Data (Visits)</div>
            <div class="card-value" id="valCsUser">-</div>
            <div class="card-sub" id="subCsUser"></div>
          </div>

          <!-- Row 3: Conversion & Outcomes -->
          <div class="grid-row-label">Conversion & Outcomes</div>
          <div class="perf-card cs-card" id="cardCsCred">
            <div class="card-label">Credential Entry (Visits)</div>
            <div class="card-value" id="valCsCred">-</div>
            <div class="card-sub" id="subCsCred"></div>
          </div>
          <div class="perf-card" id="cardLaunchCredPct">
            <div class="card-label">Sel ‚Üí Credential %</div>
            <div class="card-value" id="valLaunchCredPct">-</div>
            <div class="card-sub" id="subLaunchCredPct"></div>
          </div>
          <div class="perf-card highlight" id="cardSuccessSessions">
            <div class="card-label">Successful Cardholders</div>
            <div class="card-value" id="valSuccessSessions">-</div>
            <div class="card-sub" id="subSuccessSessions"></div>
          </div>
          <div class="perf-card" id="cardAvgSuccessPerSession">
            <div class="card-label">Avg Cards Per Cardholder</div>
            <div class="card-value" id="valAvgSuccessPerSession">-</div>
            <div class="card-sub" id="subAvgSuccessPerSession"></div>
          </div>

          <!-- Row 4: Cardholder Engagement Depth -->
          <div class="grid-row-label">Cardholder Engagement Depth</div>
          <div class="perf-card stats-card" id="cardMerchantsPerSession" title="How many merchants cardholders attempt per visit (visits with at least one attempt)">
            <div class="card-label">Merchants Per Visit</div>
            <div class="stats-chips" id="merchantStatsChips">
              <span class="stats-chip"><b>MEDIAN</b> <span class="chip-val" id="chipMedian">‚Äî</span></span>
              <span class="stats-chip"><b>MODE</b> <span class="chip-val" id="chipMode">‚Äî</span></span>
              <span class="stats-chip"><b>P75</b> <span class="chip-val" id="chipP75">‚Äî</span></span>
            </div>
            <div class="stats-bottom-row">
              <span class="stats-chip"><b>AVG</b> <span class="chip-val" id="chipAvg">‚Äî</span></span>
              <button class="stats-dist-toggle" id="toggleDistribution" type="button" aria-expanded="false">Show distribution &#9662;</button>
              <div class="stats-dist-panel" id="distributionPanel">
                <table class="stats-dist-table">
                  <thead><tr><th>Merchants per visit</th><th>Visits</th></tr></thead>
                  <tbody id="distributionBody"></tbody>
                </table>
                <div class="stats-dist-empty" id="distributionEmpty" hidden>No distribution data available.</div>
              </div>
            </div>
            <div class="card-sub" id="subMerchantsPerSession"></div>
          </div>
          <div class="perf-card cs-card stats-card" id="cardCsSelectDist" title="Select Merchant page views per visit">
            <div class="card-label">Merchant Views Per Visit</div>
            <div class="stats-chips" id="csSelectStatsChips">
              <span class="stats-chip"><b>MEDIAN</b> <span class="chip-val" id="csSelectChipMedian">‚Äî</span></span>
              <span class="stats-chip"><b>MODE</b> <span class="chip-val" id="csSelectChipMode">‚Äî</span></span>
              <span class="stats-chip"><b>P75</b> <span class="chip-val" id="csSelectChipP75">‚Äî</span></span>
            </div>
            <div class="stats-bottom-row">
              <span class="stats-chip"><b>AVG</b> <span class="chip-val" id="csSelectChipAvg">‚Äî</span></span>
              <button class="stats-dist-toggle" id="csSelectToggleDist" type="button" aria-expanded="false">Show distribution &#9662;</button>
              <div class="stats-dist-panel" id="csSelectDistPanel">
                <table class="stats-dist-table">
                  <thead><tr><th>Views per visit</th><th>Visits</th></tr></thead>
                  <tbody id="csSelectDistBody"></tbody>
                </table>
                <div class="stats-dist-empty" id="csSelectDistEmpty" hidden>No data available.</div>
              </div>
            </div>
            <div class="card-sub" id="csSelectDistSub"></div>
          </div>
          <div class="perf-card cs-card stats-card" id="cardCsUserDist" title="User Data page views per visit">
            <div class="card-label">User Data Views Per Visit</div>
            <div class="stats-chips" id="csUserStatsChips">
              <span class="stats-chip"><b>MEDIAN</b> <span class="chip-val" id="csUserChipMedian">‚Äî</span></span>
              <span class="stats-chip"><b>MODE</b> <span class="chip-val" id="csUserChipMode">‚Äî</span></span>
              <span class="stats-chip"><b>P75</b> <span class="chip-val" id="csUserChipP75">‚Äî</span></span>
            </div>
            <div class="stats-bottom-row">
              <span class="stats-chip"><b>AVG</b> <span class="chip-val" id="csUserChipAvg">‚Äî</span></span>
              <button class="stats-dist-toggle" id="csUserToggleDist" type="button" aria-expanded="false">Show distribution &#9662;</button>
              <div class="stats-dist-panel" id="csUserDistPanel">
                <table class="stats-dist-table">
                  <thead><tr><th>Views per visit</th><th>Visits</th></tr></thead>
                  <tbody id="csUserDistBody"></tbody>
                </table>
                <div class="stats-dist-empty" id="csUserDistEmpty" hidden>No data available.</div>
              </div>
            </div>
            <div class="card-sub" id="csUserDistSub"></div>
          </div>
          <div class="perf-card cs-card stats-card" id="cardCsCredDist" title="Credential Entry page views per visit">
            <div class="card-label">Credential Attempts Per Visit</div>
            <div class="stats-chips" id="csCredStatsChips">
              <span class="stats-chip"><b>MEDIAN</b> <span class="chip-val" id="csCredChipMedian">‚Äî</span></span>
              <span class="stats-chip"><b>MODE</b> <span class="chip-val" id="csCredChipMode">‚Äî</span></span>
              <span class="stats-chip"><b>P75</b> <span class="chip-val" id="csCredChipP75">‚Äî</span></span>
            </div>
            <div class="stats-bottom-row">
              <span class="stats-chip"><b>AVG</b> <span class="chip-val" id="csCredChipAvg">‚Äî</span></span>
              <button class="stats-dist-toggle" id="csCredToggleDist" type="button" aria-expanded="false">Show distribution &#9662;</button>
              <div class="stats-dist-panel" id="csCredDistPanel">
                <table class="stats-dist-table">
                  <thead><tr><th>Views per visit</th><th>Visits</th></tr></thead>
                  <tbody id="csCredDistBody"></tbody>
                </table>
                <div class="stats-dist-empty" id="csCredDistEmpty" hidden>No data available.</div>
              </div>
            </div>
            <div class="card-sub" id="csCredDistSub"></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê Engagement Insights Sections ‚ïê‚ïê‚ïê -->

      <!-- Funnel Visualization -->
      <div id="funnelVizSection" class="insights-section" style="display:none;">
        <div class="insights-section-title">
          Cardholder Journey Funnel
          <span class="section-badge">Funnel</span>
        </div>
        <div class="funnel-viz" id="funnelViz"></div>
        <div class="admin-overlay">
          <div class="admin-panel collapsed" id="adminFunnelPanel">
            <div class="admin-panel-header" onclick="this.parentElement.classList.toggle('collapsed')">
              <span class="admin-badge">INTERNAL</span>
              <span class="admin-panel-title">Funnel Talking Points</span>
              <span class="expand-icon">‚ñº</span>
            </div>
            <div class="admin-panel-body" id="adminFunnelBody"></div>
          </div>
        </div>
      </div>

      <!-- Funnel Narrative Insights -->
      <div id="narrativeSection" class="insights-section" style="display:none;">
        <div class="insights-section-title">
          Performance Insights
          <span class="section-badge">Analysis</span>
        </div>
        <div id="narrativeBlocks"></div>
      </div>

      <!-- Motivation Spectrum -->
      <div id="spectrumSection" class="insights-section" style="display:none;">
        <div class="insights-section-title">
          Cardholder Motivation Spectrum
          <span class="section-badge">Diagnosis</span>
        </div>
        <div class="spectrum-container">
          <div class="spectrum-gauge" id="spectrumGauge"></div>
          <div class="spectrum-labels">
            <span>0%</span>
            <span>Incidental Discovery</span>
            <span>Campaigns</span>
            <span>Activation Flow</span>
            <span>27%+</span>
          </div>
          <div class="spectrum-diagnosis" id="spectrumDiagnosis"></div>
        </div>
        <div class="admin-overlay">
          <div class="admin-panel collapsed" id="adminSpectrumPanel">
            <div class="admin-panel-header" onclick="this.parentElement.classList.toggle('collapsed')">
              <span class="admin-badge">INTERNAL</span>
              <span class="admin-panel-title">Motivation Spectrum Talking Points</span>
              <span class="expand-icon">‚ñº</span>
            </div>
            <div class="admin-panel-body" id="adminSpectrumBody"></div>
          </div>
        </div>
      </div>

      <!-- Prescriptive Actions -->
      <div id="actionsSection" class="insights-section" style="display:none;">
        <div class="insights-section-title">
          Recommended Actions
          <span class="section-badge">Next Steps</span>
        </div>
        <ul class="actions-list" id="actionsList"></ul>
      </div>

      <!-- Value Projection -->
      <div id="projectionSection" class="insights-section" style="display:none;">
        <div class="insights-section-title">
          Growth Opportunity
          <span class="section-badge">Projection</span>
        </div>
        <div id="projectionContent"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê QBR Sections (visible only in QBR mode) ‚ïê‚ïê‚ïê -->
      <div id="qbrTrendSection" class="insights-section qbr-section page-section" style="display:none;">
        <div class="insights-section-title">
          Quarterly Performance Trend
          <span class="qbr-badge">QBR</span>
        </div>
        <div id="qbrTrendTable"></div>
        <div id="qbrSparklines"></div>
      </div>

      <div id="qbrNarrativeSection" class="insights-section qbr-section page-section" style="display:none;">
        <div class="insights-section-title">
          Quarterly Trend Analysis
          <span class="qbr-badge">QBR</span>
        </div>
        <div id="qbrNarrativeBlocks"></div>
      </div>

      <div id="qbrYoySection" class="insights-section qbr-section page-section" style="display:none;">
        <div class="insights-section-title">
          Year-over-Year Comparison
          <span class="qbr-badge">QBR</span>
        </div>
        <div id="qbrYoyContent"></div>
      </div>

      <div id="qbrMonthlySection" class="insights-section qbr-section page-section" style="display:none;">
        <div class="insights-section-title">
          Monthly Detail ‚Äî Current Quarter
          <span class="qbr-badge">QBR</span>
        </div>
        <div id="qbrMonthlyContent"></div>
      </div>

      <div id="qbrSummarySection" class="insights-section qbr-section page-section" style="display:none;">
        <div class="insights-section-title">
          Executive Summary &amp; Outlook
          <span class="qbr-badge">QBR</span>
        </div>
        <div id="qbrSummaryContent"></div>
      </div>

      <!-- Admin Overlay: Objections & Benchmark Refs (floating at bottom of insights) -->
      <div class="admin-overlay">
        <div id="adminObjectionsSection" class="insights-section" style="display:none;">
          <div class="insights-section-title">
            Objection Responses
            <span class="section-badge" style="background:#fee2e2;color:#dc2626;">INTERNAL</span>
          </div>
          <div id="adminObjectionsBody"></div>
        </div>
        <div id="adminBenchmarkRefsSection" class="insights-section" style="display:none;">
          <div class="insights-section-title">
            Named Benchmark References
            <span class="section-badge" style="background:#fee2e2;color:#dc2626;">INTERNAL ‚Äî DO NOT SHARE</span>
          </div>
          <div class="admin-benchmark-refs" id="adminBenchmarkRefsBody"></div>
        </div>
      </div>

      <!-- Highlights -->
      <div id="highlightsSection" style="display:none;">
        <div class="perf-section-title">Performance Highlights <span class="muted">(Best 7-Day Windows)</span></div>
        <div id="bestWindows"></div>
      </div>

      <!-- Per-FI Conversion Tables -->
      <div id="fiTablesSection" style="display:none;">
        <div class="perf-section-title">FI Performance Detail</div>

        <div class="group-block" data-group="SSO" style="display:none;">
          <div class="group-header">SSO</div>
          <div class="table-scroll">
          <table class="fi-table" id="table-SSO">
          <thead><tr>
            <th data-sort="fi">Financial Institution</th>
            <th data-sort="instances">Instance</th>
            <th data-sort="integration">Integration</th>
            <th data-sort="ga_select" class="num ga-col">Launches</th>
            <th data-sort="cs_select" class="num">Sess @Select</th>
            <th data-sort="ga_cred" class="num ga-col">Credential Views</th>
            <th data-sort="reach" class="num">Monthly Reach %</th>
            <th data-sort="sel_cred_pct" class="num">Sel‚ÜíCred %</th>
            <th data-sort="sel_success_pct" class="num">Success Rate</th>
            <th data-sort="sessions" class="num">Visits</th>
            <th data-sort="sess_with_success" class="num">Successful Cardholders</th>
            <th data-sort="sess_success_pct" class="num">Success Rate</th>
            <th data-sort="placements" class="num">Placements</th>
          </tr></thead>
          <tbody></tbody>
          </table>
          </div>
        </div>

        <div class="group-block" data-group="NON-SSO" style="display:none;">
          <div class="group-header">NON-SSO</div>
          <div class="table-scroll">
          <table class="fi-table" id="table-NON-SSO">
          <thead><tr>
            <th data-sort="fi">Financial Institution</th>
            <th data-sort="instances">Instance</th>
            <th data-sort="integration">Integration</th>
            <th data-sort="ga_select" class="num ga-col">Launches</th>
            <th data-sort="cs_select" class="num">Sess @Select</th>
            <th data-sort="ga_user" class="num ga-col">User Data Views</th>
            <th data-sort="ga_cred" class="num ga-col">Credential Views</th>
            <th data-sort="reach" class="num">Monthly Reach %</th>
            <th data-sort="sel_user_pct" class="num">Sel‚ÜíUser %</th>
            <th data-sort="sel_cred_pct" class="num">Sel‚ÜíCred %</th>
            <th data-sort="sel_success_pct" class="num">Success Rate</th>
            <th data-sort="sessions" class="num">Visits</th>
            <th data-sort="sess_with_success" class="num">Successful Cardholders</th>
            <th data-sort="sess_success_pct" class="num">Success Rate</th>
            <th data-sort="placements" class="num">Placements</th>
          </tr></thead>
          <tbody></tbody>
          </table>
          </div>
        </div>

        <div class="group-block" data-group="CardSavr" style="display:none;">
          <div class="group-header">CardSavr</div>
          <div class="table-scroll">
          <table class="fi-table" id="table-CardSavr">
          <thead><tr>
            <th data-sort="fi">Financial Institution</th>
            <th data-sort="instances">Instance</th>
            <th data-sort="integration">Integration</th>
            <th data-sort="ga_select" class="num ga-col">Launches</th>
            <th data-sort="cs_select" class="num">Sess @Select</th>
            <th data-sort="ga_user" class="num ga-col">User Data Views</th>
            <th data-sort="ga_cred" class="num ga-col">Credential Views</th>
            <th data-sort="reach" class="num">Monthly Reach %</th>
            <th data-sort="sel_user_pct" class="num">Sel‚ÜíUser %</th>
            <th data-sort="sel_cred_pct" class="num">Sel‚ÜíCred %</th>
            <th data-sort="sel_success_pct" class="num">Success Rate</th>
            <th data-sort="sessions" class="num">Visits</th>
            <th data-sort="sess_with_success" class="num">Successful Cardholders</th>
            <th data-sort="sess_success_pct" class="num">Success Rate</th>
            <th data-sort="placements" class="num">Placements</th>
          </tr></thead>
          <tbody></tbody>
          </table>
          </div>
        </div>

        <div class="group-block" data-group="UNKNOWN" style="display:none;">
          <div class="group-header">Other</div>
          <div class="table-scroll">
          <table class="fi-table" id="table-UNKNOWN">
          <thead><tr>
            <th data-sort="fi">Financial Institution</th>
            <th data-sort="instances">Instance</th>
            <th data-sort="integration">Integration</th>
            <th data-sort="ga_select" class="num ga-col">Launches</th>
            <th data-sort="cs_select" class="num">Sess @Select</th>
            <th data-sort="ga_user" class="num ga-col">User Data Views</th>
            <th data-sort="ga_cred" class="num ga-col">Credential Views</th>
            <th data-sort="reach" class="num">Monthly Reach %</th>
            <th data-sort="sel_user_pct" class="num">Sel‚ÜíUser %</th>
            <th data-sort="sel_cred_pct" class="num">Sel‚ÜíCred %</th>
            <th data-sort="sel_success_pct" class="num">Success Rate</th>
            <th data-sort="sessions" class="num">Visits</th>
            <th data-sort="sess_with_success" class="num">Successful Cardholders</th>
            <th data-sort="sess_success_pct" class="num">Success Rate</th>
            <th data-sort="placements" class="num">Placements</th>
          </tr></thead>
          <tbody></tbody>
          </table>
          </div>
        </div>
      </div>

      <!-- Single-FI Time Breakdowns -->
      <div id="singleFiView" style="display:none;"></div>

      <!-- Partner Integration Mix -->
      <div id="partnerSummary" class="partner-summary" style="display:none;"></div>

    </section>

    <!-- Admin overlay toggle (fixed position) -->
    <div class="admin-toggle-bar" id="adminToggleBar" title="Toggle internal talking points">
      <span class="toggle-indicator"></span>
      <span>Internal View</span>
    </div>
  </main>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ DOM references ‚îÄ‚îÄ‚îÄ
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const dateWarningEl = document.getElementById("dateWarning");
    const applyBtn = document.getElementById("applyBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const loaderEl = document.getElementById("pageLoader");
    const loaderTextEl = loaderEl?.querySelector(".loading-text");
    const bestWindowsDiv = document.getElementById("bestWindows");
    const partnerSummaryBox = document.getElementById("partnerSummary");
    const dateWindowLabel = document.getElementById("dateWindowLabel");
    const perfOverview = document.getElementById("perfOverview");
    const highlightsSection = document.getElementById("highlightsSection");
    const totalsBar = document.getElementById("totalsBar");

    // ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ
    const FI_ALL_VALUE = "__all__";
    const PARTNER_ALL_VALUE = "__all_partners__";
    const INSTANCE_ALL_VALUE = "__all_instances__";
    const MIN_SELECTS = 10;

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
    let registryMap = {};
    let dailyFiles = [];
    let dailyData = {};
    let lastAggregated = null;
    let lastRenderContext = null;
    let lastFilterSnapshot = null;
    let latestVisibleRows = [];
    let latestSingleFiBreakdowns = null;
    let lastActiveTab = null;
    let latestHighlights = [];
    let latestPartnerSummary = null;
    let latestDailyDate = null;
    let earliestDailyDate = null;

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
    const nextFrame = () => new Promise((resolve) => requestAnimationFrame(resolve));
    const dayMs = 86400000;

    const isoLocalFromDate = (d) => {
      const copy = new Date(d.getTime());
      copy.setHours(0, 0, 0, 0);
      const tzOffset = copy.getTimezoneOffset() * 60000;
      return new Date(copy.getTime() - tzOffset).toISOString().slice(0, 10);
    };
    const isoLocalToday = () => isoLocalFromDate(new Date());
    const isoLocalDaysAgo = (n) => {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return isoLocalFromDate(d);
    };
    const isoLocalYesterday = () => isoLocalDaysAgo(1);
    const defaultEndDateStr = isoLocalYesterday();
    const defaultStartDateStr = isoLocalDaysAgo(6);

    const getLatestUsableDateIso = () => isoLocalYesterday();
    const getMaxSelectableDateIso = () => isoLocalToday();

    function getReferenceDate() {
      return new Date(`${getLatestUsableDateIso()}T00:00:00Z`);
    }

    function enforceEndDateBounds() {
      try {
        const baseIso = getMaxSelectableDateIso();
        if (endDateInput && endDateInput.value && endDateInput.value > baseIso) {
          endDateInput.value = baseIso;
        }
        if (startDateInput && endDateInput && startDateInput.value && endDateInput.value && startDateInput.value > endDateInput.value) {
          startDateInput.value = endDateInput.value;
        }
      } catch (err) {}
    }

    function renderDateWarning() {
      if (!dateWarningEl) return;
      try {
        if (!latestDailyDate) { dateWarningEl.style.display = "none"; dateWarningEl.textContent = ""; return; }
        const chosenEnd = endDateInput?.value;
        if (!chosenEnd || chosenEnd <= latestDailyDate) { dateWarningEl.style.display = "none"; dateWarningEl.textContent = ""; return; }
        dateWarningEl.innerHTML = `Note: data is available through ${latestDailyDate}. You selected ${chosenEnd}.`;
        dateWarningEl.style.display = "block";
      } catch (err) {}
    }

    function applyPresetRange(value) {
      const ref = getReferenceDate();
      const iso = (d) => d.toISOString().slice(0, 10);
      const daysAgo = (n) => iso(new Date(ref.getTime() - n * dayMs));
      const startOfYear = `${ref.getUTCFullYear()}-01-01`;
      let start = daysAgo(6);
      let end = iso(ref);
      switch (value) {
        case "last7": start = daysAgo(6); break;
        case "last14": start = daysAgo(13); break;
        case "last30": start = daysAgo(29); break;
        case "last60": start = daysAgo(59); break;
        case "last90": start = daysAgo(89); break;
        case "ytd": start = startOfYear; break;
        case "qbr": {
          // Most recent completed quarter + 3 prior quarters (trailing year)
          const refMonth = ref.getUTCMonth(); // 0-11
          const refYear = ref.getUTCFullYear();
          const currentQ = Math.floor(refMonth / 3) + 1;
          let completedQ, completedYear;
          if (currentQ === 1) { completedQ = 4; completedYear = refYear - 1; }
          else { completedQ = currentQ - 1; completedYear = refYear; }
          // QBR end = last day of completed quarter
          end = iso(new Date(Date.UTC(completedYear, completedQ * 3, 0)));
          // Start = first day of quarter 3 before completed (4 quarters total)
          let startQ = completedQ - 3;
          let startYear = completedYear;
          if (startQ <= 0) { startQ += 4; startYear -= 1; }
          start = `${startYear}-${String((startQ - 1) * 3 + 1).padStart(2, "0")}-01`;
          break;
        }
        default: start = daysAgo(6);
      }
      startDateInput.value = start;
      endDateInput.value = end;
      renderDateWarning();
    }

    function applyDefaultDateRange(force = false) {
      if (force || !startDateInput.value || !endDateInput.value) {
        applyPresetRange("last7");
        const preset = document.getElementById("datePreset");
        if (preset) preset.value = "last7";
      }
    }

    function ensureDateDefaults() {
      if (!startDateInput.value) startDateInput.value = defaultStartDateStr;
      if (!endDateInput.value) endDateInput.value = defaultEndDateStr;
      enforceEndDateBounds();
    }

    const normalizeFiKey = (value) => value ? value.toString().trim().toLowerCase() : "";
    const normalizeInstanceKey = (value) => {
      if (!value) return "unknown";
      const str = value.toString().trim().toLowerCase();
      const normalized = str.replace(/[^a-z0-9]/g, "");
      return normalized || "unknown";
    };
    const makeFiInstanceKey = (fi, instance) => `${normalizeFiKey(fi)}__${normalizeInstanceKey(instance)}`;
    const parseFiInstanceKey = (key = "") => {
      if (!key.includes("__")) return { fi: key, instance: "unknown" };
      const [fi, instance] = key.split("__");
      return { fi, instance: instance || "unknown" };
    };

    const normalizeIntegrationKey = (val) => {
      const upper = (val || "").toString().trim().toUpperCase();
      if (upper === "NON-SSO" || upper === "NON_SSO" || upper === "NONSSO") return "NON-SSO";
      if (upper === "SSO") return "SSO";
      return upper;
    };

    function normalizeIntegrationLabel(value) {
      if (!value) return "NON-SSO";
      const raw = value.toString().trim().toUpperCase().replace(/[_\s-]+/g, "-");
      if (raw === "SSO") return "SSO";
      if (raw === "CARDSAVR" || raw === "CARD-SAVR" || raw === "CARDSAVER") return "CardSavr";
      if (raw === "TEST") return "TEST";
      if (raw === "UNKNOWN") return "UNKNOWN";
      return "NON-SSO";
    }

    function formatPartnerLabel(value) {
      if (!value) return "Unknown";
      return value.toString();
    }

    function parseDateUtc(dateStr) { return new Date(`${dateStr}T00:00:00Z`); }
    function formatDateUtc(dateObj) { return dateObj.toISOString().slice(0, 10); }
    function addDaysUtc(dateObj, days) {
      const d = new Date(dateObj);
      d.setUTCDate(d.getUTCDate() + days);
      return d;
    }

    function dayCountInclusive(start, end) {
      if (!start || !end) return null;
      const diff = Math.floor((parseDateUtc(end) - parseDateUtc(start)) / dayMs);
      return diff >= 0 ? diff + 1 : null;
    }

    function inRange(date, start, end) {
      if (!date) return false;
      if (start && date < start) return false;
      if (end && date > end) return false;
      return true;
    }

    function dayBefore(dateStr) {
      const d = new Date(dateStr + "T00:00:00Z");
      d.setUTCDate(d.getUTCDate() - 1);
      return d.toISOString().slice(0, 10);
    }

    const INSTANCE_DISPLAY_OVERRIDES = new Map([["digital-onboarding", "digitalonboarding"]]);
    function formatInstanceDisplay(value) {
      if (!value) return "unknown";
      const base = value.toString().trim().toLowerCase().replace(/[\s_]+/g, "-");
      const display = base || "unknown";
      return INSTANCE_DISPLAY_OVERRIDES.get(display) || display;
    }

    function getBillablePlacementCount(placements) {
      if (!placements || typeof placements !== "object") return 0;
      if (typeof placements.successful_placements === "number") return placements.successful_placements;
      if (placements.by_termination && typeof placements.by_termination.BILLABLE === "number") return placements.by_termination.BILLABLE;
      if (typeof placements.total_placements === "number") return placements.total_placements;
      if (typeof placements.total === "number") return placements.total;
      return 0;
    }

    // ‚îÄ‚îÄ‚îÄ Registry lookups ‚îÄ‚îÄ‚îÄ
    const registryInfoMap = new Map();
    const registryCardholderMap = new Map();

    function buildRegistryLookupKey(fiName, instanceValue) {
      return makeFiInstanceKey(normalizeFiKey(fiName), normalizeInstanceKey(instanceValue));
    }

    function updateRegistryLookups(registryData = {}) {
      registryInfoMap.clear();
      registryCardholderMap.clear();
      Object.values(registryData || {}).forEach((entry) => {
        if (!entry || typeof entry !== "object") return;
        const fiKey = normalizeFiKey(entry.fi_lookup_key || entry.fi_name);
        const instanceValue = entry.instance || null;
        const comboKey = buildRegistryLookupKey(fiKey, instanceValue);
        if (comboKey && !registryInfoMap.has(comboKey)) registryInfoMap.set(comboKey, entry);
        if (fiKey && !registryInfoMap.has(fiKey)) registryInfoMap.set(fiKey, entry);
        const total = Number(entry.cardholder_total);
        if (!Number.isFinite(total) || total <= 0) return;
        const info = { total, as_of: entry.cardholder_as_of || null, source: entry.cardholder_source || null };
        if (comboKey && !registryCardholderMap.has(comboKey)) registryCardholderMap.set(comboKey, info);
        if (fiKey && !registryCardholderMap.has(fiKey)) registryCardholderMap.set(fiKey, info);
      });
    }

    function getRegistryEntry(fiName, instanceValue) {
      const fiKey = normalizeFiKey(fiName);
      const comboKey = buildRegistryLookupKey(fiName, instanceValue);
      return registryInfoMap.get(comboKey) || registryInfoMap.get(fiKey) || null;
    }

    function getRegistryCardholderInfo(fiName, instanceValue) {
      const fiKey = normalizeFiKey(fiName);
      const comboKey = buildRegistryLookupKey(fiName, instanceValue);
      return registryCardholderMap.get(comboKey) || registryCardholderMap.get(fiKey) || null;
    }

    // ‚îÄ‚îÄ‚îÄ Data loading ‚îÄ‚îÄ‚îÄ
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${url} ‚Üí ${res.status}`);
      return res.json();
    }

    function deriveIntegration(meta) {
      const raw = (meta?.integration_type || "").toString().toLowerCase();
      const instances = (meta?.instances || []).map((inst) => (inst || "").toString().toLowerCase());
      const hasOnDot = instances.some((inst) => inst.includes("ondot"));
      if (hasOnDot || raw === "cardsavr") return "CardSavr";
      if (raw === "sso") return "SSO";
      return "NON-SSO";
    }

    function extractInstances(meta) {
      if (!meta || typeof meta !== "object") return [];
      const list = Array.isArray(meta.instances) ? meta.instances.slice() : [];
      if (meta.instance) list.push(meta.instance);
      return Array.from(new Set(list.filter(Boolean).map((inst) => inst.toString()))).sort((a, b) => a.localeCompare(b));
    }

    async function fetchRegistry() {
      const data = await fetchJson("/fi-registry");
      const map = {};
      const precedence = { CardSavr: 3, SSO: 2, "NON-SSO": 1 };
      const mergeEntry = (key, payload) => {
        if (!key) return;
        if (!map[key]) { map[key] = { ...payload }; return; }
        const existing = map[key];
        const incomingPriority = precedence[payload.integration || "NON-SSO"] || 0;
        const existingPriority = precedence[existing.integration || "NON-SSO"] || 0;
        if (incomingPriority > existingPriority) existing.integration = payload.integration;
        const mergedInstances = new Set(existing.instances || []);
        (payload.instances || []).forEach((inst) => mergedInstances.add(inst));
        existing.instances = Array.from(mergedInstances).sort((a, b) => a.localeCompare(b));
        if (!existing.instance && payload.instance) existing.instance = payload.instance;
        if (!existing.fi_lookup_key && payload.fi_lookup_key) existing.fi_lookup_key = payload.fi_lookup_key;
        if (!existing.fi_name && payload.fi_name) existing.fi_name = payload.fi_name;
        if (!existing.partner && payload.partner) existing.partner = payload.partner;
        const incomingCardholders = Number(payload.cardholder_total);
        if (Number.isFinite(incomingCardholders) && incomingCardholders > 0 && (!Number.isFinite(Number(existing.cardholder_total)) || Number(existing.cardholder_total) <= 0)) {
          existing.cardholder_total = payload.cardholder_total;
        }
        if (!existing.cardholder_source && payload.cardholder_source) existing.cardholder_source = payload.cardholder_source;
        if (!existing.cardholder_as_of && payload.cardholder_as_of) existing.cardholder_as_of = payload.cardholder_as_of;
      };
      const assignMeta = (metaLike = {}) => {
        const fiKey = normalizeFiKey(metaLike.fi_lookup_key || metaLike.fi_name || metaLike.fi || "");
        if (!fiKey) return;
        const integration = deriveIntegration(metaLike);
        const instances = extractInstances(metaLike);
        const basePayload = {
          integration, instances, fi_lookup_key: fiKey,
          fi_name: metaLike.fi_name || metaLike.fi || metaLike.fi_lookup_key || "",
          partner: metaLike.partner || null,
          cardholder_total: metaLike.cardholder_total !== undefined ? metaLike.cardholder_total : null,
          cardholder_as_of: metaLike.cardholder_as_of || null,
          cardholder_source: metaLike.cardholder_source || null,
          traffic_first_seen_sso: metaLike.traffic_first_seen_sso || null,
        };
        mergeEntry(fiKey, { ...basePayload });
        if (instances.length) {
          instances.forEach((instance) => {
            const normInstance = normalizeInstanceKey(instance);
            const comboKey = makeFiInstanceKey(fiKey, normInstance);
            mergeEntry(comboKey, { ...basePayload, instances: [instance], instance });
          });
        } else {
          const comboKey = makeFiInstanceKey(fiKey, "unknown");
          mergeEntry(comboKey, { ...basePayload, instances: ["unknown"], instance: "unknown" });
        }
      };
      if (Array.isArray(data)) {
        data.forEach((row) => assignMeta(row || {}));
      } else if (data && typeof data === "object") {
        for (const [fiName, meta] of Object.entries(data)) {
          assignMeta({ fi_name: fiName, ...(meta || {}) });
        }
      }
      return map;
    }

    async function fetchDailyList() {
      const payload = await fetch("/list-daily", { cache: 'no-store' }).then(r => r.json());
      return payload.files || [];
    }

    async function fetchDaily(date) {
      if (window.DataCache) {
        const cached = await window.DataCache.getAsync(`daily_${date}`);
        if (cached) return cached;
      }
      const payload = await fetchJson(`/daily?date=${date}`);
      const result = payload?.error ? null : payload;
      if (result && window.DataCache) await window.DataCache.set(`daily_${date}`, result);
      return result;
    }

    async function fetchDailyRange(startDate, endDate) {
      if (!startDate || !endDate) return null;
      try {
        const payload = await fetchJson(`/daily-range?start=${startDate}&end=${endDate}`);
        if (!payload || payload.error) return null;
        return payload.entries || null;
      } catch (err) { return null; }
    }

    function getCardholderMap() { return {}; }

    // ‚îÄ‚îÄ‚îÄ Aggregation ‚îÄ‚îÄ‚îÄ
    function getFiInstanceEntriesForDay(day) {
      if (day?.fi_instances && Object.keys(day.fi_instances).length) {
        return Object.entries(day.fi_instances).map(([key, row]) => {
          const parsed = parseFiInstanceKey(key);
          const instanceDisplay = formatInstanceDisplay(row.instance || parsed.instance);
          const comboKey = key || makeFiInstanceKey(row.fi_lookup_key || parsed.fi, instanceDisplay);
          return { key: comboKey, fi: row.fi_lookup_key || parsed.fi, instance: instanceDisplay, row };
        });
      }
      if (!day?.fi) return [];
      return Object.entries(day.fi).map(([fiName, row]) => {
        const instances = Array.isArray(row.ga_instances) && row.ga_instances.length ? row.ga_instances : ["unknown"];
        const instanceDisplay = formatInstanceDisplay(instances[0]);
        const comboKey = makeFiInstanceKey(fiName, instanceDisplay);
        return { key: comboKey, fi: fiName, instance: instanceDisplay, row };
      });
    }

    function aggregateData(startDate, endDate, cardholderMap) {
      const perFi = {};
      const dates = Object.keys(dailyData).sort();
      for (const date of dates) {
        if (!inRange(date, startDate, endDate)) continue;
        const day = dailyData[date];
        if (!day?.fi) continue;
        const entries = getFiInstanceEntriesForDay(day);
        for (const entry of entries) {
          const fiName = entry.fi || "unknown_fi";
          const instanceName = entry.instance || "unknown";
          const fiNorm = normalizeFiKey(fiName);
          const comboKey = entry.key || makeFiInstanceKey(fiNorm, instanceName);
          const registryEntry = getRegistryEntry(fiName, instanceName);
          const row = entry.row || {};
          const rowIsTest = Boolean(row.is_test);
          const baseIntegration = normalizeIntegrationLabel(registryEntry?.integration || registryEntry?.integration_type);
          const integration = rowIsTest ? "TEST" : baseIntegration;
          const partnerLabel = formatPartnerLabel(registryEntry?.partner);
          const agg = perFi[comboKey] || {
            key: comboKey, fi: fiName, instance: instanceName, integration_type: integration,
            partner: partnerLabel, ga_select: 0, ga_user: 0, ga_cred: 0,
            cs_select: 0, cs_user: 0, cs_cred: 0,
            sessions: 0, sess_with_jobs: 0, sess_with_success: 0,
            total_jobs: 0, successful_jobs: 0, placements: 0,
            instances: [instanceName], is_test: rowIsTest,
            cardholders: null, cardholder_source: null, cardholder_as_of: null,
          };
          agg.integration_type = integration;
          agg.is_test = agg.is_test || rowIsTest;
          const existingInstanceKey = normalizeInstanceKey(agg.instance);
          const incomingInstanceKey = normalizeInstanceKey(instanceName);
          if (agg.instance === "unknown" || (existingInstanceKey === incomingInstanceKey && agg.instance.indexOf("-") === -1 && instanceName.indexOf("-") !== -1)) {
            agg.instance = instanceName;
          }
          if (!agg.instances.some((v) => normalizeInstanceKey(v) === incomingInstanceKey)) {
            agg.instances.push(instanceName);
          }
          if (row.ga) {
            agg.ga_select += row.ga.select_merchants || 0;
            agg.ga_user += row.ga.user_data_collection || 0;
            agg.ga_cred += row.ga.credential_entry || 0;
          }
          if (row.sessions) {
            agg.sessions += row.sessions.total || 0;
            agg.sess_with_jobs += row.sessions.with_jobs || 0;
            agg.sess_with_success += row.sessions.with_success || 0;
            agg.total_jobs += row.sessions.total_jobs || 0;
            agg.successful_jobs += row.sessions.successful_jobs || 0;
            agg.cs_select += row.sessions.cs_select_sessions || 0;
            agg.cs_user += row.sessions.cs_user_sessions || 0;
            agg.cs_cred += row.sessions.cs_cred_sessions || 0;
          }
          if (row.placements) agg.placements += getBillablePlacementCount(row.placements);
          if (rowIsTest) agg.is_test = true;
          const cardholders = cardholderMap[fiNorm];
          if (typeof cardholders === "number" && cardholders > 0) {
            agg.cardholders = cardholders; agg.cardholder_source = "manual"; agg.cardholder_as_of = null;
          } else {
            const registryInfo = getRegistryCardholderInfo(fiName, instanceName);
            if (registryInfo?.total) {
              agg.cardholders = registryInfo.total; agg.cardholder_source = registryInfo.source || null; agg.cardholder_as_of = registryInfo.as_of || null;
            }
          }
          if (!agg.partner || agg.partner === "Unknown") agg.partner = partnerLabel;
          perFi[comboKey] = agg;
        }
      }
      for (const agg of Object.values(perFi)) {
        const registryInfo = getRegistryEntry(agg.fi, agg.instance);
        const derivedIntegration = registryInfo?.integration || registryInfo?.integration_type || agg.integration_type;
        const instanceKey = normalizeInstanceKey(agg.instance);
        let normalized = agg.is_test ? "TEST" : normalizeIntegrationLabel(derivedIntegration);
        if (instanceKey === "ondot" && normalized !== "TEST") normalized = "CardSavr";
        agg.integration_type = normalized;
      }
      return perFi;
    }

    // ‚îÄ‚îÄ‚îÄ Filtering ‚îÄ‚îÄ‚îÄ
    function getVisibleRows(perFi) {
      const shared = window.__FILTER_STATE;
      // Customer page: never include test data
      const includeTests = false;
      const fiTouched = shared && shared.__fiTouched;
      if (shared && shared.page === "funnel-customer") {
        const sharedFiSet = shared.fis ? new Set(Array.from(shared.fis).map((fi) => normalizeFiKey(fi))) : new Set();
        const partnerSet = shared.partnerSetNormalized instanceof Set ? shared.partnerSetNormalized : null;
        const integrationSet = shared.integrationSetNormalized instanceof Set ? shared.integrationSetNormalized : null;
        const partnerSetActive = Boolean(shared.__partnerSetTouched);
        const integrationSetActive = Boolean(shared.__integrationSetTouched);
        const instanceSet = shared.instanceSetNormalized instanceof Set ? shared.instanceSetNormalized : null;
        const instanceSetActive = Boolean(shared.__instanceSetTouched);
        return Object.values(perFi).filter((row) => {
          if (!includeTests && row.is_test) return false;
          if (fiTouched && sharedFiSet.size === 0) return false;
          if (partnerSetActive && (!partnerSet || partnerSet.size === 0)) return false;
          if (integrationSetActive && (!integrationSet || integrationSet.size === 0)) return false;
          if (partnerSetActive && partnerSet && partnerSet.size) {
            const rowPartner = row.partner || "Unknown";
            if (!partnerSet.has(rowPartner)) return false;
          }
          if (integrationSetActive && integrationSet && integrationSet.size) {
            const rowIntegration = normalizeIntegrationKey(row.integration_type || "");
            const allowed = new Set(Array.from(integrationSet).map((v) => normalizeIntegrationKey(v)));
            if (!allowed.has(rowIntegration)) return false;
          }
          if (instanceSetActive) {
            if (!instanceSet || instanceSet.size === 0) return false;
            const rowInstanceKey = normalizeInstanceKey(row.instance);
            if (!instanceSet.has(rowInstanceKey)) return false;
          }
          if (sharedFiSet.size) {
            const fiKey = normalizeFiKey(row.fi);
            if (!sharedFiSet.has(fiKey)) return false;
          }
          return true;
        });
      }
      // Fallback: enforce user scope
      let allowedInstances = null;
      let allowedPartners = null;
      try {
        const user = window.sisAuth?.getUser?.();
        if (user && user.access_level === "limited") {
          if (Array.isArray(user.instance_keys) && user.instance_keys.length > 0) {
            allowedInstances = new Set(user.instance_keys.map(k => (k || "").toString().trim().toLowerCase()));
          }
          if (Array.isArray(user.partner_keys) && user.partner_keys.length > 0) {
            allowedPartners = new Set(user.partner_keys.map(k => (k || "").toString().trim().toLowerCase()));
          }
        }
      } catch (e) {}
      return Object.values(perFi).filter((row) => {
        if (!includeTests && row.is_test) return false;
        if (allowedInstances) {
          const rowInstance = (row.instance || "").toString().trim().toLowerCase();
          if (!allowedInstances.has(rowInstance)) return false;
        }
        if (allowedPartners) {
          const rowPartner = (row.partner || "").toString().trim().toLowerCase();
          if (!allowedPartners.has(rowPartner)) return false;
        }
        return true;
      });
    }

    function isSingleFiSelected() {
      const shared = window.__FILTER_STATE;
      if (shared && shared.page === "funnel-customer") {
        return shared.fis && shared.fis.size === 1;
      }
      return false;
    }

    // ‚îÄ‚îÄ‚îÄ Termination rules (needed for placement categorization) ‚îÄ‚îÄ‚îÄ
    const TERMINATION_RULES = {
      BILLABLE: { label: "Successful", severity: "success" },
      SITE_INTERACTION_FAILURE: { label: "Automation / site failed", severity: "site-failure" },
      UNSUCCESSFUL: { label: "Ran but didn't complete", severity: "site-failure" },
      USER_DATA_FAILURE: { label: "Bad or missing user data", severity: "ux" },
      NEVER_STARTED: { label: "User didn't proceed", severity: "ux" },
      TIMEOUT_CREDENTIALS: { label: "User didn't finish login", severity: "ux" },
      TIMEOUT_TFA: { label: "User didn't finish MFA", severity: "ux" },
      ABANDONED_QUICKSTART: { label: "User bailed from QuickStart", severity: "ux" },
      CANCELED: { label: "User canceled", severity: "ux" },
      ACCOUNT_SETUP_INCOMPLETE: { label: "User didn't finish setup", severity: "ux" },
      TOO_MANY_LOGIN_FAILURES: { label: "User kept failing login", severity: "ux" },
      ACCOUNT_LOCKED: { label: "User account locked", severity: "ux" },
      PASSWORD_RESET_REQUIRED: { label: "Password reset needed", severity: "ux" },
      INVALID_CARD_DETAILS: { label: "Bad card info", severity: "ux" },
      UNKNOWN: { label: "Unknown", severity: "unknown" },
    };

    // ‚îÄ‚îÄ‚îÄ Metrics calculation (customer-facing: only positive metrics) ‚îÄ‚îÄ‚îÄ
    function calculateMetrics(startDate, endDate, visibleRows) {
      const metrics = {
        totalGaSelect: 0, totalGaUser: 0, totalGaCred: 0,
        totalCsSelect: 0, totalCsUser: 0, totalCsCred: 0,
        totalSessions: 0, sessionsWithJobs: 0, sessionsWithSuccessfulJobs: 0,
        totalJobs: 0, successful: 0, totalPlacements: 0,
      };
      for (const row of visibleRows) {
        metrics.totalGaSelect += row.ga_select || 0;
        metrics.totalGaUser += row.ga_user || 0;
        metrics.totalGaCred += row.ga_cred || 0;
        metrics.totalCsSelect += row.cs_select || 0;
        metrics.totalCsUser += row.cs_user || 0;
        metrics.totalCsCred += row.cs_cred || 0;
        metrics.totalSessions += row.sessions || 0;
        metrics.sessionsWithJobs += row.sess_with_jobs || 0;
        metrics.sessionsWithSuccessfulJobs += row.sess_with_success || 0;
        metrics.totalJobs += row.total_jobs || 0;
      }
      // Count placements from daily data (only successful)
      const dates = Object.keys(dailyData).sort();
      for (const date of dates) {
        if (!inRange(date, startDate, endDate)) continue;
        const day = dailyData[date];
        if (!day?.fi_instances) continue;
        for (const fiInstanceKey in day.fi_instances) {
          const fid = day.fi_instances[fiInstanceKey];
          if (!fid?.placements?.by_termination) continue;
          const fiName = fid.fi_lookup_key || fid.fi_name || "";
          const instanceName = fid.instance || "";
          const isVisible = visibleRows.some(row => {
            const rowFi = normalizeFiKey(row.fi || "");
            const dayFi = normalizeFiKey(fiName);
            if (rowFi !== dayFi) return false;
            const rowInstance = normalizeInstanceKey(row.instance);
            const dayInstance = normalizeInstanceKey(instanceName);
            if (rowInstance && rowInstance !== "any" && dayInstance !== rowInstance) return false;
            return true;
          });
          if (!isVisible) continue;
          for (const termType in fid.placements.by_termination) {
            const count = fid.placements.by_termination[termType];
            const rule = TERMINATION_RULES[termType] || TERMINATION_RULES.UNKNOWN;
            if (rule.severity === "success") metrics.successful += count;
            metrics.totalPlacements += count;
          }
        }
      }
      return metrics;
    }

    // ‚îÄ‚îÄ‚îÄ Best windows (highlights) ‚îÄ‚îÄ‚îÄ
    function computeBestWindows(startDate, endDate, perFiLookup = {}, visibleRows = [], monthlyFactor = 1, options = {}) {
      const dates = Object.keys(dailyData).filter((d) => inRange(d, startDate, endDate)).sort();
      if (!dates.length) return [];
      const allowLowVolume = Boolean(options.allowLowVolume);
      const allowedSet = new Set(visibleRows.map((row) => row.key || makeFiInstanceKey(normalizeFiKey(row.fi), normalizeInstanceKey(row.instance))));
      const restrict = allowedSet.size > 0;
      const fiDaily = {};
      for (const date of dates) {
        const day = dailyData[date];
        if (!day?.fi) continue;
        const entries = getFiInstanceEntriesForDay(day);
        for (const entry of entries) {
          const fiDay = entry.row;
          const comboKey = entry.key || makeFiInstanceKey(entry.fi, entry.instance);
          const ga = fiDay.ga || {};
          if (!fiDaily[comboKey]) fiDaily[comboKey] = {};
          fiDaily[comboKey][date] = {
            select: ga.select_merchants || 0, user: ga.user_data_collection || 0,
            cred: ga.credential_entry || 0, cs_select: fiDay.sessions?.cs_select_sessions || 0,
            sessions: fiDay.sessions?.total || 0,
            sess_with_jobs: fiDay.sessions?.with_jobs || 0, sess_with_success: fiDay.sessions?.with_success || 0,
            placements: getBillablePlacementCount(fiDay.placements),
          };
        }
      }
      const perFiByKey = {};
      Object.entries(perFiLookup || {}).forEach(([key, data]) => {
        perFiByKey[key] = data;
        if (data && data.fi) {
          const combo = data.key || makeFiInstanceKey(data.fi, data.instance);
          if (!perFiByKey[combo]) perFiByKey[combo] = data;
        }
      });
      // Collect all 7-day window candidates across all FI/instance combos
      const len = 7;
      if (dates.length < len) return [];
      const allCandidates = [];
      for (const [comboKey, dailyMap] of Object.entries(fiDaily)) {
        if (restrict && !allowedSet.has(comboKey)) continue;
        for (let idx = 0; idx <= dates.length - len; idx += 1) {
          let sel = 0, user = 0, cred = 0, csSelect = 0, sessions = 0, sessWithJobs = 0, sessWithSuccess = 0, placements = 0;
          for (let offset = 0; offset < len; offset += 1) {
            const stats = dailyMap[dates[idx + offset]];
            if (stats) {
              sel += stats.select || 0; user += stats.user || 0; cred += stats.cred || 0;
              csSelect += stats.cs_select || 0;
              sessions += stats.sessions || 0; sessWithJobs += stats.sess_with_jobs || 0;
              sessWithSuccess += stats.sess_with_success || 0; placements += stats.placements || 0;
            }
          }
          const sessionSuccessRatio = sessions ? sessWithSuccess / sessions : 0;
          const selSuccessRatio = csSelect ? sessWithSuccess / csSelect : 0;
          const credEntryRatio = sel > 0 ? cred / sel : 0;
          allCandidates.push({
            key: comboKey,
            fi: perFiByKey[comboKey]?.fi || comboKey,
            instance: perFiByKey[comboKey]?.instance || parseFiInstanceKey(comboKey).instance,
            start: dates[idx], end: dates[idx + len - 1],
            sel, user, cred, sessionSuccessRatio, selSuccessRatio, credEntryRatio,
            sessions, sess_with_jobs: sessWithJobs, sess_with_success: sessWithSuccess, placements,
          });
        }
      }
      if (!allCandidates.length) return [];

      const minVisits = allowLowVolume ? 1 : 10;

      // Compute median weekly visit volume for "at scale" highlight
      const weeklyVolumes = allCandidates.map(c => c.sessions).sort((a, b) => a - b);
      const medianVolume = weeklyVolumes[Math.floor(weeklyVolumes.length / 2)] || 0;

      const windows = [
        { label: "Highest Cardholder Success Rate",
          filter: (c) => c.sessions >= minVisits,
          compare: (c, b) => { if (c.sessionSuccessRatio !== b.sessionSuccessRatio) return c.sessionSuccessRatio - b.sessionSuccessRatio; return c.sessions - b.sessions; } },
        { label: "Most Successful Placements",
          filter: () => true,
          compare: (c, b) => { if (c.placements !== b.placements) return c.placements - b.placements; return c.sessionSuccessRatio - b.sessionSuccessRatio; } },
        { label: "Highest Credential Entry Rate",
          filter: (c) => c.sessions >= minVisits && c.sel >= minVisits,
          compare: (c, b) => { if (c.credEntryRatio !== b.credEntryRatio) return c.credEntryRatio - b.credEntryRatio; return c.sel - b.sel; } },
        { label: "Best Success Rate at Scale",
          filter: (c) => c.sessions > medianVolume && c.sessions >= minVisits,
          compare: (c, b) => { if (c.sessionSuccessRatio !== b.sessionSuccessRatio) return c.sessionSuccessRatio - b.sessionSuccessRatio; return c.sessions - b.sessions; } },
      ];

      const results = [];
      for (const config of windows) {
        let best = null;
        for (const candidate of allCandidates) {
          if (!config.filter(candidate)) continue;
          const labeled = { ...candidate, label: config.label };
          if (!best || config.compare(labeled, best) > 0) best = labeled;
        }
        if (best) {
          const aggRow = perFiByKey[best.key] || {};
          const registryInfo = getRegistryEntry(best.fi, best.instance);
          best.instances = (aggRow.instances || registryInfo?.instances || [best.instance]).join(", ");
          best.integration = normalizeIntegrationLabel(aggRow.integration_type || registryInfo?.integration || "UNKNOWN");
          best.partner = aggRow.partner || registryInfo?.partner || "";
          results.push(best);
        }
        // Skip empty highlights rather than forcing placeholders
      }
      return results;
    }

    // ‚îÄ‚îÄ‚îÄ Partner summary ‚îÄ‚îÄ‚îÄ
    function buildPartnerSummaryData(rows = [], daySpan = 0, partnerValue = PARTNER_ALL_VALUE) {
      if (!rows || !rows.length || !partnerValue || partnerValue === PARTNER_ALL_VALUE) return null;
      const relevant = rows.filter((row) => (row.partner || "Unknown") === partnerValue);
      if (!relevant.length) return null;
      const makeBucket = () => ({ fiCount: 0, ga_select: 0, cs_select: 0, sessions: 0, sess_with_success: 0, placements: 0, cardholders: 0 });
      const buckets = { SSO: makeBucket(), "NON-SSO": makeBucket() };
      relevant.forEach((row) => {
        const key = row.integration_type === "SSO" ? "SSO" : row.integration_type === "NON-SSO" ? "NON-SSO" : null;
        if (!key) return;
        const bucket = buckets[key];
        bucket.ga_select += row.ga_select || 0;
        bucket.cs_select += row.cs_select || 0;
        bucket.sessions += row.sessions || 0;
        bucket.sess_with_success += row.sess_with_success || 0;
        bucket.placements += row.placements || 0;
        if (typeof row.cardholders === "number" && row.cardholders > 0) bucket.cardholders += row.cardholders;
        bucket.fiCount += 1;
      });
      const monthlyFactor = daySpan ? 30 / daySpan : 1;
      const totals = makeBucket();
      const bucketSummaries = Object.entries(buckets).map(([key, bucket]) => {
        bucket.selSuccessPct = bucket.cs_select > 0 && bucket.sess_with_success > 0 ? (bucket.sess_with_success / bucket.cs_select) * 100 : null;
        bucket.sessionSuccessPct = bucket.sessions > 0 && bucket.sess_with_success > 0 ? (bucket.sess_with_success / bucket.sessions) * 100 : null;
        totals.ga_select += bucket.ga_select; totals.cs_select += bucket.cs_select; totals.sessions += bucket.sessions;
        totals.sess_with_success += bucket.sess_with_success; totals.placements += bucket.placements;
        totals.cardholders += bucket.cardholders; totals.fiCount += bucket.fiCount;
        return { key, bucket };
      });
      const rowsOut = bucketSummaries.map(({ key, bucket }) => ({
        integration: key, fiCount: bucket.fiCount, ga_select: bucket.ga_select,
        selSuccessPct: bucket.selSuccessPct, sessions: bucket.sessions,
        sess_with_success: bucket.sess_with_success, sessionSuccessPct: bucket.sessionSuccessPct,
      }));
      totals.selSuccessPct = totals.cs_select > 0 && totals.sess_with_success > 0 ? (totals.sess_with_success / totals.cs_select) * 100 : null;
      totals.sessionSuccessPct = totals.sessions > 0 && totals.sess_with_success > 0 ? (totals.sess_with_success / totals.sessions) * 100 : null;
      return {
        partner: partnerValue, daySpan, rows: rowsOut,
        totals: { integration: "Total", fiCount: totals.fiCount, ga_select: totals.ga_select, selSuccessPct: totals.selSuccessPct, sessions: totals.sessions, sess_with_success: totals.sess_with_success, sessionSuccessPct: totals.sessionSuccessPct },
        instanceCount: relevant.length,
      };
    }

    // ‚îÄ‚îÄ‚îÄ Loading UI ‚îÄ‚îÄ‚îÄ
    let loaderTimer = null;
    let loaderStartedAt = 0;
    const MIN_LOADER_MS = 350;
    const setLoaderMessage = (msg) => { if (loaderTextEl && msg) loaderTextEl.textContent = msg; };
    function startLoading(message = "Loading data‚Ä¶") {
      if (!loaderEl) return;
      if (loaderTimer) { clearTimeout(loaderTimer); loaderTimer = null; }
      loaderStartedAt = Date.now();
      loaderEl.style.display = "flex"; loaderEl.style.visibility = "visible"; loaderEl.style.opacity = "1";
      setLoaderMessage(message);
    }
    function stopLoading() {
      if (!loaderEl) return;
      const elapsed = Date.now() - loaderStartedAt;
      if (elapsed < MIN_LOADER_MS) { loaderTimer = setTimeout(stopLoading, MIN_LOADER_MS - elapsed); return; }
      loaderTimer = null;
      loaderEl.style.display = "none"; loaderEl.style.visibility = "hidden"; loaderEl.style.opacity = "0";
      if (loaderTextEl) loaderTextEl.textContent = "";
    }

    // ‚îÄ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ‚îÄ
    const fmt = (n) => typeof n === "number" && Number.isFinite(n) ? n.toLocaleString("en-US") : "0";
    const pct = (num, den) => den > 0 ? ((num / den) * 100).toFixed(1) + "%" : "‚Äî";

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text.toString();
      return div.innerHTML;
    }

    async function fetchPlacementDetails(type) {
      const shared = window.__FILTER_STATE || {};
      let fiParam = '__all__';
      if (shared.fis && shared.fis.size > 0) {
        fiParam = Array.from(shared.fis).join(',');
      }
      let partnerParam = '__all_partners__';
      if (shared.__partnerSetTouched && shared.partnerSet && shared.partnerSet.size > 0) {
        partnerParam = Array.from(shared.partnerSet).join(',');
      }
      let integrationParam = '(all)';
      if (shared.integrationSet && shared.integrationSet.size > 0) {
        const arr = Array.from(shared.integrationSet);
        if (arr.length === 1) integrationParam = arr[0];
      }
      let instanceParam = 'All';
      if (shared.instanceSet && shared.instanceSet.size > 0) {
        const arr = Array.from(shared.instanceSet);
        if (arr.length === 1) instanceParam = arr[0];
      }
      const params = new URLSearchParams({
        type,
        startDate: startDateInput?.value || defaultStartDateStr,
        endDate: endDateInput?.value || defaultEndDateStr,
        fi: fiParam,
        partner: partnerParam,
        integration: integrationParam,
        instance: instanceParam,
        includeTest: 'false',
        limit: '1000',
        showAll: 'true',
      });
      const token = window.sisAuth?.getToken?.() || localStorage.getItem("sis_session_token") || "";
      const response = await fetch(`/api/placement-details?${params}`, {
        headers: token ? { Authorization: "Bearer " + token } : {},
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }

    let merchantPopoverReady = false;

    function renderMerchantBreakdown(successful) {
      const detailEl = document.getElementById("merchantDetail");
      if (!detailEl) return;
      detailEl.classList.remove("open");
      if (!successful || successful <= 0) { detailEl.innerHTML = ""; merchantPopoverReady = false; return; }
      merchantPopoverReady = false;
      fetchPlacementDetails("success").then(data => {
        if (!data?.results?.length) { detailEl.innerHTML = ""; merchantPopoverReady = false; return; }
        const topMerchants = data.results
          .sort((a, b) => (b.successCount || b.count || 0) - (a.successCount || a.count || 0))
          .slice(0, 10);
        detailEl.innerHTML = '<div class="merchant-pop-title">Top Merchants</div>' +
          topMerchants.map(m => {
            const count = m.successCount || m.count || 0;
            const mPct = successful > 0 ? ((count / successful) * 100).toFixed(1) : "0.0";
            return `<div class="card-merchant-row"><span>${escapeHtml(m.merchant)}</span><span class="card-merchant-count">${count.toLocaleString()} (${mPct}%)</span></div>`;
          }).join("");
        merchantPopoverReady = true;
      }).catch(() => { detailEl.innerHTML = ""; merchantPopoverReady = false; });
    }

    async function fetchJobsStats() {
      const shared = window.__FILTER_STATE || {};
      const token = window.sisAuth?.getToken?.() || localStorage.getItem("sis_session_token") || "";
      const body = {
        start: startDateInput?.value || defaultStartDateStr,
        end: endDateInput?.value || defaultEndDateStr,
        includeTests: false,
      };
      if (shared.fis && shared.fis.size > 0) body.fi = Array.from(shared.fis);
      if (shared.__partnerSetTouched && shared.partnerSet && shared.partnerSet.size > 0) body.partner = Array.from(shared.partnerSet).join(',');
      if (shared.integrationSet && shared.integrationSet.size > 0) {
        const arr = Array.from(shared.integrationSet);
        if (arr.length === 1) body.integration = arr[0];
      }
      if (shared.instanceSet && shared.instanceSet.size > 0) {
        const arr = Array.from(shared.instanceSet);
        if (arr.length === 1) body.instance = arr[0];
      }
      const resp = await fetch("/sessions/jobs-stats", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...(token ? { Authorization: "Bearer " + token } : {}) },
        body: JSON.stringify(body),
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    function renderJobsStatsCard(data) {
      const chipMedian = document.getElementById("chipMedian");
      const chipMode = document.getElementById("chipMode");
      const chipP75 = document.getElementById("chipP75");
      const chipAvg = document.getElementById("chipAvg");
      const subEl = document.getElementById("subMerchantsPerSession");
      const distBody = document.getElementById("distributionBody");
      const distEmpty = document.getElementById("distributionEmpty");
      const distPanel = document.getElementById("distributionPanel");
      // Close panel on new data
      if (distPanel) distPanel.classList.remove("open");
      const toggleBtn = document.getElementById("toggleDistribution");
      if (toggleBtn) toggleBtn.setAttribute("aria-expanded", "false");

      if (!data || !data.distribution || !data.distribution.length) {
        if (chipMedian) chipMedian.textContent = "‚Äî";
        if (chipMode) chipMode.textContent = "‚Äî";
        if (chipP75) chipP75.textContent = "‚Äî";
        if (chipAvg) chipAvg.textContent = "‚Äî";
        if (subEl) subEl.textContent = "";
        if (distBody) distBody.innerHTML = "";
        if (distEmpty) distEmpty.hidden = false;
        return;
      }
      // Rebuild sorted array from distribution for quantile calculations
      const sorted = [];
      let totalJobs = 0;
      for (const row of data.distribution) {
        for (let i = 0; i < row.sessions; i++) sorted.push(row.jobsPerSession);
        totalJobs += row.jobsPerSession * row.sessions;
      }
      const n = sorted.length;
      if (n === 0) {
        if (chipMedian) chipMedian.textContent = "‚Äî";
        if (chipMode) chipMode.textContent = "‚Äî";
        if (chipP75) chipP75.textContent = "‚Äî";
        if (chipAvg) chipAvg.textContent = "‚Äî";
        if (subEl) subEl.textContent = "";
        if (distBody) distBody.innerHTML = "";
        if (distEmpty) distEmpty.hidden = false;
        return;
      }
      // Quantile helper
      function q(p) {
        const idx = (n - 1) * p;
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        if (hi === lo) return sorted[lo];
        return sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
      }
      const median = q(0.5);
      const p75 = q(0.75);
      const avg = totalJobs / n;
      // Mode = job count with most sessions
      let mode = null, maxSess = 0;
      for (const row of data.distribution) {
        if (row.sessions > maxSess) { maxSess = row.sessions; mode = row.jobsPerSession; }
      }
      if (chipMedian) chipMedian.textContent = String(Math.round(median));
      if (chipMode) chipMode.textContent = mode !== null ? String(mode) : "‚Äî";
      if (chipP75) chipP75.textContent = p75 % 1 === 0 ? String(p75) : p75.toFixed(2);
      if (chipAvg) chipAvg.textContent = avg % 1 === 0 ? String(avg) : avg.toFixed(2);
      if (subEl) subEl.textContent = `${n.toLocaleString()} visits with attempts`;

      // Populate distribution table
      if (distBody) {
        distBody.innerHTML = data.distribution
          .sort((a, b) => a.jobsPerSession - b.jobsPerSession)
          .map(r => {
            const jobs = r.jobsPerSession;
            const label = jobs + " merchant" + (jobs === 1 ? "" : "s");
            return `<tr><td>${label}</td><td>${r.sessions.toLocaleString()}</td></tr>`;
          }).join("");
      }
      if (distEmpty) distEmpty.hidden = data.distribution.length > 0;
    }

    async function fetchPageviewStats() {
      const shared = window.__FILTER_STATE || {};
      const token = window.sisAuth?.getToken?.() || localStorage.getItem("sis_session_token") || "";
      const body = {
        start: startDateInput?.value || defaultStartDateStr,
        end: endDateInput?.value || defaultEndDateStr,
        includeTests: false,
      };
      if (shared.fis && shared.fis.size > 0) body.fi = Array.from(shared.fis);
      if (shared.__partnerSetTouched && shared.partnerSet && shared.partnerSet.size > 0) body.partner = Array.from(shared.partnerSet).join(',');
      if (shared.integrationSet && shared.integrationSet.size > 0) {
        const arr = Array.from(shared.integrationSet);
        if (arr.length === 1) body.integration = arr[0];
      }
      if (shared.instanceSet && shared.instanceSet.size > 0) {
        const arr = Array.from(shared.instanceSet);
        if (arr.length === 1) body.instance = arr[0];
      }
      const resp = await fetch("/sessions/pageview-stats", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...(token ? { Authorization: "Bearer " + token } : {}) },
        body: JSON.stringify(body),
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    function renderPageviewStatsCards(data) {
      renderOnePageviewDist("csSelect", data?.selectMerchants, "view");
      renderOnePageviewDist("csUser", data?.userData, "view");
      renderOnePageviewDist("csCred", data?.credentialEntry, "view");
    }

    function renderOnePageviewDist(prefix, distData, unitLabel) {
      const chipMedian = document.getElementById(`${prefix}ChipMedian`);
      const chipMode = document.getElementById(`${prefix}ChipMode`);
      const chipP75 = document.getElementById(`${prefix}ChipP75`);
      const chipAvg = document.getElementById(`${prefix}ChipAvg`);
      const subEl = document.getElementById(`${prefix}DistSub`);
      const distBody = document.getElementById(`${prefix}DistBody`);
      const distEmpty = document.getElementById(`${prefix}DistEmpty`);
      const distPanel = document.getElementById(`${prefix}DistPanel`);
      if (distPanel) distPanel.classList.remove("open");
      const toggleBtn = document.getElementById(`${prefix}ToggleDist`);
      if (toggleBtn) toggleBtn.setAttribute("aria-expanded", "false");

      if (!distData || !distData.distribution || !distData.distribution.length) {
        if (chipMedian) chipMedian.textContent = "‚Äî";
        if (chipMode) chipMode.textContent = "‚Äî";
        if (chipP75) chipP75.textContent = "‚Äî";
        if (chipAvg) chipAvg.textContent = "‚Äî";
        if (subEl) subEl.textContent = "";
        if (distBody) distBody.innerHTML = "";
        if (distEmpty) distEmpty.hidden = false;
        return;
      }
      const sorted = [];
      let totalViews = 0;
      for (const row of distData.distribution) {
        for (let i = 0; i < row.sessions; i++) sorted.push(row.viewsPerSession);
        totalViews += row.viewsPerSession * row.sessions;
      }
      const n = sorted.length;
      if (n === 0) {
        if (chipMedian) chipMedian.textContent = "‚Äî";
        if (chipMode) chipMode.textContent = "‚Äî";
        if (chipP75) chipP75.textContent = "‚Äî";
        if (chipAvg) chipAvg.textContent = "‚Äî";
        if (subEl) subEl.textContent = "";
        if (distBody) distBody.innerHTML = "";
        if (distEmpty) distEmpty.hidden = false;
        return;
      }
      function q(p) {
        const idx = (n - 1) * p;
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        if (hi === lo) return sorted[lo];
        return sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
      }
      const median = q(0.5);
      const p75 = q(0.75);
      const avg = totalViews / n;
      let mode = null, maxSess = 0;
      for (const row of distData.distribution) {
        if (row.sessions > maxSess) { maxSess = row.sessions; mode = row.viewsPerSession; }
      }
      if (chipMedian) chipMedian.textContent = String(Math.round(median));
      if (chipMode) chipMode.textContent = mode !== null ? String(mode) : "‚Äî";
      if (chipP75) chipP75.textContent = p75 % 1 === 0 ? String(p75) : p75.toFixed(2);
      if (chipAvg) chipAvg.textContent = avg % 1 === 0 ? String(avg) : avg.toFixed(2);
      if (subEl) subEl.textContent = `${n.toLocaleString()} visits`;

      if (distBody) {
        distBody.innerHTML = distData.distribution
          .sort((a, b) => a.viewsPerSession - b.viewsPerSession)
          .map(r => {
            const v = r.viewsPerSession;
            const label = v + " " + unitLabel + (v === 1 ? "" : "s");
            return `<tr><td>${label}</td><td>${r.sessions.toLocaleString()}</td></tr>`;
          }).join("");
      }
      if (distEmpty) distEmpty.hidden = distData.distribution.length > 0;
    }

    function renderMetrics(metrics, startDate, endDate, daySpan, fiCount, visibleRows) {
      perfOverview.style.display = "";
      dateWindowLabel.textContent = `Date window: ${startDate} ‚Üí ${endDate} (${fiCount} FIs)`;

      // Detect all-SSO: auto-hide GA data when all visible FIs are SSO
      const allSso = visibleRows && visibleRows.length > 0 &&
        visibleRows.every(r => normalizeIntegrationLabel(r.integration_type || "") === "SSO");
      const gaToggle = document.getElementById("gaToggle");
      if (gaToggle) {
        gaToggle.checked = !allSso;
        document.body.classList.toggle("hide-ga", allSso);
      }

      document.getElementById("valGaSelect").textContent = fmt(metrics.totalGaSelect);
      document.getElementById("subGaSelect").textContent = "Google Analytics tracked";
      document.getElementById("valGaUser").textContent = fmt(metrics.totalGaUser);
      document.getElementById("subGaUser").textContent = pct(metrics.totalGaUser, metrics.totalGaSelect) + " of launches";
      document.getElementById("valGaCred").textContent = fmt(metrics.totalGaCred);
      document.getElementById("subGaCred").textContent = pct(metrics.totalGaCred, metrics.totalGaSelect) + " of launches";
      document.getElementById("valSessions").textContent = fmt(metrics.totalSessions);
      document.getElementById("subSessions").textContent = allSso ? "CardUpdatr loads via SSO" : pct(metrics.totalSessions, metrics.totalGaSelect) + " of launches";

      const launchCredPct = metrics.totalCsSelect > 0 ? ((metrics.totalCsCred / metrics.totalCsSelect) * 100).toFixed(1) + "%" : "‚Äî";
      document.getElementById("valLaunchCredPct").textContent = launchCredPct;
      document.getElementById("subLaunchCredPct").textContent = fmt(metrics.totalCsCred) + " of " + fmt(metrics.totalCsSelect) + " visits @select";

      document.getElementById("valSuccessSessions").textContent = fmt(metrics.sessionsWithSuccessfulJobs);
      document.getElementById("subSuccessSessions").textContent = pct(metrics.sessionsWithSuccessfulJobs, metrics.totalSessions) + " of visits";

      const successRate = metrics.totalSessions > 0 ? ((metrics.sessionsWithSuccessfulJobs / metrics.totalSessions) * 100).toFixed(1) + "%" : "‚Äî";
      document.getElementById("valSuccessRate").textContent = successRate;

      document.getElementById("valSuccessful").textContent = fmt(metrics.successful);
      document.getElementById("subSuccessful").textContent = "Cards updated at merchants";

      // Merchant breakdown on Successful Placements card
      renderMerchantBreakdown(metrics.successful);

      // Avg Successful Cards Per Session
      const avgSucc = metrics.sessionsWithSuccessfulJobs > 0
        ? (metrics.successful / metrics.sessionsWithSuccessfulJobs).toFixed(2)
        : "‚Äî";
      document.getElementById("valAvgSuccessPerSession").textContent = avgSucc;
      document.getElementById("subAvgSuccessPerSession").textContent =
        metrics.sessionsWithSuccessfulJobs > 0
          ? fmt(metrics.successful) + " across " + fmt(metrics.sessionsWithSuccessfulJobs) + " sessions"
          : "";

      // Merchants Per Session (async ‚Äî calls /sessions/jobs-stats)
      document.getElementById("chipMedian").textContent = "‚Ä¶";
      document.getElementById("chipMode").textContent = "‚Ä¶";
      document.getElementById("chipP75").textContent = "‚Ä¶";
      document.getElementById("chipAvg").textContent = "‚Ä¶";
      document.getElementById("subMerchantsPerSession").textContent = "Loading‚Ä¶";
      fetchJobsStats().then(renderJobsStatsCard).catch(() => renderJobsStatsCard(null));

      // Session clickstream metrics
      document.getElementById("valCsSelect").textContent = fmt(metrics.totalCsSelect);
      document.getElementById("subCsSelect").textContent = fmt(metrics.totalCsSelect) + " of " + fmt(metrics.totalSessions) + " visits";
      document.getElementById("valCsUser").textContent = fmt(metrics.totalCsUser);
      document.getElementById("subCsUser").textContent = pct(metrics.totalCsUser, metrics.totalCsSelect) + " of visits @select";
      document.getElementById("valCsCred").textContent = fmt(metrics.totalCsCred);
      document.getElementById("subCsCred").textContent = pct(metrics.totalCsCred, metrics.totalCsSelect) + " of visits @select";

      // Hide User Data cards when all-SSO (SSO skips user data collection step)
      const cardCsUser = document.getElementById("cardCsUser");
      if (cardCsUser) cardCsUser.style.display = allSso ? "none" : "";
      const cardCsUserDist = document.getElementById("cardCsUserDist");
      if (cardCsUserDist) cardCsUserDist.style.display = allSso ? "none" : "";

      // Clickstream page-view distributions (async)
      ["csSelect", "csUser", "csCred"].forEach(prefix => {
        const el = document.getElementById(`${prefix}ChipMedian`);
        if (el) el.textContent = "‚Ä¶";
        const el2 = document.getElementById(`${prefix}ChipMode`);
        if (el2) el2.textContent = "‚Ä¶";
        const el3 = document.getElementById(`${prefix}ChipP75`);
        if (el3) el3.textContent = "‚Ä¶";
        const el4 = document.getElementById(`${prefix}ChipAvg`);
        if (el4) el4.textContent = "‚Ä¶";
        const sub = document.getElementById(`${prefix}DistSub`);
        if (sub) sub.textContent = "Loading‚Ä¶";
      });
      fetchPageviewStats().then(renderPageviewStatsCards).catch(() => renderPageviewStatsCards(null));

      // Totals bar
      const parts = [];
      parts.push(`sel ${fmt(metrics.totalGaSelect)}`);
      parts.push(`user ${fmt(metrics.totalGaUser)}`);
      parts.push(`cred ${fmt(metrics.totalGaCred)}`);
      parts.push(`visits ${fmt(metrics.totalSessions)}`);
      parts.push(`successful cardholders ${fmt(metrics.sessionsWithSuccessfulJobs)}`);
      totalsBar.innerHTML = `Totals (${fiCount} FIs): ${parts.join(" | ")}`;
      totalsBar.style.display = "";
    }

    // ‚îÄ‚îÄ‚îÄ Per-FI table rendering ‚îÄ‚îÄ‚îÄ
    const fiTablesSection = document.getElementById("fiTablesSection");
    const singleFiView = document.getElementById("singleFiView");
    const fiTableBodies = {};
    const fiGroupBlocks = {};
    const fiGroupHeaders = {};
    ["SSO", "NON-SSO", "CardSavr", "UNKNOWN"].forEach(key => {
      const block = fiTablesSection?.querySelector(`[data-group="${key}"]`);
      if (block) {
        fiGroupBlocks[key] = block;
        fiGroupHeaders[key] = block.querySelector(".group-header");
        fiTableBodies[key] = block.querySelector("tbody");
      }
    });

    const tableSortState = {};

    function getMonthlyReachValue(row) {
      const cardholders = row?.cardholders;
      if (!cardholders || cardholders <= 0) return 0;
      const dayCount = row.dayCount || dayCountInclusive(row.periodStart || row.start, row.periodEnd || row.end) || lastRenderContext?.daySpan || 1;
      const reachBase = row.ga_select > 0 ? row.ga_select : row.sessions;
      if (!reachBase || dayCount <= 0) return 0;
      const reachMonthly = reachBase * (30 / dayCount);
      return reachMonthly > 0 ? reachMonthly / cardholders : 0;
    }

    function formatMonthlyReachPct(row) {
      const value = getMonthlyReachValue(row);
      return value > 0 ? (value * 100).toFixed(1) + "%" : "";
    }

    function formatSessSuccessPct(row) {
      if (!row.sessions) return "";
      return (((row.sess_with_success || 0) / row.sessions) * 100).toFixed(1) + "%";
    }

    function formatSelSuccessPct(row) {
      const sel = row.cs_select || 0;
      if (!sel || !row.sess_with_success) return "";
      return ((row.sess_with_success / sel) * 100).toFixed(1) + "%";
    }

    function getSortValue(row, key) {
      switch (key) {
        case "fi": return (row.fi || "").toLowerCase();
        case "instances": return (row.instance || "").toLowerCase();
        case "integration": return (row.integration_type || "").toLowerCase();
        case "ga_select": return row.ga_select || 0;
        case "cs_select": return row.cs_select || 0;
        case "ga_user": return row.ga_user || 0;
        case "ga_cred": return row.ga_cred || 0;
        case "reach": return getMonthlyReachValue(row);
        case "sel_user_pct": return row.cs_select ? (row.cs_user || 0) / row.cs_select : 0;
        case "sel_cred_pct": return row.cs_select ? (row.cs_cred || 0) / row.cs_select : 0;
        case "sel_success_pct": return row.cs_select && row.sess_with_success ? row.sess_with_success / row.cs_select : 0;
        case "sessions": return row.sessions || 0;
        case "sess_with_success": return row.sess_with_success || 0;
        case "sess_success_pct": return row.sessions ? (row.sess_with_success || 0) / row.sessions : 0;
        case "placements": return row.placements || 0;
        default: return 0;
      }
    }

    function renderFiRow(row, integration) {
      const isSso = integration === "SSO";
      const instancesText = row.instance || (Array.isArray(row.instances) ? row.instances.join(", ") : "");
      const selUserPct = row.cs_select ? ((row.cs_user / row.cs_select) * 100).toFixed(1) + "%" : "";
      const selCredPct = row.cs_select ? ((row.cs_cred / row.cs_select) * 100).toFixed(1) + "%" : "";
      const selSuccPct = formatSelSuccessPct(row);
      const reachPct = formatMonthlyReachPct(row);
      const reachVal = getMonthlyReachValue(row);
      const reachCls = reachVal >= 0.025 ? " reach-good" : reachVal > 0 ? " reach-low" : "";
      const sessSuccPct = formatSessSuccessPct(row);

      const tr = document.createElement("tr");
      let cells = `
        <td>${row.fi}</td>
        <td>${instancesText}</td>
        <td>${integration}</td>
        <td class="num ga-col">${row.ga_select || 0}</td>
        <td class="num">${row.cs_select || 0}</td>`;
      if (!isSso) cells += `<td class="num ga-col">${row.ga_user || 0}</td>`;
      cells += `
        <td class="num ga-col">${row.ga_cred || 0}</td>
        <td class="num${reachCls}">${reachPct}</td>`;
      if (!isSso) cells += `<td class="num">${selUserPct}</td>`;
      cells += `
        <td class="num">${selCredPct}</td>
        <td class="num">${selSuccPct}</td>
        <td class="num">${row.sessions || 0}</td>
        <td class="num">${row.sess_with_success || 0}</td>
        <td class="num">${sessSuccPct}</td>
        <td class="num">${row.placements || 0}</td>`;
      tr.innerHTML = cells;
      return tr;
    }

    function buildFiTotalsRow(rows, integration) {
      if (!rows.length) return null;
      const isSso = integration === "SSO";
      const t = rows.reduce((acc, r) => {
        acc.ga_select += r.ga_select || 0;
        acc.cs_select += r.cs_select || 0;
        acc.ga_user += r.ga_user || 0;
        acc.ga_cred += r.ga_cred || 0;
        acc.cs_user += r.cs_user || 0;
        acc.cs_cred += r.cs_cred || 0;
        acc.sessions += r.sessions || 0;
        acc.sess_with_success += r.sess_with_success || 0;
        acc.placements += r.placements || 0;
        return acc;
      }, { ga_select: 0, cs_select: 0, ga_user: 0, ga_cred: 0, cs_user: 0, cs_cred: 0, sessions: 0, sess_with_success: 0, placements: 0 });

      const selUserPct = t.cs_select ? ((t.cs_user / t.cs_select) * 100).toFixed(1) + "%" : "";
      const selCredPct = t.cs_select ? ((t.cs_cred / t.cs_select) * 100).toFixed(1) + "%" : "";
      const selSuccPct = t.cs_select && t.sess_with_success ? ((t.sess_with_success / t.cs_select) * 100).toFixed(1) + "%" : "";
      const sessSuccPct = t.sessions ? ((t.sess_with_success / t.sessions) * 100).toFixed(1) + "%" : "";

      const tr = document.createElement("tr");
      tr.className = "totals-row";
      let cells = `
        <td>Total</td>
        <td>\u2014</td>
        <td>${integration}</td>
        <td class="num ga-col">${t.ga_select}</td>
        <td class="num">${t.cs_select}</td>`;
      if (!isSso) cells += `<td class="num ga-col">${t.ga_user}</td>`;
      cells += `
        <td class="num ga-col">${t.ga_cred}</td>
        <td class="num"></td>`;
      if (!isSso) cells += `<td class="num">${selUserPct}</td>`;
      cells += `
        <td class="num">${selCredPct}</td>
        <td class="num">${selSuccPct}</td>
        <td class="num">${t.sessions}</td>
        <td class="num">${t.sess_with_success}</td>
        <td class="num">${sessSuccPct}</td>
        <td class="num">${t.placements}</td>`;
      tr.innerHTML = cells;
      return tr;
    }

    function renderTables(visibleRows, startDate, endDate, daySpan) {
      if (!fiTablesSection) return;

      // Single-FI mode: show time breakdowns instead of integration-bucketed tables
      if (isSingleFiSelected()) {
        fiTablesSection.style.display = "none";
        if (singleFiView) {
          singleFiView.style.display = "";
          renderSingleFiSections(visibleRows, startDate, endDate, daySpan);
        }
        return;
      }

      // Multi-FI mode: hide single-FI view, show integration-bucketed tables
      if (singleFiView) singleFiView.style.display = "none";
      if (!visibleRows.length) { fiTablesSection.style.display = "none"; return; }
      fiTablesSection.style.display = "";

      // Bucket by integration type (no TEST bucket on customer page)
      const bucketed = { SSO: [], "NON-SSO": [], CardSavr: [], UNKNOWN: [] };
      visibleRows.forEach(row => {
        const integration = normalizeIntegrationLabel(row.integration_type || "UNKNOWN");
        row.integration_type = integration;
        // Skip test rows entirely
        if (integration === "TEST") return;
        const key = bucketed[integration] ? integration : "UNKNOWN";
        bucketed[key].push(row);
      });

      Object.entries(bucketed).forEach(([integration, rows]) => {
        const tbody = fiTableBodies[integration];
        if (!tbody) return;
        tbody.innerHTML = "";

        // Sort
        const state = tableSortState[integration];
        let sorted = rows;
        if (state && state.key) {
          const dir = state.dir === "desc" ? -1 : 1;
          sorted = [...rows].sort((a, b) => {
            const va = getSortValue(a, state.key);
            const vb = getSortValue(b, state.key);
            if (typeof va === "string") return dir * va.localeCompare(vb);
            return dir * (va - vb);
          });
        } else {
          sorted = [...rows].sort((a, b) => (b.ga_select || 0) - (a.ga_select || 0));
        }

        sorted.forEach(row => tbody.appendChild(renderFiRow(row, integration)));
        const totalsRow = buildFiTotalsRow(rows, integration);
        if (totalsRow) tbody.appendChild(totalsRow);

        const block = fiGroupBlocks[integration];
        if (block) block.style.display = rows.length ? "" : "none";
        const header = fiGroupHeaders[integration];
        if (header) header.textContent = rows.length ? `${integration} (${rows.length})` : integration;
      });

      // Attach sort handlers
      fiTablesSection.querySelectorAll("th[data-sort]").forEach(th => {
        if (th.__sortBound) return;
        th.__sortBound = true;
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          const table = th.closest("table");
          const group = table?.closest("[data-group]")?.getAttribute("data-group");
          if (!group) return;
          const prev = tableSortState[group];
          if (prev && prev.key === key) {
            tableSortState[group] = { key, dir: prev.dir === "asc" ? "desc" : "asc" };
          } else {
            tableSortState[group] = { key, dir: key === "fi" || key === "instances" ? "asc" : "desc" };
          }
          if (latestVisibleRows && lastRenderContext) {
            renderTables(latestVisibleRows, lastRenderContext.startDate, lastRenderContext.endDate, lastRenderContext.daySpan);
          }
        });
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ENGAGEMENT INSIGHTS ‚Äî Rendering Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const EI = window.EngagementInsights;
    let insightsCtx = null; // current metrics context for insights engine
    const isAdminUser = () => {
      const level = window.sisAuth?.getAccessLevel?.() || '';
      return level === 'admin' || level === 'full' || level === 'internal';
    };

    /**
     * Master function: evaluate and render all insight sections.
     * Called from applyFilters() after renderMetrics.
     */
    function renderInsights(metrics, startDate, endDate, daySpan, visibleRows, best) {
      if (!EI) { console.warn('[insights] engagement-insights.js not loaded'); return; }

      // Build metrics context
      insightsCtx = EI.buildMetricsContext(
        { metrics, best, startDate, endDate, daySpan },
        { registryMap, visibleRows, filterState: window.__FILTER_STATE }
      );

      // Need minimum data to show insights
      const hasData = insightsCtx.totalSessions > 0 || insightsCtx.gaSelect > 0;
      if (!hasData) {
        hideInsightsSections();
        return;
      }

      renderFunnelViz(insightsCtx);
      renderNarratives(insightsCtx);
      renderSpectrum(insightsCtx);
      renderActions(insightsCtx);
      renderProjections(insightsCtx);

      // QBR sections (only render when QBR mode is active)
      renderQBRSections(startDate, endDate);

      // Admin overlay
      if (isAdminUser()) {
        renderAdminOverlay(insightsCtx);
        const toggleBar = document.getElementById('adminToggleBar');
        if (toggleBar) toggleBar.style.display = 'flex';
      }
    }

    function hideInsightsSections() {
      ['funnelVizSection', 'narrativeSection', 'spectrumSection', 'actionsSection', 'projectionSection', 'qbrTrendSection', 'qbrNarrativeSection', 'qbrYoySection', 'qbrMonthlySection', 'qbrSummarySection', 'adminObjectionsSection', 'adminBenchmarkRefsSection'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
    }

    // ‚îÄ‚îÄ Funnel Visualization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function renderFunnelViz(ctx) {
      const container = document.getElementById('funnelViz');
      const section = document.getElementById('funnelVizSection');
      if (!container || !section) return;

      // When GA is hidden (SSO mode), use session starts as launches
      const gaHidden = document.body.classList.contains('hide-ga');
      const launchLabel = gaHidden ? 'Session Starts' : 'Launches';
      const launchValue = gaHidden ? ctx.totalSessions : ctx.gaSelect;

      const stages = gaHidden ? [
        // SSO mode: skip Launches (= visit starts), start from Visits pipeline
        { label: 'Visits', value: ctx.totalSessions, color: '#fff7ed', borderColor: '#fdba74', textColor: '#9a3412' },
        { label: 'Credential Entry', value: ctx.credSessions || ctx.gaCred, color: '#fef3c7', borderColor: '#fcd34d', textColor: '#92400e' },
        { label: 'Successful Cardholders', value: ctx.sessionsWithSuccess, color: '#dbeafe', borderColor: '#93c5fd', textColor: '#1e40af' },
        { label: 'Placements', value: ctx.successfulPlacements, color: '#dcfce7', borderColor: '#86efac', textColor: '#166534' },
      ] : [
        { label: 'Launches', value: ctx.gaSelect, color: '#ede9fe', borderColor: '#c4b5fd', textColor: '#5b21b6' },
        { label: 'Visits', value: ctx.totalSessions, color: '#fff7ed', borderColor: '#fdba74', textColor: '#9a3412' },
        { label: 'Credential Entry', value: ctx.credSessions || ctx.gaCred, color: '#fef3c7', borderColor: '#fcd34d', textColor: '#92400e' },
        { label: 'Successful Cardholders', value: ctx.sessionsWithSuccess, color: '#dbeafe', borderColor: '#93c5fd', textColor: '#1e40af' },
        { label: 'Placements', value: ctx.successfulPlacements, color: '#dcfce7', borderColor: '#86efac', textColor: '#166534' },
      ];

      // Calculate relative heights (min 30%, max 100%)
      const maxVal = Math.max(...stages.map(s => s.value || 0), 1);
      let html = '';

      // Map stage transitions to narrative scroll targets
      // Key = "FromLabel‚ÜíToLabel", value = data-insight-id prefix to scroll to
      const transitionTargets = {
        'Visits‚ÜíCredential Entry': 'selCred',
        'Credential Entry‚ÜíSuccessful Cardholders': 'credCompletion',
        'Successful Cardholders‚ÜíPlacements': 'avgCards',
      };

      stages.forEach((stage, i) => {
        const heightPct = Math.max(30, Math.round((stage.value / maxVal) * 100));

        if (i > 0 && stages[i - 1].value > 0) {
          const ratio = stage.value / stages[i - 1].value;
          const transKey = `${stages[i - 1].label}‚Üí${stage.label}`;
          const scrollTarget = transitionTargets[transKey] || null;
          let badge = '';
          if (ratio > 1.05) {
            const multiplier = ratio.toFixed(1);
            badge = `<div class="funnel-expansion">${multiplier}√ó cards per visit</div>`;
          } else if (ratio >= 0.95) {
            badge = `<div class="funnel-neutral">Strong follow-through</div>`;
          } else {
            const dropPct = (1 - ratio) * 100;
            let dropClass = 'dropoff-green';
            if (dropPct > 80) dropClass = 'dropoff-red';
            else if (dropPct > 50) dropClass = 'dropoff-yellow';
            // Contextual label based on transition
            let dropLabel;
            if (stage.label === 'Credential Entry') {
              dropLabel = `${dropPct.toFixed(0)}% browse but don't start`;
            } else if (stage.label === 'Successful Cardholders') {
              dropLabel = `${dropPct.toFixed(0)}% start but don't finish`;
            } else {
              dropLabel = `${dropPct.toFixed(0)}% conversion opportunity`;
            }
            badge = `<div class="funnel-dropoff ${dropClass}">${dropLabel}</div>`;
          }
          const insightLink = scrollTarget
            ? `<a class="funnel-insight-link" onclick="scrollToInsight('${scrollTarget}')">See insights ‚Üí</a>`
            : '';
          html += `<div class="funnel-arrow">
            <div style="text-align:center;">
              <div style="color:#94a3b8;">‚Üí</div>
              ${badge}
              ${insightLink}
            </div>
          </div>`;
        } else if (i > 0) {
          html += `<div class="funnel-arrow"><div style="text-align:center;"><div style="color:#94a3b8;">‚Üí</div></div></div>`;
        }

        html += `<div class="funnel-stage">
          <div class="stage-bar" style="background:${stage.color};border:1px solid ${stage.borderColor};height:${heightPct}%;min-height:60px;">
            <div class="stage-label" style="color:${stage.textColor};">${stage.label}</div>
            <div class="stage-value" style="color:${stage.textColor};">${EI.fmtN(stage.value)}</div>
          </div>
        </div>`;
      });

      container.innerHTML = html;
      section.style.display = '';
    }

    // ‚îÄ‚îÄ Narrative Blocks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function renderNarratives(ctx) {
      const container = document.getElementById('narrativeBlocks');
      const section = document.getElementById('narrativeSection');
      if (!container || !section) return;

      const narratives = EI.evaluateNarratives(ctx);
      if (!narratives.length) { section.style.display = 'none'; return; }

      let html = '';
      for (const n of narratives) {
        html += `<div class="insight-block" data-insight-id="${n.id}">`;
        html += `<div class="insight-label">${getSectionLabel(n.section)}</div>`;
        html += `<div>${n.html}</div>`;

        // Benchmark references
        if (n.benchmarkKeys.length > 0) {
          const benchmarks = EI.getBenchmarkDisplay(n.benchmarkKeys);
          if (benchmarks.length > 0) {
            html += `<div class="benchmark-ref">`;
            for (const b of benchmarks) {
              html += `<strong>${b.value}</strong> ‚Äî ${b.description}`;
              if (b.proof) html += ` <span style="color:#94a3b8;">(${b.proof})</span>`;
              html += `<br>`;
            }
            html += `</div>`;
          }
        }

        // Filter hint
        if (n.filterHint) {
          const hintData = escapeHtml(JSON.stringify(JSON.stringify(n.filterHint)));
          html += `<div class="filter-hint" onclick="applyInsightFilter(${hintData})">${n.filterHint.text}</div>`;
          if (n.filterHint.secondaryLink) {
            html += `<div class="filter-hint-secondary"><a href="${escapeHtml(n.filterHint.secondaryLink.url)}" target="_blank" rel="noopener">‚Üó ${escapeHtml(n.filterHint.secondaryLink.text)}</a></div>`;
          }
        }

        html += `</div>`;
      }

      container.innerHTML = html;
      section.style.display = '';
    }

    function getSectionLabel(section) {
      const labels = {
        headline: 'Cardholder Performance',
        conversion: 'Conversion Funnel',
        outcomes: 'Placement Depth',
        reach: 'Member Reach',
        completion: 'Credential Completion',
        potential: 'Performance Ceiling',
      };
      return labels[section] || section;
    }

    /** Apply action from insight hint ‚Äî filter, scroll, or navigate */
    function applyInsightFilter(hintJson) {
      try {
        const hint = JSON.parse(hintJson);
        const action = hint.action || 'filter';

        if (action === 'scroll') {
          // Scroll to a target section and highlight it
          const target = document.getElementById(hint.scrollTarget);
          if (!target) return;
          const y = target.getBoundingClientRect().top + window.scrollY - 80;
          window.scrollTo({ top: y, behavior: 'smooth' });
          // Apply highlight effect after scroll settles
          setTimeout(() => {
            target.classList.add('scroll-highlight');
            target.addEventListener('animationend', () => {
              target.classList.remove('scroll-highlight');
              target.classList.add('scroll-highlight-fade');
              setTimeout(() => target.classList.remove('scroll-highlight-fade'), 700);
            }, { once: true });
          }, 400);
          return;
        }

        // action === 'filter'
        const filters = hint.filters || {};

        // Date range filter
        if (filters.dateFrom && filters.dateTo) {
          startDateInput.value = filters.dateFrom;
          endDateInput.value = filters.dateTo;
          const preset = document.getElementById('datePreset');
          if (preset) preset.value = '';
          safeApplyFilters();
          return;
        }

        // Integration (or other) filter ‚Äî update dropdown state then recalculate
        if (filters.integration && typeof window.__FILTER_SET === 'function') {
          window.__FILTER_SET({ integration: filters.integration });
          // __FILTER_SET updates dropdown UI + filter state; now do a full recalculation
          startLoading('Filtering‚Ä¶');
          safeApplyFilters().finally(() => stopLoading());
          return;
        }

        // Fallback
        safeApplyFilters();
      } catch (e) { console.warn('[insights] filter hint error:', e); }
    }

    /** Scroll to the first matching insight block and highlight it prominently */
    function scrollToInsight(idPrefix) {
      // Clear any previous highlight
      const prev = document.querySelector('.insight-block.highlight, .insight-block.highlight-fade');
      if (prev) { prev.classList.remove('highlight', 'highlight-fade'); }

      const block = document.querySelector(`.insight-block[data-insight-id^="${idPrefix}"]`);
      if (!block) return;

      // Scroll with offset so card isn't jammed at viewport top
      const y = block.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top: y, behavior: 'smooth' });

      // Apply highlight after a short delay to let scroll settle
      setTimeout(() => {
        block.classList.add('highlight');
        block.addEventListener('animationend', () => {
          block.classList.remove('highlight');
          block.classList.add('highlight-fade');
          setTimeout(() => block.classList.remove('highlight-fade'), 700);
        }, { once: true });
      }, 100);
    }

    // ‚îÄ‚îÄ Motivation Spectrum ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function renderSpectrum(ctx) {
      const gauge = document.getElementById('spectrumGauge');
      const diagEl = document.getElementById('spectrumDiagnosis');
      const section = document.getElementById('spectrumSection');
      if (!gauge || !section) return;

      if (ctx.sessionSuccessPct === null) { section.style.display = 'none'; return; }

      // Build gauge zones (proportional widths on a 0‚Äì30% scale)
      const maxScale = 30;
      const zones = [
        { label: 'Tier 3: Incidental', min: 0, max: 3, color: '#ef4444' },
        { label: '‚ü∂', min: 3, max: 8, color: '#f97316' },
        { label: 'Tier 2: Campaigns', min: 8, max: 12, color: '#eab308' },
        { label: '‚ü∂', min: 12, max: 21, color: '#84cc16' },
        { label: 'Tier 1: Activation', min: 21, max: 30, color: '#22c55e' },
      ];

      let gaugeHtml = '';
      for (const z of zones) {
        const widthPct = ((z.max - z.min) / maxScale) * 100;
        gaugeHtml += `<div class="spectrum-zone" style="width:${widthPct}%;background:${z.color};">${z.label}</div>`;
      }

      // Current rate marker
      const currentPos = Math.min(ctx.sessionSuccessPct / maxScale, 1) * 100;
      gaugeHtml += `<div class="spectrum-marker" style="left:${currentPos}%;" data-label="Current: ${EI.fmt(ctx.sessionSuccessPct)}%"></div>`;

      // Best week marker
      if (ctx.bestWeekRate && ctx.bestWeekRate > ctx.sessionSuccessPct * 1.1) {
        const bestPos = Math.min(ctx.bestWeekRate / maxScale, 1) * 100;
        gaugeHtml += `<div class="spectrum-marker best-marker" style="left:${bestPos}%;" data-label="Best: ${EI.fmt(ctx.bestWeekRate)}%"></div>`;
      }

      gauge.innerHTML = gaugeHtml;

      // Diagnosis paragraph
      const diag = EI.buildSpectrumDiagnosis(ctx);
      if (diagEl) diagEl.innerHTML = diag.html;

      section.style.display = '';
    }

    // ‚îÄ‚îÄ Prescriptive Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function copyLibraryExample(btn) {
      const text = btn.getAttribute('data-copy');
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = '\u{2713} Copied!';
        btn.classList.add('copy-success');
        setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copy-success'); }, 1500);
      }).catch(() => {});
    }

    function toggleLibraryDrawer(actionIdx) {
      const allDrawers = document.querySelectorAll('.action-library-drawer');
      const allToggles = document.querySelectorAll('.library-toggle');
      const drawer = document.getElementById('library-drawer-' + actionIdx);
      const toggle = document.getElementById('library-toggle-' + actionIdx);
      if (!drawer) return;

      const isOpen = drawer.classList.contains('open');

      // Close all (accordion)
      allDrawers.forEach(d => d.classList.remove('open'));
      allToggles.forEach(t => t.classList.remove('open'));

      // Open this one if it was closed
      if (!isOpen) {
        drawer.classList.add('open');
        if (toggle) toggle.classList.add('open');
      }
    }

    function buildLibraryDrawerHtml(entry, actionIdx, allActions) {
      if (!entry || !entry.channels || !entry.channels.length) return '';

      const meta = EI.ACTION_LIBRARY._meta || {};
      const stats = EI.getLibraryStats(entry);
      const previewChannels = entry.channels.slice(0, 2);

      let drawerContent = '';

      // Section description (context for this channel category)
      const sectionInfo = EI.getPlaybookSection ? EI.getPlaybookSection(entry.playbookSection) : null;
      if (sectionInfo) {
        drawerContent += `<div class="library-section-intro"><strong>${escapeHtml(sectionInfo.title)}</strong> ‚Äî ${escapeHtml(sectionInfo.description)}</div>`;
      }

      // Shared-with note
      if (entry._sharedFrom) {
        // Find the action headline that this shares with
        const sharedAction = allActions.find(a => {
          const lib = EI.getLibraryEntry(a.ruleId, a.actionIndex);
          return lib && !lib._sharedFrom && lib === EI.ACTION_LIBRARY[entry._sharedFrom];
        });
        if (sharedAction) {
          drawerContent += `<div class="library-shared-note">Same resources as "${sharedAction.headline}"</div>`;
        }
      }

      for (const ch of previewChannels) {
        const previewExamples = ch.examples.slice(0, 2);
        drawerContent += `<div class="library-channel-header"><span>${ch.icon}</span> ${escapeHtml(ch.channel)}</div>`;
        for (const ex of previewExamples) {
          // Build copy text: email gets "Subject: headline\n\nbody", SMS gets body only
          const isEmail = ch.channel.toLowerCase().includes('email');
          const isSMS = ch.channel.toLowerCase().includes('sms');
          let copyText = '';
          if (isEmail && ex.headline) {
            copyText = 'Subject: ' + ex.headline + '\n\n' + ex.body;
          } else if (isSMS || !ex.headline) {
            copyText = ex.body;
          } else {
            copyText = (ex.headline ? ex.headline + '\n\n' : '') + ex.body;
          }

          drawerContent += `<div class="library-example">`;
          if (ex.headline) drawerContent += `<div class="library-example-headline">${escapeHtml(ex.headline)}</div>`;
          drawerContent += `<div class="library-example-body">${escapeHtml(ex.body)}</div>`;
          const safeAttr = escapeHtml(copyText).replace(/\n/g, '&#10;');
          drawerContent += `<button class="library-copy-btn" data-copy="${safeAttr}" onclick="copyLibraryExample(this)">\u{1F4CB} Copy</button>`;
          drawerContent += `</div>`;
        }
      }

      // Footer with playbook link and version
      drawerContent += `<div class="library-footer">`;
      if (stats) {
        const section = entry.playbookSection || '';
        drawerContent += `<a class="library-playbook-link" href="/resources/engagement-playbook${section ? '#' + section : ''}" target="_blank">See all ${stats.totalChannels} channels and ${stats.totalExamples} examples in the full playbook \u2192</a>`;
      }
      if (meta.version) {
        drawerContent += `<span class="library-version">Playbook v${meta.version}</span>`;
      }
      drawerContent += `</div>`;

      return drawerContent;
    }

    function renderActions(ctx) {
      const list = document.getElementById('actionsList');
      const section = document.getElementById('actionsSection');
      if (!list || !section) return;

      const { actions } = EI.evaluateActions(ctx);
      if (!actions.length) { section.style.display = 'none'; return; }

      const isAdmin = isAdminUser();

      let html = '';
      actions.forEach((action, i) => {
        const entry = EI.getLibraryEntry(action.ruleId, action.actionIndex);
        const hasLibrary = entry && entry.channels && entry.channels.length > 0;
        const stats = hasLibrary ? EI.getLibraryStats(entry) : null;

        html += `<li class="action-item" style="flex-wrap:wrap;">
          <div class="action-priority ${action.impact}">${i + 1}</div>
          <div class="action-body">
            <div class="action-headline">${action.headline}</div>
            <div class="action-detail">${action.detail}</div>`;

        // Admin library status annotation
        if (isAdmin && stats) {
          html += `<div class="admin-overlay"><span class="admin-library-status">Library: ${stats.totalChannels} channels, ${stats.totalExamples} examples | Playbook section: ${entry.playbookSection || 'none'}</span></div>`;
        }

        // Library toggle button (only if entry has content)
        if (hasLibrary) {
          html += `<button class="library-toggle" id="library-toggle-${i}" onclick="toggleLibraryDrawer(${i})">How to implement <span class="toggle-arrow">\u25BE</span></button>`;
        }

        html += `</div>`; // close action-body

        // Library drawer (hidden by default)
        if (hasLibrary) {
          html += `<div class="action-library-drawer" id="library-drawer-${i}" style="flex-basis:100%;">`;
          html += buildLibraryDrawerHtml(entry, i, actions);
          html += `</div>`;
        }

        html += `</li>`;
      });

      list.innerHTML = html;
      section.style.display = '';
    }

    // ‚îÄ‚îÄ Value Projection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function renderProjections(ctx) {
      const container = document.getElementById('projectionContent');
      const section = document.getElementById('projectionSection');
      if (!container || !section) return;

      const { current, scenarios } = EI.computeProjections(ctx);
      if (!scenarios.length || current.sessions < 10) { section.style.display = 'none'; return; }

      let html = `<table class="projection-table">
        <thead><tr>
          <th>Scenario</th>
          <th class="num">Success Rate</th>
          <th class="num">Projected Placements</th>
          <th class="num">vs Current</th>
        </tr></thead>
        <tbody>
        <tr class="current-row">
          <td>Current performance</td>
          <td class="num">${current.successRate !== null ? EI.fmt(current.successRate) + '%' : '‚Äî'}</td>
          <td class="num">${EI.fmtN(current.placements)}</td>
          <td class="num">‚Äî</td>
        </tr>`;

      for (const s of scenarios) {
        const multiplierStr = s.multiplier && s.multiplier > 1
          ? `<span class="multiplier">${EI.fmt(s.multiplier)}√ó</span>`
          : '‚Äî';
        html += `<tr class="scenario-row">
          <td>${s.label}</td>
          <td class="num">${EI.fmt(s.rate)}%</td>
          <td class="num">~${EI.fmtN(s.projectedPlacements)}</td>
          <td class="num">${multiplierStr}</td>
        </tr>`;
      }

      html += `</tbody></table>`;
      html += `<div class="projection-note">Projections based on current volume of ${EI.fmtN(current.sessions)} CardUpdatr visits over ${current.days} days. Actual results depend on traffic quality and cardholder motivation.</div>`;

      container.innerHTML = html;
      section.style.display = '';
    }

    // ‚îÄ‚îÄ QBR Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    /**
     * Build SVG sparkline from data points.
     */
    function buildSparklineSVG(values, opts = {}) {
      const { width = 140, height = 36, color = '#2563eb' } = opts;
      const valid = (values || []).filter(v => v !== null && v !== undefined && !isNaN(v));
      if (valid.length < 2) return '';
      const min = Math.min(...valid);
      const max = Math.max(...valid);
      const range = max - min || 1;
      const pad = 4;
      const points = valid.map((v, i) => {
        const x = pad + (i / (valid.length - 1)) * (width - 2 * pad);
        const y = height - pad - ((v - min) / range) * (height - 2 * pad);
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      });
      const last = points[points.length - 1].split(',');
      return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
        <polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="${last[0]}" cy="${last[1]}" r="3" fill="${color}"/>
      </svg>`;
    }

    /**
     * Build quarterly data for QBR mode.
     * Aggregates data per-quarter across visible FIs.
     */
    function buildQBRQuarterlyData(startDate, endDate) {
      const quarters = [];
      const startDt = parseDateUtc(startDate);
      const endDt = parseDateUtc(endDate);
      let cursor = new Date(Date.UTC(startDt.getUTCFullYear(), Math.floor(startDt.getUTCMonth() / 3) * 3, 1));

      while (cursor <= endDt) {
        const qStart = formatDateUtc(cursor);
        const qNum = Math.floor(cursor.getUTCMonth() / 3) + 1;
        const qYear = cursor.getUTCFullYear();
        const qEnd = formatDateUtc(new Date(Date.UTC(qYear, qNum * 3, 0)));

        if (qEnd >= startDate && qStart <= endDate) {
          const cardholderMap = getCardholderMap();
          const perFi = aggregateData(qStart, qEnd, cardholderMap);
          const qVisibleRows = getVisibleRows(perFi);
          const qDaySpan = dayCountInclusive(qStart, qEnd);
          const qMetrics = calculateMetrics(qStart, qEnd, qVisibleRows);

          // Stamp rows for reach calc
          qVisibleRows.forEach(row => { row.periodStart = qStart; row.periodEnd = qEnd; row.dayCount = qDaySpan; });

          const qCtx = EI.buildMetricsContext(
            { metrics: qMetrics, startDate: qStart, endDate: qEnd, daySpan: qDaySpan },
            { registryMap, visibleRows: qVisibleRows, filterState: window.__FILTER_STATE }
          );
          const qTierInfo = EI.classifyTier(qCtx.sessionSuccessPct);

          quarters.push({
            quarter: `Q${qNum} ${qYear}`,
            startDate: qStart,
            endDate: qEnd,
            metrics: qCtx,
            rawMetrics: qMetrics,
            visibleRows: qVisibleRows,
            daySpan: qDaySpan,
            tierInfo: qTierInfo,
          });
        }
        cursor = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth() + 3, 1));
      }
      return quarters;
    }

    /**
     * Render the four-quarter trend table.
     */
    function renderQBRTrendTable(quartersData) {
      const container = document.getElementById('qbrTrendTable');
      const section = document.getElementById('qbrTrendSection');
      if (!container || !section || !quartersData.length) { if (section) section.style.display = 'none'; return; }

      const metricRows = [
        { label: 'Total Visits', key: 'totalSessions', format: 'n', pctChange: true },
        { label: 'Credential Entry Rate', key: 'selCredPct', format: '%' },
        { label: 'Cardholder Success Rate', key: 'sessionSuccessPct', format: '%' },
        { label: 'Successful Placements', key: 'successfulPlacements', format: 'n', pctChange: true },
        { label: 'Avg Cards Per Cardholder', key: 'avgCardsPerSession', format: 'd' },
        { label: 'Monthly Reach', key: 'monthlyReachPct', format: '%' },
        { label: 'Motivation Tier', key: '__tier', format: 'tier' },
      ];

      let html = `<table class="qbr-trend-table"><thead><tr><th>Metric</th>`;
      for (const q of quartersData) html += `<th>${q.quarter}</th>`;
      if (quartersData.length >= 2) html += `<th>QoQ Change</th>`;
      html += `<th>Trend</th></tr></thead><tbody>`;

      for (const mr of metricRows) {
        html += `<tr><td>${mr.label}</td>`;
        const values = [];
        for (const q of quartersData) {
          const m = q.metrics;
          let val, display;
          if (mr.key === '__tier') {
            val = m.sessionSuccessPct;
            display = q.tierInfo ? q.tierInfo.label : '‚Äî';
          } else {
            val = m[mr.key];
            if (mr.format === '%') display = val !== null && val !== undefined ? EI.fmt(val) + '%' : '‚Äî';
            else if (mr.format === 'n') display = val !== null && val !== undefined ? EI.fmtN(val) : '‚Äî';
            else if (mr.format === 'd') display = val !== null && val !== undefined ? EI.fmt(val) : '‚Äî';
            else display = val !== null && val !== undefined ? String(val) : '‚Äî';
          }
          values.push(mr.key === '__tier' ? val : val);
          html += `<td>${display}</td>`;
        }

        // QoQ change (last two quarters)
        if (quartersData.length >= 2) {
          const prev = values[values.length - 2];
          const curr = values[values.length - 1];
          if (mr.key === '__tier') {
            html += `<td>‚Äî</td>`;
          } else if (mr.format === '%') {
            const pp = EI.computeQoQChangePP(curr, prev);
            if (pp !== null) {
              const cls = pp > 0.5 ? 'trend-up' : pp < -0.5 ? 'trend-down' : 'trend-flat';
              html += `<td class="${cls}">${pp > 0 ? '+' : ''}${EI.fmt(pp)}pp</td>`;
            } else { html += `<td>‚Äî</td>`; }
          } else if (mr.pctChange) {
            const pct = EI.computeQoQChange(curr, prev);
            if (pct !== null) {
              const cls = pct > 5 ? 'trend-up' : pct < -5 ? 'trend-down' : 'trend-flat';
              html += `<td class="${cls}">${pct > 0 ? '+' : ''}${EI.fmt(pct)}%</td>`;
            } else { html += `<td>‚Äî</td>`; }
          } else {
            html += `<td>‚Äî</td>`;
          }
        }

        // Trend indicator
        if (mr.key === '__tier') {
          const tiers = quartersData.map(q => EI.classifyTier(q.metrics.sessionSuccessPct).tier);
          const improving = tiers.length >= 2 && tiers[tiers.length - 1] < tiers[0];
          const stuck = tiers.every(t => t === tiers[0]);
          if (improving) html += `<td class="trend-up">\u25B2 improving</td>`;
          else if (stuck) html += `<td class="trend-flat">\u2014 ${tiers[0] === 3 ? 'stuck' : 'stable'}</td>`;
          else html += `<td class="trend-flat">\u2194 mixed</td>`;
        } else {
          const numVals = values.filter(v => v !== null && v !== undefined);
          const trend = EI.classifyTrend(numVals);
          if (trend === 'improving') html += `<td class="trend-up">\u25B2 improving</td>`;
          else if (trend === 'declining') html += `<td class="trend-down">\u25BC declining</td>`;
          else if (trend === 'stable') html += `<td class="trend-flat">\u2014 stable</td>`;
          else html += `<td class="trend-flat">\u2194 mixed</td>`;
        }
        html += `</tr>`;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
      section.style.display = '';
    }

    /**
     * Render sparklines for key metrics.
     */
    function renderQBRSparklines(quartersData) {
      const container = document.getElementById('qbrSparklines');
      if (!container || quartersData.length < 2) return;

      const sparklines = [
        { label: 'Cardholder Success %', values: quartersData.map(q => q.metrics.sessionSuccessPct), color: '#2563eb' },
        { label: 'Visits', values: quartersData.map(q => q.metrics.totalSessions), color: '#f59e0b' },
        { label: 'Placements', values: quartersData.map(q => q.metrics.successfulPlacements), color: '#16a34a' },
        { label: 'Monthly Reach %', values: quartersData.map(q => q.metrics.monthlyReachPct), color: '#8b5cf6' },
      ];

      let html = '<div class="qbr-sparkline-row">';
      for (const s of sparklines) {
        const svg = buildSparklineSVG(s.values, { color: s.color });
        if (svg) {
          const vals = s.values.filter(v => v !== null);
          const latest = vals.length > 0 ? vals[vals.length - 1] : null;
          html += `<div class="qbr-sparkline-item">
            <div class="qbr-sparkline-label">${s.label}</div>
            ${svg}
            <div style="font-size:11px;color:${s.color};font-weight:700;margin-top:2px;">${latest !== null ? (s.label.includes('%') ? EI.fmt(latest) + '%' : EI.fmtN(latest)) : '‚Äî'}</div>
          </div>`;
        }
      }
      html += '</div>';
      container.innerHTML = html;
    }

    /**
     * Render QBR narrative blocks.
     */
    function renderQBRNarratives(qbrNarratives) {
      const container = document.getElementById('qbrNarrativeBlocks');
      const section = document.getElementById('qbrNarrativeSection');
      if (!container || !section) return;
      if (!qbrNarratives || !qbrNarratives.length) { section.style.display = 'none'; return; }

      const sectionLabels = {
        trend: 'Trailing Year Trend',
        highlight: 'Quarter Highlight',
        divergence: 'Volume vs Conversion',
        tier: 'Motivation Tier Movement',
        outcome: 'Placement Outcomes',
      };

      let html = '';
      for (const n of qbrNarratives) {
        html += `<div class="insight-block" data-insight-id="${n.id}">`;
        html += `<div class="insight-label">${sectionLabels[n.section] || n.section}</div>`;
        html += `<div>${n.html}</div>`;
        html += `</div>`;
      }
      container.innerHTML = html;
      section.style.display = '';
    }

    /**
     * Render YoY comparison if data available.
     * This requires checking if we have the same quarter from the prior year.
     */
    function renderQBRYoY(quartersData) {
      const section = document.getElementById('qbrYoySection');
      const container = document.getElementById('qbrYoyContent');
      if (!section || !container) return;

      // Look for YoY: the latest quarter vs same quarter last year
      if (quartersData.length < 4) { section.style.display = 'none'; return; }
      const latest = quartersData[quartersData.length - 1];
      const latestQ = latest.quarter; // e.g. "Q4 2025"
      const match = latestQ.match(/Q(\d) (\d{4})/);
      if (!match) { section.style.display = 'none'; return; }
      const qNum = parseInt(match[1]);
      const qYear = parseInt(match[2]);
      const priorYearLabel = `Q${qNum} ${qYear - 1}`;

      // Check if we can aggregate the prior year quarter from dailyData
      const priorStart = `${qYear - 1}-${String((qNum - 1) * 3 + 1).padStart(2, '0')}-01`;
      const priorEnd = formatDateUtc(new Date(Date.UTC(qYear - 1, qNum * 3, 0)));

      // Check if we have any daily data for the prior year quarter
      const priorDays = Object.keys(dailyData).filter(d => d >= priorStart && d <= priorEnd);
      if (priorDays.length === 0) { section.style.display = 'none'; return; }

      // Aggregate prior year quarter data
      const cardholderMap = getCardholderMap();
      const priorPerFi = aggregateData(priorStart, priorEnd, cardholderMap);
      const priorVisibleRows = getVisibleRows(priorPerFi);
      const priorDaySpan = dayCountInclusive(priorStart, priorEnd);
      const priorMetrics = calculateMetrics(priorStart, priorEnd, priorVisibleRows);
      priorVisibleRows.forEach(row => { row.periodStart = priorStart; row.periodEnd = priorEnd; row.dayCount = priorDaySpan; });
      const priorCtx = EI.buildMetricsContext(
        { metrics: priorMetrics, startDate: priorStart, endDate: priorEnd, daySpan: priorDaySpan },
        { registryMap, visibleRows: priorVisibleRows, filterState: window.__FILTER_STATE }
      );

      const m = latest.metrics;
      const p = priorCtx;

      const rows = [
        { label: 'Cardholder Success', curr: m.sessionSuccessPct, prev: p.sessionSuccessPct, format: '%', pp: true },
        { label: 'Placements', curr: m.successfulPlacements, prev: p.successfulPlacements, format: 'n' },
        { label: 'Visits', curr: m.totalSessions, prev: p.totalSessions, format: 'n' },
        { label: 'Credential Entry Rate', curr: m.selCredPct, prev: p.selCredPct, format: '%', pp: true },
      ];

      let html = `<div class="qbr-yoy-callout">`;
      html += `<div class="yoy-title">Year-over-Year: ${priorYearLabel} \u2192 ${latestQ}</div>`;
      for (const r of rows) {
        const arrow = (r.curr || 0) > (r.prev || 0) ? '\u25B2' : (r.curr || 0) < (r.prev || 0) ? '\u25BC' : '\u2014';
        const cls = (r.curr || 0) > (r.prev || 0) ? 'trend-up' : (r.curr || 0) < (r.prev || 0) ? 'trend-down' : 'trend-flat';
        let change = '';
        if (r.pp) {
          const pp = EI.computeQoQChangePP(r.curr, r.prev);
          change = pp !== null ? `(${pp > 0 ? '+' : ''}${EI.fmt(pp)}pp)` : '';
        } else {
          const pct = EI.computeQoQChange(r.curr, r.prev);
          change = pct !== null ? `(${pct > 0 ? '+' : ''}${EI.fmt(pct)}%)` : '';
        }
        const fmtVal = r.format === '%'
          ? (v) => v !== null && v !== undefined ? EI.fmt(v) + '%' : '‚Äî'
          : (v) => v !== null && v !== undefined ? EI.fmtN(v) : '‚Äî';
        html += `<div class="yoy-row">${r.label}: ${fmtVal(r.prev)} \u2192 ${fmtVal(r.curr)} <span class="${cls}">${arrow} ${change}</span></div>`;
      }

      // YoY narrative
      const yoyNarrative = EI.buildYoYNarrative(latestQ, m.sessionSuccessPct, p.sessionSuccessPct);
      if (yoyNarrative) {
        html += `<div style="margin-top:8px;font-size:13px;color:#0369a1;">${yoyNarrative}</div>`;
      }

      html += `</div>`;
      container.innerHTML = html;
      section.style.display = '';
    }

    /**
     * Render monthly breakdown within the most recent QBR quarter.
     */
    function renderQBRMonthlyDetail(quartersData) {
      const section = document.getElementById('qbrMonthlySection');
      const container = document.getElementById('qbrMonthlyContent');
      if (!section || !container || !quartersData.length) { if (section) section.style.display = 'none'; return; }

      const latest = quartersData[quartersData.length - 1];
      const qStart = parseDateUtc(latest.startDate);
      const months = [];

      for (let mo = 0; mo < 3; mo++) {
        const mStart = formatDateUtc(new Date(Date.UTC(qStart.getUTCFullYear(), qStart.getUTCMonth() + mo, 1)));
        const mEnd = formatDateUtc(new Date(Date.UTC(qStart.getUTCFullYear(), qStart.getUTCMonth() + mo + 1, 0)));
        if (mEnd < latest.startDate || mStart > latest.endDate) continue;

        const cardholderMap = getCardholderMap();
        const mPerFi = aggregateData(mStart, mEnd, cardholderMap);
        const mVisible = getVisibleRows(mPerFi);
        const mDaySpan = dayCountInclusive(mStart, mEnd);
        const mMetrics = calculateMetrics(mStart, mEnd, mVisible);
        mVisible.forEach(row => { row.periodStart = mStart; row.periodEnd = mEnd; row.dayCount = mDaySpan; });
        const mCtx = EI.buildMetricsContext(
          { metrics: mMetrics, startDate: mStart, endDate: mEnd, daySpan: mDaySpan },
          { registryMap, visibleRows: mVisible, filterState: window.__FILTER_STATE }
        );

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'];
        const mDate = parseDateUtc(mStart);
        months.push({
          label: monthNames[mDate.getUTCMonth()],
          metrics: mCtx,
        });
      }

      if (!months.length) { section.style.display = 'none'; return; }

      let html = `<table class="qbr-monthly-table"><thead><tr>
        <th>Month</th><th>Visits</th><th>Cred Entry %</th><th>Success Rate</th><th>Placements</th>
      </tr></thead><tbody>`;

      let totalSessions = 0, totalPlacements = 0;
      for (const mo of months) {
        const m = mo.metrics;
        totalSessions += m.totalSessions;
        totalPlacements += m.successfulPlacements;
        html += `<tr>
          <td>${mo.label}</td>
          <td>${EI.fmtN(m.totalSessions)}</td>
          <td>${m.selCredPct !== null ? EI.fmt(m.selCredPct) + '%' : '‚Äî'}</td>
          <td>${m.sessionSuccessPct !== null ? EI.fmt(m.sessionSuccessPct) + '%' : '‚Äî'}</td>
          <td>${EI.fmtN(m.successfulPlacements)}</td>
        </tr>`;
      }

      // Totals row
      const totalRate = totalSessions > 0 ? (totalPlacements / totalSessions * 100) : null;
      html += `<tr class="totals-row">
        <td>${latest.quarter} Total</td>
        <td>${EI.fmtN(totalSessions)}</td>
        <td>‚Äî</td>
        <td>${totalRate !== null ? EI.fmt(latest.metrics.sessionSuccessPct) + '%' : '‚Äî'}</td>
        <td>${EI.fmtN(totalPlacements)}</td>
      </tr></tbody></table>`;

      // Intra-quarter narrative
      if (months.length >= 2) {
        const rates = months.map(m => m.metrics.sessionSuccessPct).filter(r => r !== null);
        if (rates.length >= 2) {
          const bestIdx = rates.indexOf(Math.max(...rates));
          const bestMonth = months[bestIdx];
          const monthlyNarrative = EI.buildMonthlyNarrative(latest.quarter, {
            label: bestMonth.label,
            sessionSuccessPct: bestMonth.metrics.sessionSuccessPct,
          });
          if (monthlyNarrative) {
            html += `<div class="qbr-intra-narrative">${monthlyNarrative}</div>`;
          }
        }
      }

      container.innerHTML = html;
      section.style.display = '';
    }

    /**
     * Render QBR executive summary.
     */
    function renderQBRExecutiveSummary(quartersData, qbrNarratives) {
      const section = document.getElementById('qbrSummarySection');
      const container = document.getElementById('qbrSummaryContent');
      if (!section || !container || !quartersData.length) { if (section) section.style.display = 'none'; return; }

      const latest = quartersData[quartersData.length - 1];
      // Find best quarter rate for QBR-mode projections
      let bestQRate = null;
      for (const q of quartersData) {
        const r = q.metrics.sessionSuccessPct;
        if (r !== null && (bestQRate === null || r > bestQRate)) bestQRate = r;
      }
      const projections = EI.computeProjections(latest.metrics, { qbrBestQuarterRate: bestQRate });
      const summaryHtml = EI.buildQBRSummary(quartersData, qbrNarratives, projections);

      if (!summaryHtml) { section.style.display = 'none'; return; }
      container.innerHTML = summaryHtml;
      section.style.display = '';
    }

    /**
     * Master QBR render function. Called from renderInsights when QBR mode is active.
     */
    function renderQBRSections(startDate, endDate) {
      const isQBR = document.body.classList.contains('qbr-mode');
      const qbrSections = document.querySelectorAll('.qbr-section');

      if (!isQBR) {
        qbrSections.forEach(el => el.style.display = 'none');
        window.__qbrQuartersData = null;
        window.__qbrNarratives = null;
        return;
      }

      const quartersData = buildQBRQuarterlyData(startDate, endDate);
      if (!quartersData.length) {
        qbrSections.forEach(el => el.style.display = 'none');
        return;
      }

      // Store for PDF payload and event logging
      window.__qbrQuartersData = quartersData;

      // Render sections
      renderQBRTrendTable(quartersData);
      renderQBRSparklines(quartersData);

      const qbrNarratives = EI.evaluateQBRNarratives(quartersData);
      window.__qbrNarratives = qbrNarratives;
      renderQBRNarratives(qbrNarratives);

      renderQBRYoY(quartersData);
      renderQBRMonthlyDetail(quartersData);
      renderQBRExecutiveSummary(quartersData, qbrNarratives);

      // Log QBR view event (fire-and-forget)
      logQBREvent('qbr_view', 'web');
    }

    /**
     * Log a QBR event to the server.
     */
    function logQBREvent(eventType, format) {
      const fs = window.__FILTER_STATE || {};
      const token = window.sisAuth?.getToken?.() || localStorage.getItem("sis_session_token") || "";
      const fiId = fs.fis && fs.fis.size === 1 ? Array.from(fs.fis)[0] : '';
      const fiName = fiId;
      const partner = fs.__partnerSetTouched && fs.partnerSet && fs.partnerSet.size === 1 ? Array.from(fs.partnerSet)[0] : '';
      const qd = window.__qbrQuartersData;
      const latest = qd && qd.length > 0 ? qd[qd.length - 1] : null;
      const earliest = qd && qd.length > 0 ? qd[0] : null;

      fetch("/api/qbr-log", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(token ? { Authorization: "Bearer " + token } : {}),
        },
        body: JSON.stringify({
          event_type: eventType,
          fi_id: fiId,
          fi_name: fiName,
          partner: partner,
          quarter: latest ? latest.quarter : '',
          trend_period: earliest && latest ? `${earliest.quarter} through ${latest.quarter}` : '',
          date_range_start: earliest ? earliest.startDate : '',
          date_range_end: latest ? latest.endDate : '',
          format: format,
          metrics_snapshot: qd ? {
            current_quarter: latest ? {
              quarter: latest.quarter,
              total_sessions: latest.metrics.totalSessions,
              session_success_rate: latest.metrics.sessionSuccessPct,
              placements: latest.metrics.successfulPlacements,
              monthly_reach: latest.metrics.monthlyReachPct,
              motivation_tier: latest.tierInfo ? latest.tierInfo.label : null,
            } : null,
            trailing_quarters: (qd.slice(0, -1) || []).map(q => ({
              quarter: q.quarter,
              session_success_rate: q.metrics.sessionSuccessPct,
              placements: q.metrics.successfulPlacements,
              total_sessions: q.metrics.totalSessions,
            })),
            trend_direction: EI.classifyTrend(qd.map(q => q.metrics.sessionSuccessPct)),
          } : null,
        }),
      }).catch(() => {});
    }

    // ‚îÄ‚îÄ Admin Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function renderAdminOverlay(ctx) {
      const admin = EI.getAdminInsights(ctx);

      // Talking points ‚Äî distributed into relevant section panels
      const funnelBody = document.getElementById('adminFunnelBody');
      const spectrumBody = document.getElementById('adminSpectrumBody');
      if (funnelBody) {
        const diagPoints = admin.talkingPoints.filter(p => p.category === 'diagnosis' || p.category === 'strategy');
        funnelBody.innerHTML = diagPoints.map(p =>
          `<div class="talking-point"><span class="tp-category">${p.category}</span>${p.html}<button class="copy-btn" onclick="copyText(this)" data-text="${escapeHtml(p.html.replace(/<[^>]+>/g, ''))}">Copy</button></div>`
        ).join('');
      }
      if (spectrumBody) {
        const actionPoints = admin.talkingPoints.filter(p => p.category === 'action');
        spectrumBody.innerHTML = actionPoints.map(p =>
          `<div class="talking-point"><span class="tp-category">${p.category}</span>${p.html}<button class="copy-btn" onclick="copyText(this)" data-text="${escapeHtml(p.html.replace(/<[^>]+>/g, ''))}">Copy</button></div>`
        ).join('');
      }

      // Objections
      const objectionsBody = document.getElementById('adminObjectionsBody');
      const objectionsSection = document.getElementById('adminObjectionsSection');
      if (objectionsBody && objectionsSection) {
        objectionsBody.innerHTML = admin.objections.map(o =>
          `<div class="objection-card">
            <div class="objection-q">${o.objection}</div>
            <div class="objection-a">${o.response}<button class="copy-btn" onclick="copyText(this)" data-text="${escapeHtml(o.response)}" style="margin-left:8px;">Copy</button></div>
          </div>`
        ).join('');
        objectionsSection.style.display = '';
      }

      // Benchmark references
      const refsBody = document.getElementById('adminBenchmarkRefsBody');
      const refsSection = document.getElementById('adminBenchmarkRefsSection');
      if (refsBody && refsSection) {
        refsBody.innerHTML = `<div class="ref-title">Named references (do not share with partner)</div>` +
          admin.benchmarkRefs.map(r => `<div>‚Ä¢ ${r}</div>`).join('');
        refsSection.style.display = '';
      }
    }

    /** Copy text from admin talking points */
    function copyText(btn) {
      const text = btn.getAttribute('data-text') || btn.previousSibling?.textContent || '';
      navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      }).catch(() => {});
    }

    // ‚îÄ‚îÄ‚îÄ Admin toggle setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function setupAdminToggle() {
      const bar = document.getElementById('adminToggleBar');
      if (!bar) return;
      bar.addEventListener('click', () => {
        document.body.classList.toggle('show-admin-overlay');
      });
    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function renderHighlights(highlights) {
      const valid = (highlights || []).filter(h => h && !h.empty);
      if (!valid.length) { highlightsSection.style.display = "none"; return; }
      highlightsSection.style.display = "";
      const rows = valid.map(h => {
        const dateRange = h.start === h.end ? h.start : `${h.start} ‚Üí ${h.end}`;
        const selSuccessPct = typeof h.selSuccessRatio === "number" ? (h.selSuccessRatio * 100).toFixed(1) + "%" : "‚Äî";
        const sessSuccessPct = typeof h.sessionSuccessRatio === "number" ? (h.sessionSuccessRatio * 100).toFixed(1) + "%" : "‚Äî";
        return `<tr>
          <td class="hl-label">${h.label || ""}</td>
          <td>${h.fi || ""}${h.instance ? ' <span class="muted">(' + h.instance + ')</span>' : ""}</td>
          <td>${h.integration || ""}</td>
          <td class="nowrap">${dateRange}</td>
          <td class="num">${fmt(h.sel)}</td>
          <td class="num">${fmt(h.sessions)}</td>
          <td class="num">${fmt(h.sess_with_success)}</td>
          <td class="num">${selSuccessPct}</td>
          <td class="num">${sessSuccessPct}</td>
          <td class="num">${fmt(h.placements)}</td>
        </tr>`;
      }).join("");
      bestWindowsDiv.innerHTML = `<table class="highlights-table">
        <thead><tr>
          <th>Highlight</th><th>FI</th><th>Integration</th><th>Window</th>
          <th class="num">Launches</th><th class="num">Visits</th><th class="num">Successful Cardholders</th>
          <th class="num">Success Rate</th><th class="num">Cardholder Success %</th><th class="num">Placements</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    // ‚îÄ‚îÄ‚îÄ Single-FI Time Breakdown Functions ‚îÄ‚îÄ‚îÄ

    function buildDailyRowsForFi(fiName, startDate, endDate, meta) {
      const norm = normalizeFiKey(fiName);
      const rows = [];
      const dates = Object.keys(dailyData).sort();
      for (const date of dates) {
        if (!inRange(date, startDate, endDate)) continue;
        const day = dailyData[date];
        if (!day?.fi) continue;
        let fiEntry = null;
        for (const [name, data] of Object.entries(day.fi)) {
          if (normalizeFiKey(name) === norm) { fiEntry = data; break; }
        }
        if (!fiEntry) continue;
        const ga = fiEntry.ga || {};
        const sessions = fiEntry.sessions || {};
        const placements = fiEntry.placements || {};
        let rowIntegration = meta.integration;
        if (meta.ssoDate && meta.integration === "SSO" && date < meta.ssoDate) {
          rowIntegration = "NON-SSO";
        }
        rows.push({
          periodLabel: date, start: date, end: date,
          ga_select: ga.select_merchants || 0, ga_user: ga.user_data_collection || 0,
          ga_cred: ga.credential_entry || 0, cs_select: sessions.cs_select_sessions || 0,
          cs_user: sessions.cs_user_sessions || 0, cs_cred: sessions.cs_cred_sessions || 0,
          sessions: sessions.total || 0,
          sess_with_success: sessions.with_success || 0,
          placements: getBillablePlacementCount(placements),
          fi: meta.fi, instance: meta.instance, instances: meta.instances,
          integration_type: rowIntegration, partner: meta.partner || "",
          cardholders: meta.cardholders, cardholder_source: meta.cardholder_source || null,
          cardholder_as_of: meta.cardholder_as_of || null, dayCount: 1,
        });
      }
      return rows;
    }

    function aggregateRowsForPeriod(rows, label, start, end, meta) {
      if (!rows.length) return null;
      const integrationTypes = new Set(rows.map(r => r.integration_type || meta.integration));
      let periodIntegration;
      if (integrationTypes.size === 1) {
        periodIntegration = integrationTypes.values().next().value;
      } else if (integrationTypes.has("SSO") && integrationTypes.has("NON-SSO")) {
        periodIntegration = "NON-SSO \u2192 SSO";
      } else {
        periodIntegration = meta.integration;
      }
      const agg = {
        periodLabel: label, start, end,
        ga_select: 0, ga_user: 0, ga_cred: 0, cs_select: 0, cs_user: 0, cs_cred: 0, sessions: 0,
        sess_with_success: 0, placements: 0,
        fi: meta.fi, instance: meta.instance, instances: meta.instances,
        integration_type: periodIntegration, partner: meta.partner || "",
        cardholders: meta.cardholders, cardholder_source: meta.cardholder_source || null,
        cardholder_as_of: meta.cardholder_as_of || null,
        dayCount: dayCountInclusive(start, end) || rows.length || 1,
      };
      for (const row of rows) {
        agg.ga_select += row.ga_select || 0;
        agg.ga_user += row.ga_user || 0;
        agg.ga_cred += row.ga_cred || 0;
        agg.cs_select += row.cs_select || 0;
        agg.cs_user += row.cs_user || 0;
        agg.cs_cred += row.cs_cred || 0;
        agg.sessions += row.sessions || 0;
        agg.sess_with_success += row.sess_with_success || 0;
        agg.placements += row.placements || 0;
      }
      return agg;
    }

    function buildWeeklyRowsForFi(dailyRows, startDate, endDate, meta) {
      const buckets = new Map();
      for (const row of dailyRows) {
        const date = parseDateUtc(row.start);
        const weekStartDate = addDaysUtc(date, -date.getUTCDay());
        const weekEndDate = addDaysUtc(weekStartDate, 6);
        const weekStart = formatDateUtc(weekStartDate);
        const weekEnd = formatDateUtc(weekEndDate);
        if (weekStart < startDate || weekEnd > endDate) continue;
        const key = weekStart;
        if (!buckets.has(key)) buckets.set(key, { start: weekStart, end: weekEnd, rows: [] });
        buckets.get(key).rows.push(row);
      }
      return Array.from(buckets.values())
        .sort((a, b) => a.start.localeCompare(b.start))
        .map(b => aggregateRowsForPeriod(b.rows, `${b.start} \u2192 ${b.end}`, b.start, b.end, meta))
        .filter(Boolean);
    }

    function buildMonthlyRowsForFi(dailyRows, startDate, endDate, meta) {
      const buckets = new Map();
      for (const row of dailyRows) {
        const monthKey = row.start.slice(0, 7);
        const [yearStr, monthStr] = monthKey.split("-");
        const year = Number(yearStr);
        const monthIndex = Number(monthStr) - 1;
        const monthStart = formatDateUtc(new Date(Date.UTC(year, monthIndex, 1)));
        const monthEnd = formatDateUtc(new Date(Date.UTC(year, monthIndex + 1, 0)));
        if (monthStart < startDate || monthEnd > endDate) continue;
        if (!buckets.has(monthKey)) buckets.set(monthKey, { start: monthStart, end: monthEnd, rows: [] });
        buckets.get(monthKey).rows.push(row);
      }
      return Array.from(buckets.values())
        .sort((a, b) => a.start.localeCompare(b.start))
        .map(b => aggregateRowsForPeriod(b.rows, `${b.start} \u2192 ${b.end}`, b.start, b.end, meta))
        .filter(Boolean);
    }

    function buildQuarterlyRowsForFi(dailyRows, startDate, endDate, meta) {
      const buckets = new Map();
      for (const row of dailyRows) {
        const date = parseDateUtc(row.start);
        const q = Math.floor(date.getUTCMonth() / 3) + 1;
        const year = date.getUTCFullYear();
        const key = `${year}-Q${q}`;
        const quarterStart = formatDateUtc(new Date(Date.UTC(year, (q - 1) * 3, 1)));
        const quarterEnd = formatDateUtc(new Date(Date.UTC(year, q * 3, 0)));
        if (quarterStart < startDate || quarterEnd > endDate) continue;
        if (!buckets.has(key)) buckets.set(key, { start: quarterStart, end: quarterEnd, label: `Q${q} ${year}`, rows: [] });
        buckets.get(key).rows.push(row);
      }
      return Array.from(buckets.values())
        .sort((a, b) => a.start.localeCompare(b.start))
        .map(b => aggregateRowsForPeriod(b.rows, b.label, b.start, b.end, meta))
        .filter(Boolean);
    }

    // ‚îÄ‚îÄ‚îÄ Single-FI Rendering ‚îÄ‚îÄ‚îÄ

    function renderSingleFiSections(visibleRows, startDate, endDate, daySpan) {
      singleFiView.innerHTML = "";
      if (!visibleRows || !visibleRows.length) {
        const div = document.createElement("div");
        div.className = "muted";
        div.textContent = "No data available for this FI.";
        singleFiView.appendChild(div);
        latestSingleFiBreakdowns = null;
        return;
      }

      const shared = window.__FILTER_STATE;
      const sharedFi = shared && shared.page === "funnel-customer" && shared.fis && shared.fis.size === 1
        ? Array.from(shared.fis)[0] : null;
      const fiName = sharedFi || (visibleRows[0]?.fi || "Unknown FI");
      const perFiRow = visibleRows[0] || {};
      const instanceDisplay = perFiRow.instance || (perFiRow.instances?.[0]) || "unknown";
      const registryInfo = getRegistryEntry(fiName, instanceDisplay);
      const meta = {
        fi: fiName, instance: instanceDisplay, instances: [instanceDisplay],
        integration: normalizeIntegrationLabel(
          perFiRow.integration_type || registryInfo?.integration || registryInfo?.integration_type || "UNKNOWN"
        ),
        partner: perFiRow.partner || registryInfo?.partner || "Unknown",
        cardholders: perFiRow.cardholders,
        cardholder_source: perFiRow.cardholder_source || null,
        cardholder_as_of: perFiRow.cardholder_as_of || null,
        ssoDate: registryInfo?.traffic_first_seen_sso || null,
      };

      const dailyRows = buildDailyRowsForFi(fiName, startDate, endDate, meta);
      const weeklyRows = buildWeeklyRowsForFi(dailyRows, startDate, endDate, meta);
      const monthlyRows = buildMonthlyRowsForFi(dailyRows, startDate, endDate, meta);
      const quarterlyRows = buildQuarterlyRowsForFi(dailyRows, startDate, endDate, meta);
      latestSingleFiBreakdowns = { summary: visibleRows, daily: dailyRows, weekly: weeklyRows, monthly: monthlyRows, quarterly: quarterlyRows };

      const sections = [];
      sections.push({ key: "summary", title: `Summary (${startDate} \u2192 ${endDate})`, rows: visibleRows });
      if (quarterlyRows.length) sections.push({ key: "quarterly", title: "Quarterly", rows: quarterlyRows });
      if (monthlyRows.length) sections.push({ key: "monthly", title: "Monthly (Full Calendar Months)", rows: monthlyRows });
      if (weeklyRows.length) sections.push({ key: "weekly", title: "Weekly (Sunday \u2192 Saturday)", rows: weeklyRows });
      if (dailyRows.length) sections.push({ key: "daily", title: "Daily", rows: dailyRows });

      const availableSections = sections.filter(s => s.rows && s.rows.length);
      if (!availableSections.length) {
        const div = document.createElement("div");
        div.className = "muted";
        div.textContent = "No full periods available for this FI within the selected dates.";
        singleFiView.appendChild(div);
        return;
      }

      const tabBar = document.createElement("div");
      tabBar.className = "tab-bar";
      const panelsWrap = document.createElement("div");

      availableSections.forEach((section, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `tab-button ${idx === 0 ? "active" : ""}`;
        btn.dataset.tab = section.key;
        btn.textContent = section.title;
        tabBar.appendChild(btn);

        const panel = document.createElement("div");
        panel.className = `tab-panel ${idx === 0 ? "active" : ""}`;
        panel.dataset.tab = section.key;
        const heading = document.createElement("h3");
        heading.textContent = section.title;
        panel.appendChild(heading);
        panel.appendChild(createSingleFiTable(section.rows, section.key, meta.integration === "SSO"));
        panelsWrap.appendChild(panel);
      });

      const activateTab = (key) => {
        lastActiveTab = key;
        tabBar.querySelectorAll(".tab-button").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.tab === key);
        });
        panelsWrap.querySelectorAll(".tab-panel").forEach(panel => {
          panel.classList.toggle("active", panel.dataset.tab === key);
        });
      };

      tabBar.addEventListener("click", (ev) => {
        const btn = ev.target.closest(".tab-button");
        if (!btn) return;
        activateTab(btn.dataset.tab);
      });

      singleFiView.appendChild(tabBar);
      singleFiView.appendChild(panelsWrap);

      const tabToActivate = (lastActiveTab && availableSections.some(s => s.key === lastActiveTab))
        ? lastActiveTab : availableSections[0].key;
      activateTab(tabToActivate);
    }

    function createSingleFiTable(rows, key, isSso) {
      const table = document.createElement("table");
      table.className = "fi-table";
      let headerHtml = `<thead><tr>
          <th data-sort="period">Period</th>
          <th data-sort="fi">Financial Institution</th>
          <th data-sort="instances">Instance</th>
          <th data-sort="integration">Integration</th>
          <th data-sort="ga_select" class="num">Launches</th>
          <th data-sort="cs_select" class="num">Visits @Select</th>`;
      if (!isSso) headerHtml += `<th data-sort="ga_user" class="num">User Data Views</th>`;
      headerHtml += `
          <th data-sort="ga_cred" class="num">Credential Views</th>
          <th data-sort="reach" class="num">Monthly Reach %</th>`;
      if (!isSso) headerHtml += `<th data-sort="sel_user_pct" class="num">Sel\u2192User %</th>`;
      headerHtml += `
          <th data-sort="sel_cred_pct" class="num">Sel\u2192Cred %</th>
          <th data-sort="sel_success_pct" class="num">Success Rate</th>
          <th data-sort="sessions" class="num">Visits</th>
          <th data-sort="sess_with_success" class="num">Successful Cardholders</th>
          <th data-sort="sess_success_pct" class="num">Cardholder Success %</th>
          <th data-sort="placements" class="num">Placements</th>
        </tr></thead>`;
      table.innerHTML = headerHtml;

      const tbody = document.createElement("tbody");
      const tableId = `single-${key.replace(/[^a-zA-Z0-9]/g, "_")}`;

      // Sort
      const state = tableSortState[tableId];
      let sorted = [...rows];
      if (state && state.key) {
        const dir = state.dir === "desc" ? -1 : 1;
        sorted.sort((a, b) => {
          const va = getSingleSortValue(a, state.key);
          const vb = getSingleSortValue(b, state.key);
          if (typeof va === "string") return dir * va.localeCompare(vb);
          return dir * (va - vb);
        });
      }

      sorted.forEach(row => tbody.appendChild(renderSingleFiRow(row, isSso)));
      table.appendChild(tbody);
      table.id = tableId;

      // Attach sort handlers
      table.querySelectorAll("th[data-sort]").forEach(th => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
          const sortKey = th.getAttribute("data-sort");
          const prev = tableSortState[tableId];
          if (prev && prev.key === sortKey) {
            tableSortState[tableId] = { key: sortKey, dir: prev.dir === "asc" ? "desc" : "asc" };
          } else {
            tableSortState[tableId] = { key: sortKey, dir: sortKey === "fi" || sortKey === "instances" || sortKey === "period" ? "asc" : "desc" };
          }
          // Re-render this table in place
          const newTbody = document.createElement("tbody");
          const reSorted = [...rows];
          const st = tableSortState[tableId];
          const d = st.dir === "desc" ? -1 : 1;
          reSorted.sort((a, b) => {
            const va = getSingleSortValue(a, st.key);
            const vb = getSingleSortValue(b, st.key);
            if (typeof va === "string") return d * va.localeCompare(vb);
            return d * (va - vb);
          });
          reSorted.forEach(r => newTbody.appendChild(renderSingleFiRow(r, isSso)));
          const oldTbody = table.querySelector("tbody");
          if (oldTbody) table.replaceChild(newTbody, oldTbody);
        });
      });

      const wrapper = document.createElement("div");
      wrapper.className = "table-scroll";
      wrapper.appendChild(table);
      return wrapper;
    }

    function getSingleSortValue(row, key) {
      switch (key) {
        case "period": return row.periodLabel || row.start || "";
        case "fi": return (row.fi || "").toLowerCase();
        case "instances": return (row.instance || "").toLowerCase();
        case "integration": return (row.integration_type || "").toLowerCase();
        case "ga_select": return row.ga_select || 0;
        case "cs_select": return row.cs_select || 0;
        case "ga_user": return row.ga_user || 0;
        case "ga_cred": return row.ga_cred || 0;
        case "reach": return getMonthlyReachValue(row);
        case "sel_user_pct": return row.cs_select ? (row.cs_user || 0) / row.cs_select : 0;
        case "sel_cred_pct": return row.cs_select ? (row.cs_cred || 0) / row.cs_select : 0;
        case "sel_success_pct": return row.cs_select && row.sess_with_success ? row.sess_with_success / row.cs_select : 0;
        case "sessions": return row.sessions || 0;
        case "sess_with_success": return row.sess_with_success || 0;
        case "sess_success_pct": return row.sessions ? (row.sess_with_success || 0) / row.sessions : 0;
        case "placements": return row.placements || 0;
        default: return 0;
      }
    }

    function renderSingleFiRow(row, isSso) {
      const tr = document.createElement("tr");
      const instancesText = row.instance || (Array.isArray(row.instances) ? row.instances.join(", ") : "");
      const selUserPct = row.cs_select ? ((row.cs_user / row.cs_select) * 100).toFixed(1) + "%" : "";
      const selCredPct = row.cs_select ? ((row.cs_cred / row.cs_select) * 100).toFixed(1) + "%" : "";
      const selSuccPct = formatSelSuccessPct(row);
      const reachPct = formatMonthlyReachPct(row);
      const reachVal = getMonthlyReachValue(row);
      const reachCls = reachVal >= 0.025 ? " reach-good" : reachVal > 0 ? " reach-low" : "";
      const sessSuccPct = formatSessSuccessPct(row);
      let cells = `
        <td>${row.periodLabel || ""}</td>
        <td>${row.fi || ""}</td>
        <td>${instancesText}</td>
        <td>${row.integration_type || ""}</td>
        <td class="num">${row.ga_select || 0}</td>
        <td class="num">${row.cs_select || 0}</td>`;
      if (!isSso) cells += `<td class="num">${row.ga_user || 0}</td>`;
      cells += `
        <td class="num">${row.ga_cred || 0}</td>
        <td class="num${reachCls}">${reachPct}</td>`;
      if (!isSso) cells += `<td class="num">${selUserPct}</td>`;
      cells += `
        <td class="num">${selCredPct}</td>
        <td class="num">${selSuccPct}</td>
        <td class="num">${row.sessions || 0}</td>
        <td class="num">${row.sess_with_success || 0}</td>
        <td class="num">${sessSuccPct}</td>
        <td class="num">${row.placements || 0}</td>`;
      tr.innerHTML = cells;
      return tr;
    }

    function renderPartnerSummary(summaryData) {
      if (!partnerSummaryBox) return;
      if (!summaryData) { partnerSummaryBox.style.display = "none"; partnerSummaryBox.innerHTML = ""; return; }
      const pctStr = (v) => typeof v === "number" && Number.isFinite(v) ? v.toFixed(1) + "%" : "‚Äî";
      const rows = summaryData.rows.map(r => `<tr>
        <td>${r.integration}</td><td class="num">${r.fiCount}</td><td class="num ga-col">${fmt(r.ga_select)}</td>
        <td class="num">${pctStr(r.selSuccessPct)}</td><td class="num">${fmt(r.sessions)}</td>
        <td class="num">${fmt(r.sess_with_success)}</td><td class="num">${pctStr(r.sessionSuccessPct)}</td>
      </tr>`).join("");
      const t = summaryData.totals || {};
      const totalRow = `<tr class="total-row">
        <td><strong>Total</strong></td><td class="num"><strong>${t.fiCount || ""}</strong></td>
        <td class="num ga-col"><strong>${fmt(t.ga_select)}</strong></td><td class="num"><strong>${pctStr(t.selSuccessPct)}</strong></td>
        <td class="num"><strong>${fmt(t.sessions)}</strong></td><td class="num"><strong>${fmt(t.sess_with_success)}</strong></td>
        <td class="num"><strong>${pctStr(t.sessionSuccessPct)}</strong></td>
      </tr>`;
      partnerSummaryBox.innerHTML = `
        <div class="perf-section-title">${summaryData.partner || "Partner"} Integration Mix <span class="muted">${summaryData.rows.length} integration types</span></div>
        <table><thead><tr>
          <th>Integration</th><th class="num">FIs</th><th class="num ga-col">GA Select</th>
          <th class="num">Success Rate</th><th class="num">Visits</th>
          <th class="num">Successful Cardholders</th><th class="num">Cardholder Success %</th>
        </tr></thead><tbody>${rows}${totalRow}</tbody></table>`;
      partnerSummaryBox.style.display = "";
    }

    // ‚îÄ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ
    function csvEscape(value) {
      if (value === null || value === undefined) return "";
      const str = String(value);
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
      return str;
    }

    function buildCustomerCsv(visibleRows, highlights, partnerSummary, startDate, endDate) {
      const lines = [];
      const title = `Cardholder Engagement Report ${startDate || ""} ‚Üí ${endDate || ""}`.trim();
      lines.push(`"${title}"`, "", "");

      // Highlights
      const validH = (highlights || []).filter(h => h && !h.empty);
      if (validH.length) {
        lines.push("Performance Highlights");
        lines.push(["Highlight","FI","Integration","Window Start","Window End","GA Select","Visits","Successful Cardholders","Success Rate","Cardholder Success %","Placements"].map(csvEscape).join(","));
        validH.forEach(h => {
          const selSuccPct = typeof h.selSuccessRatio === "number" ? (h.selSuccessRatio * 100).toFixed(1) + "%" : "";
          const sessSuccPct = typeof h.sessionSuccessRatio === "number" ? (h.sessionSuccessRatio * 100).toFixed(1) + "%" : "";
          lines.push([h.label, h.fi, h.integration, h.start, h.end, h.sel || 0, h.sessions || 0, h.sess_with_success || 0, selSuccPct, sessSuccPct, h.placements || 0].map(csvEscape).join(","));
        });
        lines.push("", "");
      }

      // Summary by FI
      if (visibleRows.length) {
        const header = ["FI","Partner","Integration","Instance","GA Select","Visits @Select","GA User","GA Cred","Monthly Reach %","Select‚ÜíUser %","Select‚ÜíCred %","Success Rate","Visits","Successful Cardholders","Cardholder Success %","Placements"];
        lines.push("Summary by FI");
        lines.push(header.map(csvEscape).join(","));
        visibleRows.forEach(row => {
          const reachPct = formatMonthlyReachPct(row);
          const selUserPct = row.cs_select ? (((row.cs_user || 0) / row.cs_select) * 100).toFixed(1) + "%" : "";
          const selCredPct = row.cs_select ? (((row.cs_cred || 0) / row.cs_select) * 100).toFixed(1) + "%" : "";
          const selSuccPct = row.cs_select && row.sess_with_success ? ((row.sess_with_success / row.cs_select) * 100).toFixed(1) + "%" : "";
          const sessSuccPct = row.sessions && row.sess_with_success ? ((row.sess_with_success / row.sessions) * 100).toFixed(1) + "%" : "";
          lines.push([
            row.fi, row.partner, row.integration_type, row.instance,
            row.ga_select || 0, row.cs_select || 0, row.ga_user || 0, row.ga_cred || 0,
            reachPct, selUserPct, selCredPct, selSuccPct,
            row.sessions || 0, row.sess_with_success || 0, sessSuccPct,
            row.placements || 0,
          ].map(csvEscape).join(","));
        });
        lines.push("", "");
      }

      // Partner mix
      if (partnerSummary && partnerSummary.rows && partnerSummary.rows.length) {
        const pctStr = (v) => typeof v === "number" && Number.isFinite(v) ? v.toFixed(1) + "%" : "";
        lines.push(`${partnerSummary.partner} Integration Mix`);
        lines.push(["Integration","FIs","GA Select","Success Rate","Visits","Successful Cardholders","Cardholder Success %"].map(csvEscape).join(","));
        partnerSummary.rows.forEach(r => {
          lines.push([r.integration, r.fiCount, r.ga_select, pctStr(r.selSuccessPct), r.sessions, r.sess_with_success, pctStr(r.sessionSuccessPct)].map(csvEscape).join(","));
        });
        const t = partnerSummary.totals || {};
        lines.push([t.integration || "Total", t.fiCount || 0, t.ga_select || 0, pctStr(t.selSuccessPct), t.sessions || 0, t.sess_with_success || 0, pctStr(t.sessionSuccessPct)].map(csvEscape).join(","));
      }

      return lines.join("\n");
    }

    function downloadCsv(filename, contents) {
      const blob = new Blob([contents], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }

    // ‚îÄ‚îÄ‚îÄ Apply filters ‚îÄ‚îÄ‚îÄ
    async function applyFilters() {
      await nextFrame();
      const startDate = startDateInput.value || defaultStartDateStr;
      const endDate = endDateInput.value || defaultEndDateStr;
      const startDt = new Date(`${startDate}T00:00:00Z`);
      const endDt = new Date(`${endDate}T00:00:00Z`);
      const daySpan = Math.max(1, Math.floor((endDt - startDt) / (1000 * 60 * 60 * 24)) + 1);
      const cardholderMap = getCardholderMap();
      const perFi = aggregateData(startDate, endDate, cardholderMap);
      lastAggregated = perFi;
      const visibleRows = getVisibleRows(perFi);
      latestVisibleRows = visibleRows;
      const singleFiMode = isSingleFiSelected();
      const best = computeBestWindows(startDate, endDate, perFi, visibleRows, 30 / daySpan, { allowLowVolume: singleFiMode });
      latestHighlights = best;

      // Metrics
      const metrics = calculateMetrics(startDate, endDate, visibleRows);
      renderMetrics(metrics, startDate, endDate, daySpan, visibleRows.length, visibleRows);

      // Stamp rows with date context for Monthly Reach % calculation
      visibleRows.forEach(row => {
        row.periodStart = startDate;
        row.periodEnd = endDate;
        row.dayCount = row.dayCount || daySpan;
      });

      // Per-FI tables
      renderTables(visibleRows, startDate, endDate, daySpan);

      // Highlights
      renderHighlights(best);

      // Partner summary
      const shared = window.__FILTER_STATE;
      let partnerValue = PARTNER_ALL_VALUE;
      if (shared && shared.page === "funnel-customer" && shared.__partnerSetTouched && shared.partnerSet && shared.partnerSet.size === 1) {
        partnerValue = Array.from(shared.partnerSet)[0];
      }
      const partnerSummary = buildPartnerSummaryData(visibleRows, daySpan, partnerValue);
      latestPartnerSummary = partnerSummary;
      renderPartnerSummary(partnerSummary);

      lastRenderContext = { perFi, startDate, endDate, daySpan, best, metrics };

      // Engagement Insights ‚Äî render narrative, spectrum, actions, projections
      try {
        renderInsights(metrics, startDate, endDate, daySpan, visibleRows, best);
      } catch (err) { console.error('[insights] render error:', err); }

      const snapshot = shared && shared.page === "funnel-customer";
      lastFilterSnapshot = {
        fis: snapshot && shared.fis ? Array.from(shared.fis).sort().join(',') : '',
        partner: snapshot ? (shared.partner || '') : '',
      };
    }

    async function safeApplyFilters() {
      ensureDateDefaults();
      enforceEndDateBounds();
      renderDateWarning();
      await applyFilters();
    }

    function rerenderFromCache() {
      if (!lastRenderContext) return;
      const shared = window.__FILTER_STATE;
      const snapshot = shared && shared.page === "funnel-customer";
      const current = {
        fis: snapshot && shared.fis ? Array.from(shared.fis).sort().join(',') : '',
        partner: snapshot ? (shared.partner || '') : '',
      };
      const changed = !lastFilterSnapshot || lastFilterSnapshot.fis !== current.fis || lastFilterSnapshot.partner !== current.partner;
      if (changed) {
        startLoading("Loading data‚Ä¶");
        applyFilters().finally(() => stopLoading());
        return;
      }
    }

    // ‚îÄ‚îÄ‚îÄ View mode ‚îÄ‚îÄ‚îÄ
    const __viewParams = new URLSearchParams(window.location.search);
    const __isViewMode = __viewParams.get("view") === "1";

    if (__isViewMode) {
      window.__sisViewMode = true;
      document.body.classList.add('share-presentation-mode');

      // Track view
      const __viewSid = __viewParams.get("sid");
      if (__viewSid) {
        try { fetch("/api/share-log/view?sid=" + encodeURIComponent(__viewSid)).catch(function() {}); } catch (e) {}
      }

      // Activate QBR mode if share link was generated in QBR mode
      if (__viewParams.get("mode") === "qbr") {
        document.body.classList.add('qbr-mode');
      }

      // Set dates from URL params
      const vpFrom = __viewParams.get("from");
      const vpTo = __viewParams.get("to");
      if (startDateInput) startDateInput.value = vpFrom || defaultStartDateStr;
      if (endDateInput) endDateInput.value = vpTo || defaultEndDateStr;

      // Hide all filter controls
      const filterBarEl = document.getElementById("filter-bar");
      if (filterBarEl) filterBarEl.style.display = "none";
      const funelHeader = document.querySelector(".funnel-header");
      if (funelHeader) funelHeader.style.display = "none";

      // Hide action buttons except Export PDF
      if (applyBtn) applyBtn.style.display = "none";
      if (exportCsvBtn) exportCsvBtn.style.display = "none";
      const shareLinkBtn2 = document.getElementById("shareLinkBtn");
      if (shareLinkBtn2) shareLinkBtn2.style.display = "none";
      const adminPdfBtnView = document.getElementById("exportPdfAdminBtn");
      if (adminPdfBtnView) adminPdfBtnView.style.display = "none";

      // KEEP Export PDF visible for shared views
      const exportPdfBtnView = document.getElementById("exportPdfBtn");
      if (exportPdfBtnView) exportPdfBtnView.style.display = "";

      // Inject branded presentation header
      const isQBRShare = __viewParams.get("mode") === "qbr";
      const fiNameShare = __viewParams.get("fi") || '';
      const partnerShare = __viewParams.get("partner") || '';
      const daysCount = vpFrom && vpTo ? dayCountInclusive(vpFrom, vpTo) : null;

      const presHeader = document.createElement("div");
      presHeader.className = "presentation-header";
      presHeader.innerHTML = `
        <div class="pres-brand">
          <span class="pres-brand-text">Strivve CardUpdatr\u2122</span>
        </div>
        <div class="pres-title">${isQBRShare ? 'Quarterly Business Review' : 'Cardholder Engagement Report'}</div>
        ${fiNameShare ? `<div class="pres-fi">${fiNameShare}</div>` : ''}
        ${partnerShare ? `<div class="pres-partner">${partnerShare}</div>` : ''}
        <div class="pres-dates">
          ${vpFrom || ''} \u2014 ${vpTo || ''}${daysCount ? ` (${daysCount} Days)` : ''}
        </div>
        <div class="pres-prepared">Prepared by Strivve CardUpdatr\u2122 Platform</div>
        <div style="margin-top:10px;">
          <button id="exportPdfBtnPres" class="form-button" style="font-size:0.85rem;padding:8px 20px;min-width:auto;">Export PDF</button>
        </div>
      `;

      const sisContent = document.querySelector(".sis-content") || document.querySelector(".sis-panel");
      if (sisContent) sisContent.insertBefore(presHeader, sisContent.firstChild);

      // Wire the presentation Export PDF button to same handler
      const presPdfBtn = document.getElementById("exportPdfBtnPres");
      if (presPdfBtn && exportPdfBtnView) {
        presPdfBtn.addEventListener("click", () => exportPdfBtnView.click());
      }

      // Inject clean footer
      const presFooter = document.createElement("div");
      presFooter.className = "presentation-footer";
      presFooter.innerHTML = `Generated by Strivve CardUpdatr\u2122 Platform | <a href="https://strivve.com" target="_blank" rel="noopener">strivve.com</a>`;
      if (sisContent) sisContent.appendChild(presFooter);

    } else {
      // Check for date params from redirect
      const urlFrom = __viewParams.get("from");
      const urlTo = __viewParams.get("to");
      if (urlFrom && urlTo) {
        if (startDateInput) startDateInput.value = urlFrom;
        if (endDateInput) endDateInput.value = urlTo;
        const presetEl = document.getElementById("datePreset");
        if (presetEl) presetEl.value = "";
      } else {
        if (startDateInput && !startDateInput.value) startDateInput.value = defaultStartDateStr;
        if (endDateInput && !endDateInput.value) endDateInput.value = defaultEndDateStr;
        const presetEl = document.getElementById("datePreset");
        if (presetEl) presetEl.value = "last7";
      }
      // Share button
      const shareLinkBtn = document.getElementById("shareLinkBtn");
      if (shareLinkBtn) {
        shareLinkBtn.style.display = "";
        shareLinkBtn.addEventListener("click", function() {
          const fs = window.__FILTER_STATE || {};
          const params = new URLSearchParams();
          params.set("view", "1");
          const sidBytes = new Uint8Array(4);
          crypto.getRandomValues(sidBytes);
          const sid = Array.from(sidBytes).map(b => b.toString(16).padStart(2, "0")).join("");
          params.set("sid", sid);
          if (startDateInput && startDateInput.value) params.set("from", startDateInput.value);
          if (endDateInput && endDateInput.value) params.set("to", endDateInput.value);
          if (fs.fis && fs.fis.size > 0) {
            const fiArr = Array.from(fs.fis);
            if (fiArr.length === 1) params.set("fi", fiArr[0]);
          }
          if (fs.__partnerSetTouched && fs.partnerSet && fs.partnerSet.size > 0) {
            const arr = Array.from(fs.partnerSet);
            if (arr.length === 1) params.set("partner", arr[0]);
          }
          // Preserve QBR mode in share link
          if (document.body.classList.contains("qbr-mode")) {
            params.set("mode", "qbr");
          }
          const shareUrl = window.location.origin + window.location.pathname + "?" + params.toString();
          navigator.clipboard.writeText(shareUrl).then(function() {
            shareLinkBtn.textContent = "Copied!";
            setTimeout(function() { shareLinkBtn.textContent = "Share"; }, 2000);
          }).catch(function() { prompt("Copy this link:", shareUrl); });
          try { fetch("/api/share-log", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sid, url: shareUrl }) }).catch(function() {}); } catch (e) {}
        });
      }
    }

    // Toggle merchant detail on card click
    document.getElementById("cardSuccessful")?.addEventListener("click", (e) => {
      const detailEl = document.getElementById("merchantDetail");
      if (!detailEl || !merchantPopoverReady) return;
      e.stopPropagation();
      detailEl.classList.toggle("open");
    });
    // Close merchant popover when clicking outside
    document.addEventListener("click", (e) => {
      const detailEl = document.getElementById("merchantDetail");
      const card = document.getElementById("cardSuccessful");
      if (detailEl?.classList.contains("open") && card && !card.contains(e.target) && !detailEl.contains(e.target)) {
        detailEl.classList.remove("open");
      }
    });

    // ‚îÄ‚îÄ GA data toggle ‚îÄ‚îÄ
    const gaToggle = document.getElementById("gaToggle");
    if (gaToggle) {
      gaToggle.addEventListener("change", () => {
        document.body.classList.toggle("hide-ga", !gaToggle.checked);
        // Re-render funnel viz with updated stage pipeline
        if (insightsCtx) renderFunnelViz(insightsCtx);
      });
    }

    // ‚îÄ‚îÄ Distribution panel toggles (close others when one opens) ‚îÄ‚îÄ
    const distPanels = [
      { btnId: "toggleDistribution", panelId: "distributionPanel", cardId: "cardMerchantsPerSession" },
      { btnId: "csSelectToggleDist", panelId: "csSelectDistPanel", cardId: "cardCsSelectDist" },
      { btnId: "csUserToggleDist", panelId: "csUserDistPanel", cardId: "cardCsUserDist" },
      { btnId: "csCredToggleDist", panelId: "csCredDistPanel", cardId: "cardCsCredDist" },
    ];
    function closeAllDistPanels(exceptPanelId) {
      for (const d of distPanels) {
        if (d.panelId === exceptPanelId) continue;
        const p = document.getElementById(d.panelId);
        const b = document.getElementById(d.btnId);
        if (p) p.classList.remove("open");
        if (b) b.setAttribute("aria-expanded", "false");
      }
    }
    for (const d of distPanels) {
      const btn = document.getElementById(d.btnId);
      const panel = document.getElementById(d.panelId);
      if (btn && panel) {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = panel.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(isOpen));
          if (isOpen) closeAllDistPanels(d.panelId);
        });
      }
    }
    // Close any open distribution panel when clicking outside
    document.addEventListener("click", (e) => {
      for (const d of distPanels) {
        const panel = document.getElementById(d.panelId);
        const card = document.getElementById(d.cardId);
        if (panel?.classList.contains("open") && card && !card.contains(e.target)) {
          panel.classList.remove("open");
          const btn = document.getElementById(d.btnId);
          if (btn) btn.setAttribute("aria-expanded", "false");
        }
      }
    });

    // ‚îÄ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ
    applyBtn.addEventListener("click", () => {
      lastRenderContext = null;
      lastFilterSnapshot = null;
      startLoading("Loading data‚Ä¶");
      safeApplyFilters().catch(err => console.error("apply failed", err)).finally(() => stopLoading());
    });

    endDateInput?.addEventListener("change", () => {
      const presetEl = document.getElementById("datePreset");
      if (presetEl) presetEl.value = "";
      renderDateWarning();
    });
    startDateInput?.addEventListener("change", () => {
      const presetEl = document.getElementById("datePreset");
      if (presetEl) presetEl.value = "";
      renderDateWarning();
    });

    exportCsvBtn.addEventListener("click", () => {
      const csv = buildCustomerCsv(
        latestVisibleRows, latestHighlights, latestPartnerSummary,
        lastRenderContext?.startDate || startDateInput.value,
        lastRenderContext?.endDate || endDateInput.value,
      );
      const start = (startDateInput.value || "start").replace(/[^0-9-]/g, "");
      const end = (endDateInput.value || "end").replace(/[^0-9-]/g, "");
      downloadCsv(`cardholder-engagement-${start}-to-${end}.csv`, csv);
    });

    document.getElementById("exportPdfBtn")?.addEventListener("click", async () => {
      const btn = document.getElementById("exportPdfBtn");
      const origText = btn.textContent;
      btn.textContent = "Generating‚Ä¶"; btn.disabled = true;
      try {
        const startDate = startDateInput.value || defaultStartDateStr;
        const endDate = endDateInput.value || defaultEndDateStr;
        const visibleRows = latestVisibleRows || [];
        const metrics = calculateMetrics(startDate, endDate, visibleRows);
        const parts = [];
        const fs = window.__FILTER_STATE || {};
        if (fs.__partnerSetTouched && fs.partnerSet && fs.partnerSet.size > 0) parts.push("Partner: " + Array.from(fs.partnerSet).join(", "));
        if (fs.__fiTouched && fs.fis && fs.fis.size > 0 && fs.fis.size <= 3) parts.push("FI: " + Array.from(fs.fis).join(", "));
        const filterContext = parts.length ? parts.join(" | ") : `All data (${visibleRows.length} FIs)`;

        // Generate share URL for the PDF link ‚Äî include all active filters
        const shareParams = new URLSearchParams();
        shareParams.set("view", "1");
        const sidBytes = new Uint8Array(4);
        crypto.getRandomValues(sidBytes);
        const pdfSid = Array.from(sidBytes).map(b => b.toString(16).padStart(2, "0")).join("");
        shareParams.set("sid", pdfSid);
        if (startDate) shareParams.set("from", startDate);
        if (endDate) shareParams.set("to", endDate);
        if (fs.fis && fs.fis.size > 0) {
          shareParams.set("fi", Array.from(fs.fis).join(","));
        }
        if (fs.partnerSet && fs.partnerSet.size > 0) {
          shareParams.set("partner", Array.from(fs.partnerSet).join(","));
        }
        if (fs.instanceSet && fs.instanceSet.size > 0) {
          shareParams.set("instance", Array.from(fs.instanceSet).join(","));
        }
        if (fs.integrationSet && fs.integrationSet.size > 0) {
          shareParams.set("integration", Array.from(fs.integrationSet).join(","));
        }
        const shareUrl = window.location.origin + window.location.pathname + "?" + shareParams.toString();
        try { fetch("/api/share-log", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sid: pdfSid, url: shareUrl }) }).catch(() => {}); } catch (e) {}

        // Build insights payload for PDF
        let insightsPayload = null;
        if (insightsCtx && EI) {
          try {
            const ctx = insightsCtx;
            const narrativeResults = EI.evaluateNarratives(ctx);
            const spectrumDiag = EI.buildSpectrumDiagnosis(ctx);
            const { actions } = EI.evaluateActions(ctx);
            const projections = EI.computeProjections(ctx);

            const pdfGaHidden = document.body.classList.contains('hide-ga');
            const pdfFunnelStages = pdfGaHidden ? [
              { label: 'Visits', value: ctx.totalSessions, color: '#fff7ed', borderColor: '#fdba74', textColor: '#9a3412' },
              { label: 'Credential Entry', value: ctx.credSessions || ctx.gaCred, color: '#fef3c7', borderColor: '#fcd34d', textColor: '#92400e' },
              { label: 'Successful Cardholders', value: ctx.sessionsWithSuccess, color: '#dbeafe', borderColor: '#93c5fd', textColor: '#1e40af' },
              { label: 'Placements', value: ctx.successfulPlacements, color: '#dcfce7', borderColor: '#86efac', textColor: '#166534' },
            ] : [
              { label: 'Launches', value: ctx.gaSelect, color: '#ede9fe', borderColor: '#c4b5fd', textColor: '#5b21b6' },
              { label: 'Visits', value: ctx.totalSessions, color: '#fff7ed', borderColor: '#fdba74', textColor: '#9a3412' },
              { label: 'Credential Entry', value: ctx.credSessions || ctx.gaCred, color: '#fef3c7', borderColor: '#fcd34d', textColor: '#92400e' },
              { label: 'Successful Cardholders', value: ctx.sessionsWithSuccess, color: '#dbeafe', borderColor: '#93c5fd', textColor: '#1e40af' },
              { label: 'Placements', value: ctx.successfulPlacements, color: '#dcfce7', borderColor: '#86efac', textColor: '#166534' },
            ];
            insightsPayload = {
              funnel: pdfFunnelStages,
              narratives: narrativeResults.map(n => ({
                sectionLabel: getSectionLabel(n.section),
                html: n.html,
                benchmarks: EI.getBenchmarkDisplay(n.benchmarkKeys),
              })),
              spectrum: {
                currentRate: ctx.sessionSuccessPct,
                bestRate: ctx.bestWeekRate,
                diagnosisHtml: spectrumDiag.html,
              },
              actions: actions,
              libraryMeta: (EI.ACTION_LIBRARY && EI.ACTION_LIBRARY._meta) || {},
              projection: projections,
            };
            // Add QBR data if in QBR mode
            if (document.body.classList.contains('qbr-mode') && window.__qbrQuartersData) {
            const qd = window.__qbrQuartersData;
            insightsPayload.qbr = {
              quarters: qd.map(q => ({
                quarter: q.quarter,
                startDate: q.startDate,
                endDate: q.endDate,
                metrics: {
                  totalSessions: q.metrics.totalSessions,
                  sessionsWithSuccess: q.metrics.sessionsWithSuccess,
                  successfulPlacements: q.metrics.successfulPlacements,
                  sessionSuccessPct: q.metrics.sessionSuccessPct,
                  gaSelect: q.metrics.gaSelect,
                  monthlyReachPct: q.metrics.monthlyReachPct,
                  avgCardsPerSession: q.metrics.avgCardsPerSession,
                  selCredPct: q.metrics.selCredPct,
                },
                tierLabel: q.tierInfo ? q.tierInfo.label : null,
              })),
              narratives: (window.__qbrNarratives || []).map(n => ({
                id: n.id, section: n.section, html: n.html,
              })),
              sparklines: {
                sessions: buildSparklineSVG(qd.map(q => q.metrics.totalSessions), { color: '#f59e0b' }),
                successRate: buildSparklineSVG(qd.map(q => q.metrics.sessionSuccessPct || 0), { color: '#2563eb' }),
                placements: buildSparklineSVG(qd.map(q => q.metrics.successfulPlacements), { color: '#16a34a' }),
              },
              summary: document.getElementById('qbrSummaryContent')?.innerHTML || '',
              isAdmin: !!window.__pdfIncludeAdmin,
            };
            // Include admin insights if requested
            if (window.__pdfIncludeAdmin && insightsCtx && EI) {
              const adminData = EI.getAdminInsights(insightsCtx);
              insightsPayload.qbr.adminInsights = {
                talkingPoints: adminData.talkingPoints || [],
                objections: adminData.objections || [],
                benchmarkRefs: adminData.benchmarkRefs || [],
              };
            }
            }
          } catch (e) { console.warn('[pdf] insights build error:', e); }
        }

        const payload = {
          startDate, endDate, filterContext, shareUrl,
          metrics: {
            totalGaSelect: metrics.totalGaSelect, totalGaUser: metrics.totalGaUser, totalGaCred: metrics.totalGaCred,
            totalCsSelect: metrics.totalCsSelect, totalCsUser: metrics.totalCsUser, totalCsCred: metrics.totalCsCred,
            totalSessions: metrics.totalSessions, sessionsWithSuccessfulJobs: metrics.sessionsWithSuccessfulJobs,
            successful: metrics.successful,
          },
          highlights: (latestHighlights || []).map(h => ({
            label: h.label, fi: h.fi, instance: h.instance, integration: h.integration,
            start: h.start, end: h.end, sel: h.sel, sessions: h.sessions,
            sess_with_success: h.sess_with_success, placements: h.placements,
            selSuccessRatio: h.selSuccessRatio, sessionSuccessRatio: h.sessionSuccessRatio, empty: h.empty,
          })),
          partnerSummary: latestPartnerSummary || null,
          insights: insightsPayload,
        };
        const token = window.sisAuth?.getToken?.() || localStorage.getItem("sis_session_token") || "";
        const resp = await fetch("/api/export-pdf-customer", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...(token ? { Authorization: "Bearer " + token } : {}) },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: "Unknown error" }));
          throw new Error(err.error || `HTTP ${resp.status}`);
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const isQBR = document.body.classList.contains('qbr-mode');
        a.href = url; a.download = `${isQBR ? 'qbr' : 'cardholder-engagement'}-${startDate}-to-${endDate}.pdf`;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 0);
        // Log QBR PDF export event
        if (isQBR) {
          logQBREvent(window.__pdfIncludeAdmin ? 'qbr_pdf_admin' : 'qbr_pdf', 'pdf');
        }
      } catch (err) {
        console.error("[pdf] Export failed:", err);
        alert("PDF export failed: " + err.message);
      } finally {
        btn.textContent = origText; btn.disabled = false;
      }
    });

    // ‚îÄ‚îÄ‚îÄ Admin PDF Export (with internal notes) ‚îÄ‚îÄ‚îÄ
    document.getElementById("exportPdfAdminBtn")?.addEventListener("click", () => {
      // Set admin flag and trigger the normal PDF export
      window.__pdfIncludeAdmin = true;
      document.getElementById("exportPdfBtn")?.click();
      // Reset after a tick (the export handler reads it synchronously)
      setTimeout(() => { window.__pdfIncludeAdmin = false; }, 100);
    });

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
    async function init() {
      try {
        startLoading("Loading engagement data‚Ä¶");
        try {
          registryMap = await fetchRegistry();
          updateRegistryLookups(registryMap);
        } catch (err) { console.error("Failed to load registry:", err); registryMap = {}; }

        try {
          const fetched = await fetchDailyList();
          dailyFiles = Array.isArray(fetched) ? fetched : [];
          if (dailyFiles.length) {
            const sortedDates = dailyFiles.map(f => f.replace(".json", "")).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
            earliestDailyDate = sortedDates[0] || null;
            latestDailyDate = sortedDates[sortedDates.length - 1] || null;
            const baseIso = getMaxSelectableDateIso();
            if (endDateInput && (!endDateInput.value || endDateInput.value > baseIso)) endDateInput.value = baseIso;
            if (startDateInput && startDateInput.value > (endDateInput?.value || baseIso)) startDateInput.value = endDateInput.value || baseIso;
            renderDateWarning();
          }
          // Bulk cache
          const dataVersion = window.DataCache?.currentVersion || 'unknown';
          const bulkCacheKey = `funnel_all_daily_data_v${dataVersion}`;
          if (window.DataCache) {
            const cachedBulk = await window.DataCache.getAsync(bulkCacheKey);
            if (cachedBulk && typeof cachedBulk === 'object' && Object.keys(cachedBulk).length > 0) {
              setLoaderMessage('Loading from cache‚Ä¶');
              dailyData = cachedBulk;
            } else {
              const totalDays = dailyFiles.length;
              let loadedDays = 0;
              if (earliestDailyDate && latestDailyDate) {
                setLoaderMessage(`Loading daily data‚Ä¶ ${loadedDays}/${totalDays}`);
                const rangeEntries = await fetchDailyRange(earliestDailyDate, latestDailyDate);
                if (rangeEntries && typeof rangeEntries === "object") { dailyData = rangeEntries; loadedDays = Object.keys(dailyData).length; }
              }
              if (loadedDays === 0) {
                for (const file of dailyFiles) {
                  const date = file.replace(".json", "");
                  setLoaderMessage(`Loading daily data‚Ä¶ ${loadedDays}/${totalDays}`);
                  const data = await fetchDaily(date);
                  if (data) dailyData[date] = data;
                  loadedDays += 1;
                }
              }
              if (Object.keys(dailyData).length > 0) {
                window.DataCache.set(bulkCacheKey, dailyData).catch(() => {});
              }
            }
          } else {
            const totalDays = dailyFiles.length;
            let loadedDays = 0;
            for (const file of dailyFiles) {
              const date = file.replace(".json", "");
              setLoaderMessage(`Loading daily data‚Ä¶ ${loadedDays}/${totalDays}`);
              const data = await fetchDaily(date);
              if (data) dailyData[date] = data;
              loadedDays += 1;
            }
          }
        } catch (err) { console.error("Failed to load daily data:", err); }

        await safeApplyFilters();
      } catch (err) {
        console.error("Init failed", err);
        stopLoading();
      } finally {
        stopLoading();
      }
    }

    init().catch(err => { console.error("Init failed", err); stopLoading(); });

    const presetSelect = document.getElementById("datePreset");
    if (presetSelect) {
      presetSelect.addEventListener("change", () => {
        const val = presetSelect.value;
        document.body.classList.toggle("qbr-mode", val === "qbr");
        // Show/hide admin export button for QBR mode
        const adminPdfBtn = document.getElementById("exportPdfAdminBtn");
        if (adminPdfBtn) adminPdfBtn.style.display = (val === "qbr" && isAdminUser()) ? "" : "none";
        if (val) { applyPresetRange(val); safeApplyFilters(); }
      });
    }

    applyDefaultDateRange(false);

    // Initialize filters
    (function ensureFilters(pageId){
      const run = () => { if (window.initFilters) window.initFilters(pageId); };
      if (window.initFilters) return run();
      const candidates = ["./assets/js/filters.js?v=shared-fallback", "/assets/js/filters.js?v=shared-fallback"];
      const loadNext = (idx) => {
        if (idx >= candidates.length) return;
        const s = document.createElement("script");
        s.src = candidates[idx] + "&ts=" + Date.now();
        s.onload = () => run();
        s.onerror = () => loadNext(idx + 1);
        document.head.appendChild(s);
      };
      loadNext(0);
    })("funnel-customer");
  </script>
</body>
</html>
